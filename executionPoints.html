<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/assets/css/style.css">
  <!--<link rel="icon" type="image/png" href="/assets/civfanatics_icon.png">-->
<script>
    document.addEventListener("DOMContentLoaded", () => {
        let z = document.body.getElementsByTagName("include")
        for (let i = 0; i < z.length; ++i) {
            let elmnt = z[i]
            let xhttp = new XMLHttpRequest()
            xhttp.onreadystatechange = function() { elmnt.innerHTML = this.responseText }
            xhttp.open("GET", elmnt.getAttribute("src"), true)
            xhttp.send()
        }
    })
</script>
</head>
<body><header class="site-header">
  <div class="wrapper">
    <!--img src="/assets/logo-cfc.png" class="center"--><a class="site-title" rel="author" href="/">Lua for Civilization II</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a><a class="page-link" href="/auto_doc/autoIndex.html">Function Docs</a><a class="page-link" href="/executionPoints.html">Execution Points</a><a class="page-link" href="/lua_lessons/lessons_toc.html">Lua Lessons</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <head><title>Execution Points for Code</title>
</head>
<article class="post">

  <header class="post-header">
    <h1 class="post-title">Lua Execution Points</h1>
  </header>
  
  <div class="toc-div">
    <h2 class="toc-header">Contents</h2>
    <ul><li><a href="#unit-activation"><strong>Unit Activation</strong></a></li><li><a href="#unit-bribery"><strong>Unit Bribery</strong></a></li><li><a href="#city-yield-calculation"><strong>City Yield Calculation</strong></a></li><li><a href="#centauri-arrival"><strong>Centauri Arrival</strong></a></li><li><a href="#city-destruction"><strong>City Destruction</strong></a></li><li><a href="#city-founded"><strong>City Founded</strong></a></li><li><a href="#city-production"><strong>City Production</strong></a></li><li><a href="#city-captured"><strong>City Captured</strong></a></li><li><a href="#city-window-opened"><strong>City Window Opened</strong></a></li><li><a href="#game-end"><strong>Game End</strong></a></li><li><a href="#combat-declared"><strong>Combat Declared</strong></a></li><li><a href="#key-press"><strong>Key Press</strong></a></li><li><a href="#game-loaded"><strong>Game Loaded</strong></a></li><li><a href="#game-saved"><strong>Game Saved</strong></a></li><li><a href="#scenario-loaded"><strong>Scenario Loaded</strong></a></li><li><a href="#negotiation"><strong>Negotiation</strong></a></li><li><a href="#tribe-schism"><strong>Tribe Schism</strong></a></li><li><a href="#between-turns"><strong>Between Turns</strong></a></li><li><a href="#unit-killed-in-combat"><strong>Unit Killed In Combat</strong></a></li><li><a href="#unit-defeated"><strong>Unit Defeated</strong></a></li><li><a href="#unit-death"><strong>Unit Death</strong></a></li><li><a href="#unit-death-outside-combat"><strong>Unit Death Outside Combat</strong></a></li><li><a href="#unit-deleted"><strong>Unit Deleted</strong></a></li><li><a href="#city-processing-complete"><strong>City Processing Complete</strong></a></li><li><a href="#before-city-processing"><strong>Before City Processing</strong></a></li><li><a href="#tribe-turn-finished"><strong>Tribe Turn Finished</strong></a></li><li><a href="#just-before-city-processed"><strong>Just Before City Processed</strong></a></li><li><a href="#just-after-city-processed"><strong>Just After City Processed</strong></a></li><li><a href="#unit-enters-tile"><strong>Unit Enters Tile</strong></a></li><li><a href="#unit-given-final-order"><strong>Unit Given Final Order</strong></a></li><li><a href="#nuclear-attack"><strong>Nuclear Attack</strong></a></li><li><a href="#get-rush-buy-cost"><strong>Get Rush Buy Cost</strong></a></li><li><a href="#get-formatted-date"><strong>Get Formatted Date</strong></a></li><li><a href="#select-music"><strong>Select Music</strong></a></li><li><a href="#combat-resolution"><strong>Combat Resolution</strong></a></li><li><a href="#choose-tile-defender"><strong>Choose Tile Defender</strong></a></li><li><a href="#check-if-city-can-build-item"><strong>Check If City Can Build Item</strong></a></li></ul></div>  
  
  <div class="post-content">
    <p>Lua Events function by running code at certain predetermined points during the Civilization II: Test of Time game.  The term “Execution Point”
refers to one of these points where code that has been registered is executed.  Everything that can be achieved with Lua 
must be done through these execution points.  Sometimes, complicated events will use more than one of these execution
points to achieve their effect.</p>

<p>In some cases, the execution point expects code which will return a value that influences how the game works.</p>

<p>The Test of Time Patch Project provides many execution points.  However, in order to improve programming convenience, the Lua Scenario Template
provides even more execution points by running the pre-existing execution points only at certain times.</p>
<h3 id="unit-activation">
  
  
    <strong>Unit Activation</strong> <a href="#unit-activation"><span class="self-link">&#128279</span></a>
  
  
</h3>
    
<p>This code is executed whenever a unit is activated or has moved but still has movement points left.
In <code class="language-plaintext highlighter-rouge">LuaParameterFilesparameters.lua</code>, the field <code class="language-plaintext highlighter-rouge">civ.scen.compatibility.activateUnitEveryMove</code> is
set to true.  If this is not done (or in old versions of the Test of Time Patch Project), human
units don’t execute the registered activation code after moving.</p>

<p>This event can optionally return <code class="language-plaintext highlighter-rouge">true</code> or a function.  In either case, the activation of the unit is cancelled.  The movement allowance of the unit’s type will
temporarily be set to 0, and all further code for this event will be cancelled.</p>

<p>If the event returns a function, that function will be called just before the next unit
is activated.  (You may wish to put the unit to sleep, for example.)</p>

<p>Failure to return a value here is equivalent to returning nil, which will make 
the activation code execute as normal.</p>
<h4 id="usage">
  
  
    Usage <a href="#usage"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<h5 id="consolidatedeventslua">
  
  
    <strong>consolidatedEvents.lua</strong> <a href="#consolidatedeventslua"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Unit Activation</span>
<span class="c1">--Registers a function to be called every time a unit is activated. The callback takes the unit activated as a parameter, and the source of unit activation. `source` is `true` if activated by keyboard or mouse click, `false` if activated by the game itself. `repeatMove` is `true` if it's a repeat activation caused by moving, `false` otherwise.</span>
<span class="c1">--If the function returns true, the unit activation will be cancelled.</span>
<span class="c1">--No further activation code will be executed, and the unit's type</span>
<span class="c1">--will temporarily be set to have 0 movement points.</span>
<span class="c1">--If the function returns function(unit), then the unit activation</span>
<span class="c1">--will be cancelled, and the function returned will be executed</span>
<span class="c1">--just before another unit is activated.  (You may wish to put</span>
<span class="c1">--the unit to sleep, for example.)</span>
<span class="c1">--Not returning anything is equivalent to returning nil, which is</span>
<span class="c1">--acceptable, and keeps the unit activation going.</span>
<span class="k">function</span> <span class="nc">events</span><span class="p">.</span><span class="nf">onActivateUnit</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span><span class="n">source</span><span class="p">,</span><span class="n">repeatMove</span><span class="p">)</span>
    <span class="c1">--civ.ui.text("Unit activation consolidated test")</span>

<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">unit</code> parameter is the unit that has been activated.</p>

<p>The <code class="language-plaintext highlighter-rouge">source</code> parameter is <code class="language-plaintext highlighter-rouge">true</code> if the unit was activated by keyboard or mouse, and
<code class="language-plaintext highlighter-rouge">false</code> if it was activated by the game itself.</p>

<p>The <code class="language-plaintext highlighter-rouge">repeatMove</code> parameter is <code class="language-plaintext highlighter-rouge">true</code> if the execution point is triggered by a repeated activation.</p>
<h5 id="eventsfilesonactivateunitlua">
  
  
    <strong>EventsFiles\onActivateUnit.lua</strong> <a href="#eventsfilesonactivateunitlua"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">--Registers a function to be called every time a unit is activated. The callback takes the unit activated as a parameter, and the source of unit activation. `source` is `true` if activated by keyboard or mouse click, `false` if activated by the game itself. `repeatMove` is `true` if it's a repeat activation caused by moving, `false` otherwise.</span>
<span class="c1">--If the function returns true, the unit activation will be cancelled.</span>
<span class="c1">--No further activation code will be executed, and the unit's type</span>
<span class="c1">--will temporarily be set to have 0 movement points.</span>
<span class="c1">--If the function returns function(unit), then the unit activation</span>
<span class="c1">--will be cancelled, and the function returned will be executed</span>
<span class="c1">--just before another unit is activated.  (You may wish to put</span>
<span class="c1">--the unit to sleep, for example.)</span>
<span class="c1">--Not returning anything is equivalent to returning nil, which is</span>
<span class="c1">--acceptable, and keeps the unit activation going.</span>
<span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onActivateUnit</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span><span class="n">source</span><span class="p">,</span><span class="n">repeatMove</span><span class="p">)</span>
    <span class="c1">--civ.ui.text("unit activation separate file")</span>

<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">unit</code> parameter is the unit that has been activated.</p>

<p>The <code class="language-plaintext highlighter-rouge">source</code> parameter is <code class="language-plaintext highlighter-rouge">true</code> if the unit was activated by keyboard or mouse, and
<code class="language-plaintext highlighter-rouge">false</code> if it was activated by the game itself.</p>

<p>The <code class="language-plaintext highlighter-rouge">repeatMove</code> parameter is <code class="language-plaintext highlighter-rouge">true</code> if the execution point is triggered by a repeated activation.</p>
<h5 id="discrete-events">
  
  
    <strong>Discrete Events</strong> <a href="#discrete-events"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete Unit Activation event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">--Registers a function to be called every time a unit is activated. The callback takes the unit activated as a parameter, and the source of unit activation. `source` is `true` if activated by keyboard or mouse click, `false` if activated by the game itself. `repeatMove` is `true` if it's a repeat activation caused by moving, `false` otherwise.</span>
<span class="c1">--If the function returns true, the unit activation will be cancelled.</span>
<span class="c1">--No further activation code will be executed, and the unit's type</span>
<span class="c1">--will temporarily be set to have 0 movement points.</span>
<span class="c1">--If the function returns function(unit), then the unit activation</span>
<span class="c1">--will be cancelled, and the function returned will be executed</span>
<span class="c1">--just before another unit is activated.  (You may wish to put</span>
<span class="c1">--the unit to sleep, for example.)</span>
<span class="c1">--Not returning anything is equivalent to returning nil, which is</span>
<span class="c1">--acceptable, and keeps the unit activation going.</span>
<span class="n">discreteEvents</span><span class="p">.</span><span class="n">onActivateUnit</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span><span class="n">source</span><span class="p">,</span><span class="n">repeatMove</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"Unit activation Discrete Event"</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">unit</code> parameter is the unit that has been activated.</p>

<p>The <code class="language-plaintext highlighter-rouge">source</code> parameter is <code class="language-plaintext highlighter-rouge">true</code> if the unit was activated by keyboard or mouse, and
<code class="language-plaintext highlighter-rouge">false</code> if it was activated by the game itself.</p>

<p>The <code class="language-plaintext highlighter-rouge">repeatMove</code> parameter is <code class="language-plaintext highlighter-rouge">true</code> if the execution point is triggered by a repeated activation.</p>
<h4 id="implementation">
  
  
    Implementation <a href="#implementation"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<p>This execution point is provided by the Test of Time Patch Project function <code class="language-plaintext highlighter-rouge">civ.scen.onActivateUnit</code>.</p>
<h3 id="unit-bribery">
  
  
    <strong>Unit Bribery</strong> <a href="#unit-bribery"><span class="self-link">&#128279</span></a>
  
  
</h3>
    
<p>Code will be executed whenever a unit is bribed.</p>
<h4 id="usage-1">
  
  
    Usage <a href="#usage-1"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<h5 id="consolidatedeventslua-1">
  
  
    <strong>consolidatedEvents.lua</strong> <a href="#consolidatedeventslua-1"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- On Unit Bribery</span>
<span class="k">function</span> <span class="nc">events</span><span class="p">.</span><span class="nf">onBribeUnit</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span><span class="n">previousOwner</span><span class="p">)</span>
    <span class="c1">--civ.ui.text("Bribe unit consolidated test")</span>

<span class="k">end</span>

</code></pre></div></div>
<p>The <code class="language-plaintext highlighter-rouge">unit</code> is the unit that was just bribed.</p>

<p>The <code class="language-plaintext highlighter-rouge">previous owner</code> is the tribe that owned the unit before.</p>
<h5 id="eventsfilesonbribeunitlua">
  
  
    <strong>EventsFiles\onBribeUnit.lua</strong> <a href="#eventsfilesonbribeunitlua"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onBribeUnit</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span><span class="n">previousOwner</span><span class="p">)</span>
    <span class="c1">--civ.ui.text("On bribe unit separate file")</span>
<span class="k">end</span>

</code></pre></div></div>
<p>The <code class="language-plaintext highlighter-rouge">unit</code> is the unit that was just bribed.</p>

<p>The <code class="language-plaintext highlighter-rouge">previous owner</code> is the tribe that owned the unit before.</p>
<h5 id="discrete-events-1">
  
  
    <strong>Discrete Events</strong> <a href="#discrete-events-1"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete Unit Bribery event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">discreteEvents</span><span class="p">.</span><span class="n">onBribeUnit</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span><span class="n">previousOwner</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"Bribe unit discrete event test"</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>
<p>The <code class="language-plaintext highlighter-rouge">unit</code> is the unit that was just bribed.</p>

<p>The <code class="language-plaintext highlighter-rouge">previous owner</code> is the tribe that owned the unit before.</p>
<h4 id="implementation-1">
  
  
    Implementation <a href="#implementation-1"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<p>This execution point is provided by the Test of Time Patch Project function <code class="language-plaintext highlighter-rouge">civ.scen.onBribeUnit</code>.</p>
<h3 id="city-yield-calculation">
  
  
    <strong>City Yield Calculation</strong> <a href="#city-yield-calculation"><span class="self-link">&#128279</span></a>
  
  
</h3>
    

<p>Allows code to be executed whenever a city computes its production.  This can happen both at the start of the turn, and when the human player opens the city screen.  It can also happen when a player changes the tax rate.</p>

<p>Additionally, the returned values of the registered function
can be used to modify the city’s production.</p>

<p>This execution point registers a function to be called every time a city calculates its total resource yield. The function inputs are the city, and the food, shields and trade of its tiles. Returns a 5-tuple of modifiers, food change, shield change before waste, shield change after waste, trade change before corruption, trade change after corruption. These modifiers are applied at the following points in the calculation:</p>

<ol>
  <li>Calculate yield from all worked tiles</li>
  <li><strong>Run onCalculateCityYield</strong></li>
  <li><strong>Add foodChange, shieldChangeBeforeWaste and tradeChangeBeforeCorruption</strong></li>
  <li>Add changes from food trade routes</li>
  <li>Add shields from improvements</li>
  <li>Calculate and subtract waste</li>
  <li>Calculate corruption and add changes from commodity trade routes</li>
  <li>Calculate corruption again (now using the value after trade routes) and subtract.</li>
  <li><strong>Add shieldChangeAfterWaste and tradeChangeAfterCorruption</strong></li>
  <li>Calculate Tax/Lux/Sci</li>
</ol>
<h4 id="usage-2">
  
  
    Usage <a href="#usage-2"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<h5 id="mechanicsfilescalculatecityyieldlua">
  
  
    <strong>MechanicsFiles\calculateCityYield.lua</strong> <a href="#mechanicsfilescalculatecityyieldlua"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>In the <code class="language-plaintext highlighter-rouge">MechanicsFiles</code> folder, change the file called <code class="language-plaintext highlighter-rouge">calculateCityYield.lua</code>.  Change the function <code class="language-plaintext highlighter-rouge">cityYield.onCalculateCityYield</code> in order to change this event.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nc">cityYield</span><span class="p">.</span><span class="nf">onCalculateCityYield</span><span class="p">(</span><span class="n">city</span><span class="p">,</span><span class="n">food</span><span class="p">,</span><span class="n">shields</span><span class="p">,</span><span class="n">trade</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">extraFood</span><span class="p">,</span><span class="n">extraShields</span><span class="p">,</span><span class="n">extraTrade</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span> <span class="c1">-- resources to add to compensate</span>
            <span class="c1">-- for terrain changes made during the city yield calculation</span>
            <span class="c1">-- If you remove the above line, remember to remove the references to</span>
            <span class="c1">-- these variables in the return line at the end of this function</span>
    <span class="c1">-- If you are not making any terrain production value changes in this</span>
    <span class="c1">-- function, you can take out the code below this line and above a</span>
    <span class="c1">-- corresponding line below</span>
    <span class="c1">-- Any changes to terrain production should go here</span>
    
    <span class="c1">-- verify strategic targets, in case terrain changes or something</span>
    <span class="k">if</span> <span class="n">strategicTargetsAvailable</span> <span class="k">then</span>
        <span class="k">for</span> <span class="n">target</span> <span class="k">in</span> <span class="n">strat</span><span class="p">.</span><span class="n">iterateTargets</span><span class="p">(</span><span class="n">city</span><span class="p">)</span> <span class="k">do</span>
            <span class="n">strat</span><span class="p">.</span><span class="n">verifyTarget</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
        <span class="k">end</span>
    <span class="k">end</span>
    


    <span class="c1">-- Any changes to terrain production should be before this line</span>
    <span class="kd">local</span> <span class="n">correctFood</span><span class="p">,</span><span class="n">correctShields</span><span class="p">,</span><span class="n">correctTrade</span> <span class="o">=</span> <span class="n">baseProduction</span><span class="p">(</span><span class="n">city</span><span class="p">,</span><span class="kc">true</span><span class="p">)</span>
    <span class="n">extraFood</span> <span class="o">=</span> <span class="n">correctFood</span><span class="o">-</span><span class="n">food</span>
    <span class="n">food</span> <span class="o">=</span> <span class="n">correctFood</span>
    <span class="n">extraShields</span> <span class="o">=</span> <span class="n">correctShields</span> <span class="o">-</span> <span class="n">shields</span>
    <span class="n">shields</span> <span class="o">=</span> <span class="n">correctShields</span>
    <span class="n">extraTrade</span> <span class="o">=</span> <span class="n">correctTrade</span> <span class="o">-</span> <span class="n">trade</span>
    <span class="n">trade</span> <span class="o">=</span> <span class="n">correctTrade</span>
    <span class="c1">-- If you are not making any terrain production value change in this</span>
    <span class="c1">-- function, you can take out the code above this line and below</span>
    <span class="c1">-- the corresponding line above</span>
    <span class="c1">-- You can take out the lines even if you have a beforeProduction event</span>
    <span class="c1">-- that changes terrain production, since that has been compensated for</span>
    <span class="c1">-- in the events.lua file</span>


    <span class="c1">-- After this point, the variables food, shields, and trade will refer to their</span>
    <span class="c1">-- 'correct' values, even if you've changed terrain production values</span>

    <span class="c1">-- change the values of these variables to reflect the changes you would like to</span>
    <span class="c1">-- make to these different production values</span>
    <span class="kd">local</span> <span class="n">foodChange</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="kd">local</span> <span class="n">shieldChangeBeforeWaste</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">-- changes the value before factory/power plant applied</span>
    <span class="kd">local</span> <span class="n">shieldChangeAfterWaste</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">-- changes the value after factory/power plant applied</span>
    <span class="kd">local</span> <span class="n">tradeChangeBeforeCorruption</span> <span class="o">=</span> <span class="mi">0</span> 
    <span class="kd">local</span> <span class="n">tradeChangeAfterCorruption</span> <span class="o">=</span> <span class="mi">0</span> 

    <span class="k">return</span>  <span class="n">foodChange</span><span class="o">+</span><span class="n">extraFood</span><span class="p">,</span>
            <span class="n">shieldChangeBeforeWaste</span> <span class="o">+</span> <span class="n">extraShields</span><span class="p">,</span>
            <span class="n">shieldChangeAfterWaste</span><span class="p">,</span>
            <span class="n">tradeChangeBeforeCorruption</span><span class="o">+</span> <span class="n">extraTrade</span><span class="p">,</span>
            <span class="n">tradeChangeAfterCorruption</span>
<span class="k">end</span>

</code></pre></div></div>

<p>If you desire to make changes to terrain production, you should do so between the lines
<code class="language-plaintext highlighter-rouge">-- Any changes to terrain production should go here</code>
and
<code class="language-plaintext highlighter-rouge">-- Any changes to terrain production should be before this line</code>.</p>

<p>This is because the <code class="language-plaintext highlighter-rouge">food</code>, <code class="language-plaintext highlighter-rouge">shield</code>, and <code class="language-plaintext highlighter-rouge">trade</code> arguments are computed before any changes are made to terrain production, and so these variables must be updated, which is done by the time the code reaches the lines</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- After this point, the variables food, shields, and trade will refer to their</span>
<span class="c1">-- 'correct' values, even if you've changed terrain production values</span>
</code></pre></div></div>

<p>You may wish to consider using the Custom Cosmic module if you are interested in making changes to terrain production.</p>

<p>If you are interested in making changes to food, shield, or trade production which does not depend on special changes to terrain productivity, you can do so by changing the values of the variables <code class="language-plaintext highlighter-rouge">foodChange</code>, <code class="language-plaintext highlighter-rouge">shieldChangeBeforeWaste</code>, <code class="language-plaintext highlighter-rouge">shieldChangeAfterWaste</code>, <code class="language-plaintext highlighter-rouge">tradeChangeBeforeCorruption</code>, and <code class="language-plaintext highlighter-rouge">tradeChangeAfterCorruption</code>.</p>

<p>Note that there are two different shield changes.  The first one is applied before the factory, power plant, and waste modifications are computed, and the second one is applied after.  The same is true for the trade changes, except that the first one is applied before the corruption is applied, and the second one is applied after the corruption is applied.</p>

<p>The <code class="language-plaintext highlighter-rouge">city</code> parameter is the city whose production is being calculated.</p>

<p>The <code class="language-plaintext highlighter-rouge">food</code> parameter is the amount of food the city is producing.  This is updated part way through the function, to account for any changes to terrain production.</p>

<p>The <code class="language-plaintext highlighter-rouge">shields</code> parameter is the amount of shields the city is producing.  This is updated part way through the function, to account for any changes to terrain production.</p>

<p>The <code class="language-plaintext highlighter-rouge">trade</code> parameter is the amount of trade the city is producing.  This is updated part way through the function, to account for any changes to terrain production.</p>
<h4 id="implementation-2">
  
  
    Implementation <a href="#implementation-2"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<h4 id="implementation-3">
  
  
    Implementation <a href="#implementation-3"><span class="self-link">&#128279</span></a>
  
  
</h4>
    

<p>This execution point is implemented using the function <code class="language-plaintext highlighter-rouge">civ.scen.onCalculateCityYield</code>.</p>
<h3 id="centauri-arrival">
  
  
    <strong>Centauri Arrival</strong> <a href="#centauri-arrival"><span class="self-link">&#128279</span></a>
  
  
</h3>
    
<p>Executes code when a tribe’s spaceship reaches its target.</p>
<h4 id="usage-3">
  
  
    Usage <a href="#usage-3"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<h5 id="consolidatedeventslua-2">
  
  
    <strong>consolidatedEvents.lua</strong> <a href="#consolidatedeventslua-2"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- On Centauri Arrival</span>
<span class="c1">-- This is available with games started as an extended original game,</span>
<span class="c1">-- but not with games started as a standard game (I think, this hasn't been looked at too closely)</span>
<span class="k">function</span> <span class="nc">events</span><span class="p">.</span><span class="nf">onCentauriArrival</span><span class="p">(</span><span class="n">tribe</span><span class="p">)</span>
    <span class="c1">--civ.ui.text(tribe.name.." has reached Alpha Centauri.")</span>

<span class="k">end</span>

</code></pre></div></div>
<p>The <code class="language-plaintext highlighter-rouge">tribe</code> is the tribe whose spaceship has reached its destination.</p>
<h5 id="eventsfilesoncentauriarrivallua">
  
  
    <strong>EventsFiles\onCentauriArrival.lua</strong> <a href="#eventsfilesoncentauriarrivallua"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onCentauriArrival</span><span class="p">(</span><span class="n">tribe</span><span class="p">)</span>
    <span class="c1">--civ.ui.text("centauri arrival separate file")</span>

<span class="k">end</span>

</code></pre></div></div>
<p>The <code class="language-plaintext highlighter-rouge">tribe</code> is the tribe whose spaceship has reached its destination.</p>
<h5 id="discrete-events-2">
  
  
    <strong>Discrete Events</strong> <a href="#discrete-events-2"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete Centauri Arrival event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">discreteEvents</span><span class="p">.</span><span class="n">onCentauriArrival</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">tribe</span><span class="p">)</span>
    <span class="c1">--civ.ui.text(tribe.name.." arrived at centauri discrete event")</span>
<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>
<p>The <code class="language-plaintext highlighter-rouge">tribe</code> is the tribe whose spaceship has reached its destination.</p>
<h4 id="implementation-4">
  
  
    Implementation <a href="#implementation-4"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<p>This execution point is provided by the Test of Time Patch Project function <code class="language-plaintext highlighter-rouge">civ.scen.onCentauriArrival</code>.</p>
<h3 id="city-destruction">
  
  
    <strong>City Destruction</strong> <a href="#city-destruction"><span class="self-link">&#128279</span></a>
  
  
</h3>
    
<p>Executes code when a city is destroyed.</p>
<h4 id="usage-4">
  
  
    Usage <a href="#usage-4"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<h5 id="consolidatedeventslua-3">
  
  
    <strong>consolidatedEvents.lua</strong> <a href="#consolidatedeventslua-3"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- City destruction</span>
<span class="k">function</span> <span class="nc">events</span><span class="p">.</span><span class="nf">onCityDestroyed</span><span class="p">(</span><span class="n">city</span><span class="p">)</span>
    <span class="c1">--civ.ui.text("City destroyed consolidated test")</span>

<span class="k">end</span>

</code></pre></div></div>
<p>The <code class="language-plaintext highlighter-rouge">city</code> it the city that was just destroyed.</p>
<h5 id="eventsfilesoncitydestroyedlua">
  
  
    <strong>EventsFiles\onCityDestroyed.lua</strong> <a href="#eventsfilesoncitydestroyedlua"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- This function will be registered for the onCityDestroyed</span>
<span class="c1">-- execution point</span>
<span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onCityDestroyed</span><span class="p">(</span><span class="n">city</span><span class="p">)</span>
    <span class="c1">--civ.ui.text("on city destroyed separate file")</span>
<span class="k">end</span>

</code></pre></div></div>
<p>The <code class="language-plaintext highlighter-rouge">city</code> it the city that was just destroyed.</p>
<h5 id="discrete-events-3">
  
  
    <strong>Discrete Events</strong> <a href="#discrete-events-3"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete City Destruction event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">discreteEvents</span><span class="p">.</span><span class="n">onCityDestroyed</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">city</span><span class="p">)</span> 
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"City destroyed discrete event test"</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>
<p>The <code class="language-plaintext highlighter-rouge">city</code> it the city that was just destroyed.</p>
<h4 id="implementation-5">
  
  
    Implementation <a href="#implementation-5"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<p>This execution point is provided by the Test of Time Patch Project function <code class="language-plaintext highlighter-rouge">civ.scen.onCityDestroyed</code>.</p>
<h3 id="city-founded">
  
  
    <strong>City Founded</strong> <a href="#city-founded"><span class="self-link">&#128279</span></a>
  
  
</h3>
    

<p>Executes code when a city is founded, just before the “What Shall We
 Name This City” dialog box.  You can change the suggested name for the city
at this time by changing the <a href="auto_doc/cityObject.html#name"><code class="language-plaintext highlighter-rouge">city.name</code></a> field.</p>

<p>You can (optionally) return a function to be called if the city is
not built after all (if the city is cancelled during the naming
process).  For example, if you change the terrain under or around the city
when it is founded, you can change it back here.  If you write city founded code in more than one place
(such as multiple discrete events, or using both the Events Files and
consolidated events), all returned functions are executed.</p>
<h4 id="usage-5">
  
  
    Usage <a href="#usage-5"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<h5 id="consolidatedeventslua-4">
  
  
    <strong>consolidatedEvents.lua</strong> <a href="#consolidatedeventslua-4"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- On City Founded</span>
<span class="k">function</span> <span class="nc">events</span><span class="p">.</span><span class="nf">onCityFounded</span><span class="p">(</span><span class="n">city</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"consolidated.onCityFounded for "</span><span class="o">..</span><span class="n">city</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="c1">-- the cityCancelled() function is executed if the player</span>
    <span class="c1">-- decides not to found the city after all</span>
    <span class="c1">-- (so you can undo terrain changes, etc.</span>
    <span class="kd">local</span> <span class="k">function</span> <span class="nf">cityCancelled</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
            <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"consolidated.onCityFounded city cancelled for "</span><span class="o">..</span><span class="n">city</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">end</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="n">cityCancelled</span>
<span class="k">end</span>

</code></pre></div></div>
<p>The <code class="language-plaintext highlighter-rouge">city</code> is the city that is being founded.</p>
<h5 id="eventsfilesoncityfoundedlua">
  
  
    <strong>EventsFiles\onCityFounded.lua</strong> <a href="#eventsfilesoncityfoundedlua"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onCityFounded</span><span class="p">(</span><span class="n">city</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"separate file onCityFounded for "</span><span class="o">..</span><span class="n">city</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="c1">-- the cityCancelled() function is executed if the player</span>
    <span class="c1">-- decides not to found the city after all</span>
    <span class="c1">-- (so you can undo terrain changes, etc.</span>
    <span class="kd">local</span> <span class="k">function</span> <span class="nf">cityCancelled</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
            <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"separate file onCityFounded city cancelled for "</span><span class="o">..</span><span class="n">city</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">end</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="n">cityCancelled</span>
<span class="k">end</span>

</code></pre></div></div>
<p>The <code class="language-plaintext highlighter-rouge">city</code> is the city that is being founded.</p>
<h5 id="discrete-events-4">
  
  
    <strong>Discrete Events</strong> <a href="#discrete-events-4"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete City Founded event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">discreteEvents</span><span class="p">.</span><span class="n">onCityFounded</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">city</span><span class="p">)</span> 
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"discreteEvents.onCityFounded for "</span><span class="o">..</span><span class="n">city</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="c1">-- the cityCancelled() function is executed if the player</span>
    <span class="c1">-- decides not to found the city after all</span>
    <span class="c1">-- (so you can undo terrain changes, etc.</span>
    <span class="kd">local</span> <span class="k">function</span> <span class="nf">cityCancelled</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
            <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"discreteEvents.onCityFounded city cancelled for "</span><span class="o">..</span><span class="n">city</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">end</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="n">cityCancelled</span>
<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>
<p>The <code class="language-plaintext highlighter-rouge">city</code> is the city that is being founded.</p>
<h4 id="implementation-6">
  
  
    Implementation <a href="#implementation-6"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<p>This execution point is provided by the Test of Time Patch Project function <code class="language-plaintext highlighter-rouge">civ.scen.onCityFounded</code>.</p>
<h3 id="city-production">
  
  
    <strong>City Production</strong> <a href="#city-production"><span class="self-link">&#128279</span></a>
  
  
</h3>
    
<p>Executes code when a city completes production of something.</p>
<h4 id="usage-6">
  
  
    Usage <a href="#usage-6"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<h5 id="consolidatedeventslua-5">
  
  
    <strong>consolidatedEvents.lua</strong> <a href="#consolidatedeventslua-5"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- On city production (when a city produces a unit/improvement/wonder)</span>
<span class="k">function</span> <span class="nc">events</span><span class="p">.</span><span class="nf">onCityProduction</span><span class="p">(</span><span class="n">city</span><span class="p">,</span><span class="n">prod</span><span class="p">)</span>
    <span class="c1">--civ.ui.text(city.name.." has procuded something.")</span>

<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">city</code> is the city which just completed production.</p>

<p>The <code class="language-plaintext highlighter-rouge">prod</code> is the item that was produced.  If a unit was produced,
it is a unit Object (not a unitType object).  If an improvement or
wonder was completed, <code class="language-plaintext highlighter-rouge">prod</code> is the corresponding improvement object
 or wonder object.</p>
<h5 id="eventsfilesoncityproductionlua">
  
  
    <strong>EventsFiles\onCityProduction.lua</strong> <a href="#eventsfilesoncityproductionlua"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nc">onCityProduction</span><span class="p">.</span><span class="nf">onCityProduction</span><span class="p">(</span><span class="n">city</span><span class="p">,</span><span class="n">prod</span><span class="p">)</span>
    <span class="c1">--civ.ui.text("City production separate file")</span>


<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">city</code> is the city which just completed production.</p>

<p>The <code class="language-plaintext highlighter-rouge">prod</code> is the item that was produced.  If a unit was produced,
it is a unit Object (not a unitType object).  If an improvement or
wonder was completed, <code class="language-plaintext highlighter-rouge">prod</code> is the corresponding improvement object
 or wonder object.</p>
<h5 id="discrete-events-5">
  
  
    <strong>Discrete Events</strong> <a href="#discrete-events-5"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete City Production event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">discreteEvents</span><span class="p">.</span><span class="n">onCityProduction</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">city</span><span class="p">,</span><span class="n">item</span><span class="p">)</span> 
    <span class="c1">--civ.ui.text("City production discrete event test")</span>

<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">city</code> is the city which just completed production.</p>

<p>The <code class="language-plaintext highlighter-rouge">prod</code> is the item that was produced.  If a unit was produced,
it is a unit Object (not a unitType object).  If an improvement or
wonder was completed, <code class="language-plaintext highlighter-rouge">prod</code> is the corresponding improvement object
 or wonder object.</p>
<h4 id="implementation-7">
  
  
    Implementation <a href="#implementation-7"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<p>This execution point is provided by the Test of Time Patch Project function <code class="language-plaintext highlighter-rouge">civ.scen.onCityProduction</code>.</p>
<h3 id="city-captured">
  
  
    <strong>City Captured</strong> <a href="#city-captured"><span class="self-link">&#128279</span></a>
  
  
</h3>
    

<p>This execution point is triggered when a city is captured by another tribe.  The execution point takes place after the city has been captured, but before the units supported by the city are disbanded.</p>
<h4 id="usage-7">
  
  
    Usage <a href="#usage-7"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<h5 id="consolidatedeventslua-6">
  
  
    <strong>consolidatedEvents.lua</strong> <a href="#consolidatedeventslua-6"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- On City Taken</span>
<span class="c1">-- (get conqueror by using city.owner)</span>
<span class="k">function</span> <span class="nc">events</span><span class="p">.</span><span class="nf">onCityTaken</span><span class="p">(</span><span class="n">city</span><span class="p">,</span><span class="n">defender</span><span class="p">)</span>
    <span class="c1">--civ.ui.text(city.name.." captured from the "..defender.name.." by the "..city.owner.name..". Consolidated Events.")</span>

<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">city</code> is the city that was captured.</p>

<p>The <code class="language-plaintext highlighter-rouge">defender</code> is the tribe that owned the city before it was captured.  To get the tribe that captured the city, use <code class="language-plaintext highlighter-rouge">city.owner</code>.</p>
<h5 id="eventsfilesoncitytakenlua">
  
  
    <strong>EventsFiles\onCityTaken.lua</strong> <a href="#eventsfilesoncitytakenlua"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onCityTaken</span><span class="p">(</span><span class="n">city</span><span class="p">,</span><span class="n">defender</span><span class="p">)</span>
    <span class="c1">--civ.ui.text("city taken separate file test")</span>

<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">city</code> is the city that was captured.</p>

<p>The <code class="language-plaintext highlighter-rouge">defender</code> is the tribe that owned the city before it was captured.  To get the tribe that captured the city, use <code class="language-plaintext highlighter-rouge">city.owner</code>.</p>
<h5 id="discrete-events-6">
  
  
    <strong>Discrete Events</strong> <a href="#discrete-events-6"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete City Captured event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">discreteEvents</span><span class="p">.</span><span class="n">onCityTaken</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">city</span><span class="p">,</span><span class="n">defender</span><span class="p">)</span> 
    <span class="c1">--civ.ui.text(city.name.." taken from "..defender.name.." discrete event")</span>


<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">city</code> is the city that was captured.</p>

<p>The <code class="language-plaintext highlighter-rouge">defender</code> is the tribe that owned the city before it was captured.  To get the tribe that captured the city, use <code class="language-plaintext highlighter-rouge">city.owner</code>.</p>
<h4 id="implementation-8">
  
  
    Implementation <a href="#implementation-8"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<p>This execution point is provided by the Test of Time Patch Project function <code class="language-plaintext highlighter-rouge">civ.scen.onCityTaken</code>.</p>
<h3 id="city-window-opened">
  
  
    <strong>City Window Opened</strong> <a href="#city-window-opened"><span class="self-link">&#128279</span></a>
  
  
</h3>
    

<p>This execution point is triggered when a city window is opened.  Note that the AI does not open city windows.</p>
<h4 id="usage-8">
  
  
    Usage <a href="#usage-8"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<h5 id="eventsfilesoncitywindowopenedlua">
  
  
    <strong>EventsFiles\onCityWindowOpened.lua</strong> <a href="#eventsfilesoncitywindowopenedlua"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">---Add any events to happen when a city window is opened.</span>
<span class="c1">---(Note that the AI doesn't open city windows.)</span>
<span class="c1">---@param city cityObject The city that is being examined.</span>
<span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onCityWindowOpened</span><span class="p">(</span><span class="n">city</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"eventsFiles\\onCityWindowOpened.lua: onCityWindowOpened called with city: "</span><span class="o">..</span><span class="n">city</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>

</code></pre></div></div>
<p>The <code class="language-plaintext highlighter-rouge">city</code> is the city whose window is being opened.</p>
<h5 id="discrete-events-7">
  
  
    <strong>Discrete Events</strong> <a href="#discrete-events-7"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete City Window Opened event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Executes when a city window is opened.</span>
<span class="c1">-- Note that the AI doesn't open city windows.</span>
<span class="n">discreteEvents</span><span class="p">.</span><span class="n">onCityWindowOpened</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">city</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"discreteEvents.onCityWindowOpened: The city window for "</span><span class="o">..</span><span class="n">city</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">" has been opened."</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>
<p>The <code class="language-plaintext highlighter-rouge">city</code> is the city whose window is being opened.</p>
<h4 id="implementation-9">
  
  
    Implementation <a href="#implementation-9"><span class="self-link">&#128279</span></a>
  
  
</h4>
    

<p>This execution point is implemented using the TOTPP function <code class="language-plaintext highlighter-rouge">civ.scen.onGetFormattedDate</code> and checking if there is currently a city window open by using <code class="language-plaintext highlighter-rouge">civ.getOpenCity</code>.  The most recently opened city is kept track of, to make sure that the execution point is only triggered once per city window, particularly so that a window hidden behind the map doesn’t continuously trigger the execution point.  Closing and opening the same city window will trigger the execution point again.</p>
<h3 id="game-end">
  
  
    <strong>Game End</strong> <a href="#game-end"><span class="self-link">&#128279</span></a>
  
  
</h3>
    

<p>This execution point is triggered when the game ends.  If the registered function returns true, then the game actually ends (default behavior).  If the registered function returns false, then the game does not end.  Since there are multiple ways to register a function for this execution point, if any of the registered functions returns false, then the game does not end.</p>
<h4 id="usage-9">
  
  
    Usage <a href="#usage-9"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<h5 id="consolidatedeventslua-7">
  
  
    <strong>consolidatedEvents.lua</strong> <a href="#consolidatedeventslua-7"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- On Game Ends</span>
<span class="c1">-- Return true if the game ends as normal,</span>
<span class="c1">-- and false otherwise.</span>
<span class="c1">-- This is combined with the discrete events and the</span>
<span class="c1">-- legacy events, as well as a separate onGameEnds.lua file</span>
<span class="c1">-- If any of these return false, then game end is prevented</span>
<span class="c1">-- Lua Function Reference Info:</span>
<span class="c1">--onGameEnds</span>
<span class="c1">--civ.scen.onGameEnds(function (reason) -&gt; boolean) -&gt; void</span>
<span class="c1">--</span>
<span class="c1">--Registers a function that is called when the game ends. `reason` is an integer between 1 and 6:</span>
<span class="c1">--1 and 2 - Space race victory. This does not trigger if `onCentauriArrival` has a callback registered.</span>
<span class="c1">--3 - Conquest victory</span>
<span class="c1">--4 - Defeat</span>
<span class="c1">--5 - Retirement</span>
<span class="c1">--6 - Macro ENDGAME action</span>
<span class="c1">--Return `true` to end the game, `false` to keep playing.</span>
<span class="c1">--</span>
<span class="k">function</span> <span class="nc">events</span><span class="p">.</span><span class="nf">onGameEnds</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">true</span>
<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">reason</code> is an integer with 6 possible values:</p>
<ol>
  <li>Space race victory achieved by the active player.  (Can’t happen if <code class="language-plaintext highlighter-rouge">civ.scen.onCentauriArrival</code> is registered.)</li>
  <li>Space race victory achieved by another player.  (Can’t happen if <code class="language-plaintext highlighter-rouge">civ.scen.onCentauriArrival</code> is registered.)</li>
  <li>Conquest Victory</li>
  <li>Defeat</li>
  <li>Retirement</li>
  <li><a href="auto_doc/civ.html#endGame">civ.endGame</a> was called.  (Or the Macro Language equivalent.)</li>
</ol>
<h5 id="eventsfilesongameendslua">
  
  
    <strong>EventsFiles\onGameEnds.lua</strong> <a href="#eventsfilesongameendslua"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- discreteEvents.onGameEnds and</span>
<span class="c1">-- consolidated.onGameEnds</span>
<span class="c1">-- also return booleans.  True means that the </span>
<span class="c1">-- game ends as normal, which is the default behaviour.</span>
<span class="c1">-- If any of the registered functions return false, then</span>
<span class="c1">-- the game doesn't end</span>
<span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onGameEnds</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">true</span>
<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">reason</code> is an integer with 6 possible values:</p>
<ol>
  <li>Space race victory achieved by the active player.  (Can’t happen if <code class="language-plaintext highlighter-rouge">civ.scen.onCentauriArrival</code> is registered.)</li>
  <li>Space race victory achieved by another player.  (Can’t happen if <code class="language-plaintext highlighter-rouge">civ.scen.onCentauriArrival</code> is registered.)</li>
  <li>Conquest Victory</li>
  <li>Defeat</li>
  <li>Retirement</li>
  <li><a href="auto_doc/civ.html#endGame">civ.endGame</a> was called.  (Or the Macro Language equivalent.)</li>
</ol>
<h5 id="discrete-events-8">
  
  
    <strong>Discrete Events</strong> <a href="#discrete-events-8"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete Game End event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- On Game Ends</span>
<span class="c1">-- Return true if the game ends as normal,</span>
<span class="c1">-- and false otherwise.</span>
<span class="c1">-- This is combined with the consolidated events and the</span>
<span class="c1">-- legacy events, as well as a separate onGameEnds.lua file</span>
<span class="c1">-- If any of these return false, then game end is prevented</span>
<span class="c1">-- Not documented or experimented with much</span>
<span class="c1">-- based on legacy event engine code, reason is an integer</span>
<span class="n">discreteEvents</span><span class="p">.</span><span class="n">onGameEnds</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span>
    <span class="c1">-- return false to stop the game from ending</span>
    <span class="k">return</span> <span class="kc">true</span>
<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">reason</code> is an integer with 6 possible values:</p>
<ol>
  <li>Space race victory achieved by the active player.  (Can’t happen if <code class="language-plaintext highlighter-rouge">civ.scen.onCentauriArrival</code> is registered.)</li>
  <li>Space race victory achieved by another player.  (Can’t happen if <code class="language-plaintext highlighter-rouge">civ.scen.onCentauriArrival</code> is registered.)</li>
  <li>Conquest Victory</li>
  <li>Defeat</li>
  <li>Retirement</li>
  <li><a href="auto_doc/civ.html#endGame">civ.endGame</a> was called.  (Or the Macro Language equivalent.)</li>
</ol>
<h4 id="implementation-10">
  
  
    Implementation <a href="#implementation-10"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<p>This execution point is provided by the Test of Time Patch Project function <code class="language-plaintext highlighter-rouge">civ.scen.onGameEnds</code>.</p>
<h3 id="combat-declared">
  
  
    <strong>Combat Declared</strong> <a href="#combat-declared"><span class="self-link">&#128279</span></a>
  
  
</h3>
    
<p>When combat is initiated, the function registered for this execution point is called, and returns an iterator (coroutine) which is called for every round of
combat.  Combat will end when the iterator stops returning values (or returns <code class="language-plaintext highlighter-rouge">nil</code>).</p>

<p>The scenario designer can either handle all the effects of combat manually for
a round of combat by telling the iterator to yield true, and the unit over which
the combat ‘explosion’ should be animated.  Alternatively, the coroutine can
return false, along with that round’s combat statistics, and the game’s combat
system will “roll the dice” and determine who should be damaged and where
the combat explosion should be animated.</p>
<h4 id="usage-10">
  
  
    Usage <a href="#usage-10"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<h5 id="mechanicsfilescombatsettingslua">
  
  
    <strong>MechanicsFiles/combatSettings.lua</strong> <a href="#mechanicsfilescombatsettingslua"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>In the <code class="language-plaintext highlighter-rouge">MechanicsFiles</code> folder, change the file called <code class="language-plaintext highlighter-rouge">combatSettings.lua</code>.  Change the function <code class="language-plaintext highlighter-rouge">register.onInitiateCombatMakeCoroutine</code> in order to change this event.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onInitiateCombatMakeCoroutine</span><span class="p">(</span><span class="n">attacker</span><span class="p">,</span><span class="n">defender</span><span class="p">,</span><span class="n">attackerDie</span><span class="p">,</span><span class="n">attackerPower</span><span class="p">,</span><span class="n">defenderDie</span><span class="p">,</span><span class="n">defenderPower</span><span class="p">,</span><span class="n">isSneakAttack</span><span class="p">)</span>

    <span class="n">leaderBonus</span><span class="p">.</span><span class="n">updateCommander</span><span class="p">(</span><span class="n">attacker</span><span class="p">)</span>
    <span class="n">leaderBonus</span><span class="p">.</span><span class="n">updateCommander</span><span class="p">(</span><span class="n">defender</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">maxCombatRounds</span> <span class="o">=</span> <span class="nb">math.huge</span> <span class="c1">-- If you want to limit combat to a specific number of</span>
                                        <span class="c1">-- turns, set this variable</span>

    <span class="kd">local</span> <span class="n">calculatedAttackerStrength</span><span class="p">,</span> 
            <span class="n">calculatedAttackerFirepower</span><span class="p">,</span>
            <span class="n">calculatedDefenderStrength</span><span class="p">,</span> 
            <span class="n">calculatedDefenderFirepower</span> <span class="o">=</span> <span class="n">computeCombatStatistics</span><span class="p">(</span><span class="n">attacker</span><span class="p">,</span><span class="n">defender</span><span class="p">,</span><span class="n">isSneakAttack</span><span class="p">)</span>
    <span class="c1">--if calculatedAttackerStrength ~= attackerDie then</span>
    <span class="c1">--    civ.ui.text("Attacker: calculated: "..calculatedAttackerStrength.." actual: "..attackerDie)</span>
    <span class="c1">--end</span>
    <span class="c1">--if calculatedDefenderStrength ~= defenderDie then</span>
    <span class="c1">--    civ.ui.text("Defender: calculated: "..calculatedDefenderStrength.." actual: "..defenderDie)</span>
    <span class="c1">--end</span>
    <span class="c1">--if calculatedAttackerFirepower ~= attackerPower then</span>
    <span class="c1">--    civ.ui.text("AttackerFP: calculated: "..calculatedAttackerFirepower.." actual: "..attackerPower)</span>
    <span class="c1">--end</span>
    <span class="c1">--if calculatedDefenderFirepower ~= defenderPower then</span>
    <span class="c1">--    civ.ui.text("DefenderFP: calculated: "..calculatedDefenderFirepower.." actual: "..defenderPower)</span>
    <span class="c1">--end</span>
    <span class="k">if</span> <span class="n">calculatedAttackerStrength</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">then</span>
        <span class="n">maxCombatRounds</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">attacker</span><span class="p">.</span><span class="n">owner</span><span class="p">.</span><span class="n">isHuman</span> <span class="k">then</span>
            <span class="n">text</span><span class="p">.</span><span class="n">simple</span><span class="p">(</span><span class="s2">"Our "</span><span class="o">..</span><span class="n">attacker</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">" unit can't fight the defending "</span><span class="o">..</span><span class="n">defender</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">".  The attack has been cancelled."</span><span class="p">,</span><span class="s2">"Defense Minister"</span><span class="p">)</span>
        <span class="k">end</span>
    <span class="k">end</span>
    <span class="c1">-- %Report Combat Strength%</span>
    <span class="c1">--civ.ui.text("Attacker: "..tostring(calculatedAttackerStrength/8).." FP:"..calculatedAttackerFirepower.." Defender: "..tostring(calculatedDefenderStrength/8).." FP:"..calculatedDefenderFirepower)</span>
            
    <span class="k">return</span> <span class="nb">coroutine.create</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
        <span class="kd">local</span> <span class="n">round</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span><span class="p">(</span><span class="n">round</span> <span class="o">&lt;</span> <span class="n">maxCombatRounds</span> <span class="ow">and</span> <span class="n">attacker</span><span class="p">.</span><span class="n">hitpoints</span> <span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">defender</span><span class="p">.</span><span class="n">hitpoints</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">do</span>

            <span class="k">if</span> <span class="kc">false</span> <span class="k">then</span>
                <span class="c1">-- If the coroutine yields true as its first value, </span>
                <span class="c1">-- the game's default combat resolution is skipped for that round </span>
                <span class="c1">-- and the designer is responsible for updating damage. </span>
                <span class="c1">-- The second value yielded is either the attacker or the defender, </span>
                <span class="c1">-- this is used to render animations etc. </span>
                <span class="c1">-- In this case the coroutine resumes without any values.</span>

                <span class="nb">coroutine.yield</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span><span class="n">defender</span><span class="p">)</span>
            <span class="k">else</span>

                <span class="c1">--If the coroutine yields false as its first value, </span>
                <span class="c1">--the game runs its default combat algorithm. The designer </span>
                <span class="c1">--can additionally yield modified values for attackerDie, </span>
                <span class="c1">--attackerPower, defenderDie and defenderPower (in this order) </span>
                <span class="c1">--which will be used by the game for that round.</span>

                <span class="kd">local</span> <span class="n">newAttackerDie</span> <span class="o">=</span> <span class="n">calculatedAttackerStrength</span>
                <span class="kd">local</span> <span class="n">newAttackerFirepower</span> <span class="o">=</span> <span class="n">calculatedAttackerFirepower</span>
                <span class="kd">local</span> <span class="n">newDefenderDie</span> <span class="o">=</span> <span class="n">calculatedDefenderStrength</span>
                <span class="kd">local</span> <span class="n">newDefenderFirepower</span> <span class="o">=</span> <span class="n">calculatedDefenderFirepower</span>
                <span class="kd">local</span> <span class="n">result</span> <span class="o">=</span> <span class="nb">coroutine.yield</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span><span class="n">newAttackerDie</span><span class="p">,</span><span class="n">newAttackerFirepower</span><span class="p">,</span><span class="n">newDefenderDie</span><span class="p">,</span><span class="n">newDefenderFirepower</span><span class="p">)</span>

                <span class="c1">--In this case the coroutine resumes with the result of the round, </span>
                <span class="c1">--a table containing four values:</span>
                    <span class="c1">-- winner, this is either attacker or defender.</span>
                    <span class="c1">-- attackerRoll, the result of the attacker's die roll</span>
                    <span class="c1">-- defenderRoll, the result of the defender's die roll</span>
                    <span class="c1">-- reroll, true if a reroll happened. This can happen only </span>
                         <span class="c1">-- if the attacker is tribe 0, the defender is a unit </span>
                         <span class="c1">-- guarding a city, and the city is the capital or </span>
                         <span class="c1">-- the tribe has less than 8 cities in total and </span>
                         <span class="c1">-- the attacker's die roll is higher than the </span>
                         <span class="c1">-- defender's. A reroll can happen at most once.</span>


            <span class="k">end</span>
            <span class="n">round</span> <span class="o">=</span> <span class="n">round</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">end</span>
        <span class="c1">-- once we get here, combat stops</span>
    <span class="k">end</span><span class="p">)</span>
<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">attacker</code> is the unit which is attacking.</p>

<p>The <code class="language-plaintext highlighter-rouge">defender</code> is the unit which is being attacked.</p>

<p>The <code class="language-plaintext highlighter-rouge">attackerDie</code> is the the game’s standard calculation for the attack value of the attacker.</p>

<p>The <code class="language-plaintext highlighter-rouge">attackerPower</code> is the attackers firepower, as determined by the game’s standard calculations.</p>

<p>The <code class="language-plaintext highlighter-rouge">defenderDie</code> is the the game’s standard calculation for the defense value of the defender.</p>

<p>The <code class="language-plaintext highlighter-rouge">defenderPower</code> is the defenders firepower, as determined by the game’s standard calculations.</p>

<p>The <code class="language-plaintext highlighter-rouge">isSneakAttack</code> parameter is true if a “sneak attack” is in progress. That is, If the attacker is conducting a sneak attack (i.e., breaking a Cease Fire or Peace Treaty) and the defender belongs to a tribe controlled by a human player, the attacker receives a x2 adjustment (bonus).</p>

<p>A round of combat can be thought of as the attacker rolling an attackerDie-sided die, and the defender rolling a defenderDie-sided die.  The attacker’s roll is compared to the defender’s roll, and the higher number wins
that round of combat (if the rolls are equal, the defender wins).  The loser</p>

<p>This function and the iterator returned can be heavily modified depending on how the scenario designer wants combat to happen.  What follows describes 
are notes on the default behaviour.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">leaderBonus</span><span class="p">.</span><span class="n">updateCommander</span><span class="p">(</span><span class="n">attacker</span><span class="p">)</span>
    <span class="n">leaderBonus</span><span class="p">.</span><span class="n">updateCommander</span><span class="p">(</span><span class="n">defender</span><span class="p">)</span>
</code></pre></div></div>
<p>Here, the Leader Bonus Module confirms that the units have the correct leader.  (If you’re not using the Leader Bonus Module, then this doesn’t matter.)</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kd">local</span> <span class="n">maxCombatRounds</span> <span class="o">=</span> <span class="nb">math.huge</span> <span class="c1">-- If you want to limit combat to a specific number of</span>
                                        <span class="c1">-- turns, set this variable</span>
</code></pre></div></div>

<p>This variable is used to limit the number of rounds of combat.  If you want to limit combat to a specific number of turns, set this variable.  Otherwise, it will be set to infinity (in which case, hp reduction will end combat).</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kd">local</span> <span class="n">calculatedAttackerStrength</span><span class="p">,</span> 
            <span class="n">calculatedAttackerFirepower</span><span class="p">,</span>
            <span class="n">calculatedDefenderStrength</span><span class="p">,</span> 
            <span class="n">calculatedDefenderFirepower</span> <span class="o">=</span> <span class="n">computeCombatStatistics</span><span class="p">(</span><span class="n">attacker</span><span class="p">,</span><span class="n">defender</span><span class="p">,</span><span class="n">isSneakAttack</span><span class="p">)</span>
</code></pre></div></div>

<p>Instead of relying on the game’s standard calculations of combat strength,
this code uses the function <code class="language-plaintext highlighter-rouge">computeCombatStatistics</code> (found earlier in the same file) to calculate the
statistics.  By default, this function takes account of combat changes
defined in other modules (such as the Combat Modifiers Module) and
combines them with <a href="https://forums.civfanatics.com/threads/civilization-ii-combat-guide-v2-0-updates.673992/">Knighttime’s combat calculation code</a>.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">if</span> <span class="n">calculatedAttackerStrength</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">then</span>
        <span class="n">maxCombatRounds</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">attacker</span><span class="p">.</span><span class="n">owner</span><span class="p">.</span><span class="n">isHuman</span> <span class="k">then</span>
            <span class="n">text</span><span class="p">.</span><span class="n">simple</span><span class="p">(</span><span class="s2">"Our "</span><span class="o">..</span><span class="n">attacker</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">" unit can't fight the defending "</span><span class="o">..</span><span class="n">defender</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">".  The attack has been cancelled."</span><span class="p">,</span><span class="s2">"Defense Minister"</span><span class="p">)</span>
        <span class="k">end</span>
    <span class="k">end</span>
</code></pre></div></div>

<p>In the standard Civilization II game, units with 0 attack are unable to initiate combat.  However, it may be that the <code class="language-plaintext highlighter-rouge">computeCombatStatistics</code>
gives a unit 0 attack, even though the unit type normally can make attacks (for example, if a unit is ineffective against a particular defender).  In this case, the code sets the maximum number of combat rounds to 0, thereby stopping the attack, and displays a message to the human player.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1">-- %Report Combat Strength%</span>
    <span class="c1">--civ.ui.text("Attacker: "..tostring(calculatedAttackerStrength/8).." FP:"..calculatedAttackerFirepower.." Defender: "..tostring(calculatedDefenderStrength/8).." FP:"..calculatedDefenderFirepower)</span>
</code></pre></div></div>

<p>Comment out this line if you don’t want a text box to display the combat statistics.  Having this active during development is likely to be useful,
but you will probably want to do something fancier if you intend to display
combat statistics in your final release.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">while</span><span class="p">(</span><span class="n">round</span> <span class="o">&lt;</span> <span class="n">maxCombatRounds</span> <span class="ow">and</span> <span class="n">attacker</span><span class="p">.</span><span class="n">hitpoints</span> <span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">defender</span><span class="p">.</span><span class="n">hitpoints</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">do</span>
</code></pre></div></div>

<p>This is the main loop of the combat.  Combat will continue until the maximum number of combat rounds is reached, or until one of the units is killed.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">if</span> <span class="kc">false</span> <span class="k">then</span>
        <span class="c1">-- If the coroutine yields true as its first value, </span>
        <span class="c1">-- the game's default combat resolution is skipped for that round </span>
        <span class="c1">-- and the designer is responsible for updating damage. </span>
        <span class="c1">-- The second value yielded is either the attacker or the defender, </span>
        <span class="c1">-- this is used to render animations etc. </span>
        <span class="c1">-- In this case the coroutine resumes without any values.</span>

        <span class="nb">coroutine.yield</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span><span class="n">defender</span><span class="p">)</span>
</code></pre></div></div>

<p>By default, the combat iterator won’t return true.  If the coroutine yields true as its first value, the game’s default combat resolution is skipped for that round and the designer is responsible for updating damage.  The second value yielded is either the attacker or the defender, this is used to render animations etc.  In this case the coroutine resumes without any values.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1">--If the coroutine yields false as its first value, </span>
    <span class="c1">--the game runs its default combat algorithm. The designer </span>
    <span class="c1">--can additionally yield modified values for attackerDie, </span>
    <span class="c1">--attackerPower, defenderDie and defenderPower (in this order) </span>
    <span class="c1">--which will be used by the game for that round.</span>

    <span class="kd">local</span> <span class="n">newAttackerDie</span> <span class="o">=</span> <span class="n">calculatedAttackerStrength</span>
    <span class="kd">local</span> <span class="n">newAttackerFirepower</span> <span class="o">=</span> <span class="n">calculatedAttackerFirepower</span>
    <span class="kd">local</span> <span class="n">newDefenderDie</span> <span class="o">=</span> <span class="n">calculatedDefenderStrength</span>
    <span class="kd">local</span> <span class="n">newDefenderFirepower</span> <span class="o">=</span> <span class="n">calculatedDefenderFirepower</span>
    <span class="kd">local</span> <span class="n">result</span> <span class="o">=</span> <span class="nb">coroutine.yield</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span><span class="n">newAttackerDie</span><span class="p">,</span><span class="n">newAttackerFirepower</span><span class="p">,</span><span class="n">newDefenderDie</span><span class="p">,</span><span class="n">newDefenderFirepower</span><span class="p">)</span>

    <span class="c1">--In this case the coroutine resumes with the result of the round, </span>
    <span class="c1">--a table containing four values:</span>
        <span class="c1">-- winner, this is either attacker or defender.</span>
        <span class="c1">-- attackerRoll, the result of the attacker's die roll</span>
        <span class="c1">-- defenderRoll, the result of the defender's die roll</span>
        <span class="c1">-- reroll, true if a reroll happened. This can happen only </span>
             <span class="c1">-- if the attacker is tribe 0, the defender is a unit </span>
             <span class="c1">-- guarding a city, and the city is the capital or </span>
             <span class="c1">-- the tribe has less than 8 cities in total and </span>
             <span class="c1">-- the attacker's die roll is higher than the </span>
             <span class="c1">-- defender's. A reroll can happen at most once.</span>
</code></pre></div></div>

<p>By default, the combat iterator will yield false as its first value.  The game
will run standard combat calculations based on the values assigned to
<code class="language-plaintext highlighter-rouge">newAttackerDie</code>, <code class="language-plaintext highlighter-rouge">newAttackerFirepower</code>, <code class="language-plaintext highlighter-rouge">newDefenderDie</code> and <code class="language-plaintext highlighter-rouge">newDefenderFirepower</code>.  Change these from their calculated values if
you want to change combat effectiveness based on events that happen during combat.</p>

<p>The <code class="language-plaintext highlighter-rouge">result</code> variable will contain the result of the round, a table containing four values assigned to the keys <code class="language-plaintext highlighter-rouge">winner</code>, <code class="language-plaintext highlighter-rouge">attackerRoll</code>, <code class="language-plaintext highlighter-rouge">defenderRoll</code> and <code class="language-plaintext highlighter-rouge">reroll</code>.  <code class="language-plaintext highlighter-rouge">winner</code> will be either <code class="language-plaintext highlighter-rouge">attacker</code> or <code class="language-plaintext highlighter-rouge">defender</code>.  <code class="language-plaintext highlighter-rouge">attackerRoll</code> and <code class="language-plaintext highlighter-rouge">defenderRoll</code> will be the results of the die rolls.  <code class="language-plaintext highlighter-rouge">reroll</code> will be <code class="language-plaintext highlighter-rouge">true</code> if a reroll happened. This can happen only if the attacker is tribe 0, the defender is a unit guarding a city, and the city is the capital or the tribe has less than 8 cities in total and the attacker’s die roll is higher than the defender’s. A reroll can happen at most once.</p>
<h4 id="implementation-11">
  
  
    Implementation <a href="#implementation-11"><span class="self-link">&#128279</span></a>
  
  
</h4>
    

<p>This execution point is implemented using the TOTPP function <code class="language-plaintext highlighter-rouge">civ.scen.onInitiateCombat</code>.</p>
<h3 id="key-press">
  
  
    <strong>Key Press</strong> <a href="#key-press"><span class="self-link">&#128279</span></a>
  
  
</h3>
    

<p>The Key Press execution point is triggered every time a key is pressed.  A code for the key that
was pressed is passed to the registered function.  The <a href="auto_doc/keyboard.html">keyboard module</a> provides a table of codes with human readable index values.</p>

<p>Many key press events are registered in the file <code class="language-plaintext highlighter-rouge">MechanicsFiles\keyPressSettings.lua</code>.</p>
<h4 id="usage-11">
  
  
    Usage <a href="#usage-11"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<h5 id="consolidatedeventslua-8">
  
  
    <strong>consolidatedEvents.lua</strong> <a href="#consolidatedeventslua-8"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- On key press</span>
<span class="k">function</span> <span class="nc">events</span><span class="p">.</span><span class="nf">onKeyPress</span><span class="p">(</span><span class="n">keyCode</span><span class="p">)</span>
    <span class="c1">--if keyCode == keyboard.backspace then</span>
    <span class="c1">--    civ.ui.text("backspace pressed")</span>
    <span class="c1">--end</span>

<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">keyCode</code> parameter is an integer corresponding to a keyboard key.</p>
<h5 id="eventsfilesonkeypresslua">
  
  
    <strong>EventsFiles\onKeyPress.lua</strong> <a href="#eventsfilesonkeypresslua"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onKeyPress</span><span class="p">(</span><span class="n">keyCode</span><span class="p">)</span>
    <span class="c1">--civ.ui.text("key press test separate file")</span>
<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">keyCode</code> parameter is an integer corresponding to a keyboard key.</p>
<h5 id="discrete-events-9">
  
  
    <strong>Discrete Events</strong> <a href="#discrete-events-9"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete Key Press event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- The keyCode is an integer that corresponds to a particular key on the keyboard.</span>
<span class="c1">-- The keyboard module provides names for these codes.</span>
<span class="n">discreteEvents</span><span class="p">.</span><span class="n">onKeyPress</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">keyCode</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="ow">and</span> <span class="n">keyboard</span><span class="p">.</span><span class="n">backspace</span> <span class="o">==</span> <span class="n">keyCode</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"discreteEvents.onKeyPress: The backspace key has been pressed."</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">keyCode</code> parameter is an integer corresponding to a keyboard key.</p>
<h4 id="implementation-12">
  
  
    Implementation <a href="#implementation-12"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<p>This execution point is provided by the Test of Time Patch Project function <code class="language-plaintext highlighter-rouge">civ.scen.onKeyPress</code>.</p>
<h3 id="game-loaded">
  
  
    <strong>Game Loaded</strong> <a href="#game-loaded"><span class="self-link">&#128279</span></a>
  
  
</h3>
    

<p>The Game Loaded execution point is triggered when a game is loaded from a saved game file.  This happens after the <code class="language-plaintext highlighter-rouge">events.lua</code> file is executed, and before the Scenario Loaded execution point is triggered.  The main purpose of this execution point is to read data which has been added to the saved game file by the Game Saved execution point, and convert it back to a table (known as the “state table”, so that Lua events can have custom data saved between sessions.</p>
<h4 id="usage-12">
  
  
    Usage <a href="#usage-12"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<h5 id="eventslua">
  
  
    <strong>events.lua</strong> <a href="#eventslua"><span class="self-link">&#128279</span></a>
  
  
</h5>
    

<p>The Game Loaded execution point is not meant to be used by scenario designers.  The Scenario Loaded execution point is preferred.  That is why it is only accessible through the <code class="language-plaintext highlighter-rouge">events.lua</code> file.  However, if you need to change it for some reason, you should change ths
code within that file:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="k">function</span> <span class="nf">doOnLoad</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span><span class="c1">--&gt;void</span>
    <span class="c1">-- if buffer is compressed, it is decompressed, otherwise the</span>
    <span class="c1">-- buffer itself is used</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">civlua</span><span class="p">.</span><span class="n">unserialize</span><span class="p">(</span><span class="n">lualzw</span><span class="p">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="ow">or</span> <span class="n">buffer</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">stateTableKeys</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">discreteEvents</span><span class="p">.</span><span class="n">performLinkStateToModules</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="n">stateTableKeys</span><span class="p">)</span>
    <span class="c1">--linkStateTableToModules()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Enter console.commands() to see a list of keys in the console table.  Some give access to functions in modules, others will run event code."</span><span class="p">)</span>
<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">buffer</code> is a string, which will be converted back into the state
table using <code class="language-plaintext highlighter-rouge">civlua.unserialize</code>.  This template uses the lualzw module
to compress the data, so it is decompressed here as well.  (If the data isn’t
compressed, <code class="language-plaintext highlighter-rouge">lualzw.decompress</code> returns <code class="language-plaintext highlighter-rouge">nil</code>, so the raw string is used instead.)</p>
<h5 id="discrete-events-10">
  
  
    <strong>Discrete Events</strong> <a href="#discrete-events-10"><span class="self-link">&#128279</span></a>
  
  
</h5>
    

<p>The Discrete Events module allows access to the Game Loaded execution point.  This
is so that scenario modules can save data between sessions, by linking to the
state table.  The state table is a table which is saved to the saved game file.</p>

<p>Here is an example of how to use <code class="language-plaintext highlighter-rouge">discreteEvents.linkStateToModules</code> to provide access to the state table within a module.  This code is from the <code class="language-plaintext highlighter-rouge">LuaCore
avy.lua</code> file:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">):</span><span class="n">minVersion</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<p>This module needs to keep track of whether a ship can unload, because there are
circumstances where a unit has the ability to unload for the rest of the turn,
even though the function determining if the unit can unload would no longer 
return true.  Since we want this to persist between saving and loading, we
must use the state table.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">canUnload</span> <span class="o">=</span> <span class="s2">"state not linked"</span>
<span class="c1">-- canUnload[unit.id] = tileID or nil</span>
<span class="c1">-- a unit in this table can unload itself or carried units even</span>
<span class="c1">-- if it otherwise wouldn't be able to, as long</span>
<span class="c1">-- as it is still on the tile specified</span>
</code></pre></div></div>

<p>Here, the variable <code class="language-plaintext highlighter-rouge">canUnload</code> is defined.  At the moment, it is a string,
but during the Game Loaded execution point, the variable’s value will be
changed to one of the tables in the state table.  So, any functions
in this module can treat this variable as a table, as long as they are not
called until after the Game Loaded execution point has passed.</p>

<p>We need to write a “link state” function to associate the variable with the
an appropriate table in the state table.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nc">navy</span><span class="p">.</span><span class="nf">linkState</span><span class="p">(</span><span class="n">canUnloadTableFromState</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">canUnloadTableFromState</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"table"</span> <span class="k">then</span>
        <span class="n">canUnload</span> <span class="o">=</span> <span class="n">canUnloadTableFromState</span>
    <span class="k">else</span>
        <span class="nb">error</span><span class="p">(</span><span class="s2">"navy.linkState: table expected as argument.  Received: "</span><span class="o">..</span><span class="nb">tostring</span><span class="p">(</span><span class="n">canUnloadTableFromState</span><span class="p">))</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>When called, this function assigns the <code class="language-plaintext highlighter-rouge">canUnloadTableFromState</code> as the value
for the canUnload variable.  An error is generated if it isn’t an actual table.</p>

<p>Next, we register an event using <code class="language-plaintext highlighter-rouge">discreteEvents.linkStateToModules</code>:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">discreteEvents</span><span class="p">.</span><span class="n">linkStateToModules</span><span class="p">(</span> <span class="k">function</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="n">stateTableKeys</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">keyName</span> <span class="o">=</span> <span class="s2">"navyModuleState"</span>
    <span class="k">if</span> <span class="n">stateTableKeys</span><span class="p">[</span><span class="n">keyName</span><span class="p">]</span> <span class="k">then</span>
        <span class="nb">error</span><span class="p">(</span><span class="s1">'"'</span><span class="o">..</span><span class="n">keyName</span><span class="o">..</span><span class="s1">'" is used as a key for the state table on at least two occasions.'</span><span class="p">)</span>
    <span class="k">else</span>
        <span class="n">stateTableKeys</span><span class="p">[</span><span class="n">keyName</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="k">end</span>
    <span class="c1">-- link the state table to the module</span>
    <span class="n">state</span><span class="p">[</span><span class="n">keyName</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="n">keyName</span><span class="p">]</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="n">navy</span><span class="p">.</span><span class="n">linkState</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="n">keyName</span><span class="p">])</span>
<span class="k">end</span><span class="p">)</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">discreteEvents.linkStateToModules</code> event provides the entire state table as the first argument, and a table containing the names of all the keys in the state table as the second argument (in the form stateTableKeys[keyName] = true).</p>

<p>In this function, we decide that the table for this module will have the key
“navyModuleState” in the overall state table.  Next, we check to see if that
key is already in use.  If it is, we generate an error.  If it isn’t, we add
it to the list of keys in use.</p>

<p>Next, we make sure that the table for this module exists in the state table.
If it doesn’t, we create an empty table for it.  Finally, we call the <code class="language-plaintext highlighter-rouge">navy.linkState</code> function defined earlier, passing the table for this module as the argument.</p>
<h4 id="implementation-13">
  
  
    Implementation <a href="#implementation-13"><span class="self-link">&#128279</span></a>
  
  
</h4>
    

<p>This execution point is implemented using the TOTPP function <code class="language-plaintext highlighter-rouge">civ.scen.onLoad</code>.</p>
<h3 id="game-saved">
  
  
    <strong>Game Saved</strong> <a href="#game-saved"><span class="self-link">&#128279</span></a>
  
  
</h3>
    

<p>The Game Saved execution point is triggered when a game is saved to a
file.  As part of this process, the state table is converted to a string
and saved to the file.    The Game Loaded execution point
converts the string back into a table, once the game is loaded.</p>

<p>Strictly speaking, any string could be saved to
the end of the file, but the Lua Scenario Template saves the state table and
I know of no scenarios where something other than
a string conversion of the state table is saved.</p>

<p>In the Lua Scenario Template, the saved string is compressed using the
lualzw module.  This is done to reduce the size of the saved game file.</p>
<h4 id="usage-13">
  
  
    Usage <a href="#usage-13"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<h5 id="eventslua-1">
  
  
    <strong>events.lua</strong> <a href="#eventslua-1"><span class="self-link">&#128279</span></a>
  
  
</h5>
    

<p>If you need to change the string that is saved to the file, you must
change this code within the <code class="language-plaintext highlighter-rouge">events.lua</code> file:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="k">function</span> <span class="nf">doOnSave</span><span class="p">()</span> <span class="c1">--&gt; string</span>
    <span class="n">discreteEvents</span><span class="p">.</span><span class="n">performOnSave</span><span class="p">()</span>
    <span class="c1">-- compress the text representation of the state table, so saved game files are smaller</span>
    <span class="k">return</span> <span class="n">lualzw</span><span class="p">.</span><span class="n">compress</span><span class="p">(</span><span class="n">civlua</span><span class="p">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
<span class="k">end</span>

</code></pre></div></div>

<p>This will probably never be necessary, since you can simply add some
extra information as an entry in the state table.  Accessing this
execution point through using the Discrete Events module does not
let you change the string that is saved to the file.</p>
<h5 id="discrete-events-11">
  
  
    <strong>Discrete Events</strong> <a href="#discrete-events-11"><span class="self-link">&#128279</span></a>
  
  
</h5>
    

<p>The Discrete Events module allows access to the Game Saved execution point 
by registering code using the function <code class="language-plaintext highlighter-rouge">discreteEvents.onSave</code>.  The
registered function receives no arguments.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">discreteEvents</span><span class="p">.</span><span class="n">onSave</span><span class="p">(</span> <span class="k">function</span><span class="p">()</span>
    <span class="c1">-- code to execute when the game is saved</span>
<span class="k">end</span><span class="p">)</span>
</code></pre></div></div>
<h4 id="implementation-14">
  
  
    Implementation <a href="#implementation-14"><span class="self-link">&#128279</span></a>
  
  
</h4>
    

<p>This execution point is implemented using the TOTPP function <code class="language-plaintext highlighter-rouge">civ.scen.onSave</code>.</p>
<h3 id="scenario-loaded">
  
  
    <strong>Scenario Loaded</strong> <a href="#scenario-loaded"><span class="self-link">&#128279</span></a>
  
  
</h3>
    

<p>The Scenario Loaded execution point is triggered when the game is loaded, but before anything else happens.  Despite its name, it is not triggered solely by starting a new scenario.  It is also triggered when a save file is loaded.</p>

<p>The Scenario Loaded execution point is triggered after the Game Loaded execution point.</p>
<h4 id="usage-14">
  
  
    Usage <a href="#usage-14"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<h5 id="consolidatedeventslua-9">
  
  
    <strong>consolidatedEvents.lua</strong> <a href="#consolidatedeventslua-9"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- On Scenario Loaded</span>
<span class="k">function</span> <span class="nc">events</span><span class="p">.</span><span class="nf">onScenarioLoaded</span><span class="p">()</span>
    <span class="c1">--civ.ui.text("Scenario Loaded consolidated event")</span>

<span class="k">end</span>

</code></pre></div></div>
<h5 id="eventsfilesonscenarioloadedlua">
  
  
    <strong>EventsFiles\onScenarioLoaded.lua</strong> <a href="#eventsfilesonscenarioloadedlua"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onScenarioLoaded</span><span class="p">()</span>
    <span class="c1">--civ.ui.text("on scenario loaded separate event file")</span>

<span class="k">end</span>

</code></pre></div></div>
<h5 id="discrete-events-12">
  
  
    <strong>Discrete Events</strong> <a href="#discrete-events-12"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete Scenario Loaded event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">discreteEvents</span><span class="p">.</span><span class="n">onScenarioLoaded</span><span class="p">(</span><span class="k">function</span><span class="p">()</span> 
    <span class="c1">--civ.ui.text("discrete event on scenario loaded")</span>

<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>
<h4 id="implementation-15">
  
  
    Implementation <a href="#implementation-15"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<p>This execution point is provided by the Test of Time Patch Project function <code class="language-plaintext highlighter-rouge">civ.scen.onScenarioLoaded</code>.</p>
<h3 id="negotiation">
  
  
    <strong>Negotiation</strong> <a href="#negotiation"><span class="self-link">&#128279</span></a>
  
  
</h3>
    

<p>This execution point is triggered when a tribe (the <code class="language-plaintext highlighter-rouge">talker</code>) attempts
to negotiate with a different tribe (the <code class="language-plaintext highlighter-rouge">listener</code>).  If the registered
function returns <code class="language-plaintext highlighter-rouge">true</code>, the tribes can talk.  If <code class="language-plaintext highlighter-rouge">false</code>,
they can’t (and won’t appear in the foreign minister menu).</p>

<p>The Lua Scenario Template offers multiple ways to register functions
for this execution point.  If any of them return false, then negotiation
between the two parties is disabled.</p>
<h4 id="usage-15">
  
  
    Usage <a href="#usage-15"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<h5 id="consolidatedeventslua-10">
  
  
    <strong>consolidatedEvents.lua</strong> <a href="#consolidatedeventslua-10"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- On Negotiation </span>
<span class="c1">-- Return true if the talker can contact the listener,</span>
<span class="c1">-- and false otherwise.</span>
<span class="c1">-- This is combined with the discrete events and the</span>
<span class="c1">-- legacy events, as well as a separate onNegotiation.lua file</span>
<span class="c1">-- If any of these return false, then negotiation is prevented</span>
<span class="k">function</span> <span class="nc">events</span><span class="p">.</span><span class="nf">onNegotiation</span><span class="p">(</span><span class="n">talker</span><span class="p">,</span><span class="n">listener</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">true</span>
<span class="k">end</span>

</code></pre></div></div>
<h5 id="eventsfilesonnegotiationlua">
  
  
    <strong>EventsFiles\onNegotiation.lua</strong> <a href="#eventsfilesonnegotiationlua"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- discreteEvents.onNegotiation and</span>
<span class="c1">-- consolidated.onNegotiation</span>
<span class="c1">-- also return booleans.  True means that the talker</span>
<span class="c1">-- can begin negotiations with the listener.</span>
<span class="c1">-- If any of the events return false, negotiations are</span>
<span class="c1">-- prevented, even if other negotiation events return true</span>
<span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onNegotiation</span><span class="p">(</span><span class="n">talker</span><span class="p">,</span><span class="n">listener</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">true</span>
<span class="k">end</span>

</code></pre></div></div>
<h5 id="discrete-events-13">
  
  
    <strong>Discrete Events</strong> <a href="#discrete-events-13"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete Negotiation event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- On Negotiation </span>
<span class="c1">-- Return true if the talker can contact the listener,</span>
<span class="c1">-- and false otherwise.</span>
<span class="c1">-- This is combined with the consolidated events and the</span>
<span class="c1">-- legacy events, as well as a separate onNegotiation.lua file</span>
<span class="c1">-- If any of these return false, then negotiation is prevented</span>
<span class="n">discreteEvents</span><span class="p">.</span><span class="n">onNegotiation</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">talker</span><span class="p">,</span><span class="n">listener</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">true</span>
<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>
<h4 id="implementation-16">
  
  
    Implementation <a href="#implementation-16"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<p>This execution point is provided by the Test of Time Patch Project function <code class="language-plaintext highlighter-rouge">civ.scen.onNegotiation</code>.</p>
<h3 id="tribe-schism">
  
  
    <strong>Tribe Schism</strong> <a href="#tribe-schism"><span class="self-link">&#128279</span></a>
  
  
</h3>
    

<p>The code from this execution point is executed when a <code class="language-plaintext highlighter-rouge">tribe</code> could be split
because its capital is taken.  The event will trigger even if there is no
free civ slot for the rebel tribe to occupy, but will not occur
if a schism is not possible because of other schism mechanics.</p>

<p>If the registered function returns <code class="language-plaintext highlighter-rouge">true</code>, then the schism is allowed
(as long as there is an empty tribe slot).  If <code class="language-plaintext highlighter-rouge">false</code> is returned, 
then schism is prevented.</p>

<p>The Lua Scenario Template offers multiple ways to register functions
for this execution point.  If any of them return false, then schism
is prevented in this instance.</p>

<p>I think (but don’t know for sure) that the requirements for a schism
are that:</p>
<ol>
  <li>The tribe capturing the capital must have a weaker power rating than the defending tribe.</li>
  <li>The defending tribe must be controlled by an AI.</li>
</ol>
<h4 id="usage-16">
  
  
    Usage <a href="#usage-16"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<h5 id="consolidatedeventslua-11">
  
  
    <strong>consolidatedEvents.lua</strong> <a href="#consolidatedeventslua-11"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- On Schism </span>
<span class="c1">-- Return true (default) if the tribe can schism,</span>
<span class="c1">-- and false otherwise.</span>
<span class="c1">-- This is combined with the discrete events and the</span>
<span class="c1">-- legacy events, as well as a separate onSchism.lua file</span>
<span class="c1">-- If any of these return false, then schism is prevented</span>
<span class="k">function</span> <span class="nc">events</span><span class="p">.</span><span class="nf">onSchism</span><span class="p">(</span><span class="n">tribe</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">true</span>
<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">tribe</code> is the tribe that just lost its capital and will undergo schism if there is an available tribe slot (unless this
event prevents it).</p>
<h5 id="eventsfilesonschismlua">
  
  
    <strong>EventsFiles\onSchism.lua</strong> <a href="#eventsfilesonschismlua"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- discreteEvents.onSchism and</span>
<span class="c1">-- consolidated.onSchism</span>
<span class="c1">-- also return booleans.  True means that the tribe can schism</span>
<span class="c1">-- (default behaviour).</span>
<span class="c1">-- If any of the events return false, schism is </span>
<span class="c1">-- prevented, even if other schism events return true</span>
<span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onSchism</span><span class="p">(</span><span class="n">tribe</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">true</span>
<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">tribe</code> is the tribe that just lost its capital and will undergo schism if there is an available tribe slot (unless this
event prevents it).</p>
<h5 id="discrete-events-14">
  
  
    <strong>Discrete Events</strong> <a href="#discrete-events-14"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete Tribe Schism event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- On Schism </span>
<span class="c1">-- Return true (default) if the tribe can schism,</span>
<span class="c1">-- and false otherwise.</span>
<span class="c1">-- This is combined with the consolidated events and the</span>
<span class="c1">-- legacy events, as well as a separate onSchism.lua file</span>
<span class="c1">-- If any of these return false, then schism is prevented</span>
<span class="n">discreteEvents</span><span class="p">.</span><span class="n">onSchism</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">tribe</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">true</span>
<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">tribe</code> is the tribe that just lost its capital and will undergo schism if there is an available tribe slot (unless this
event prevents it).</p>
<h4 id="implementation-17">
  
  
    Implementation <a href="#implementation-17"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<p>This execution point is provided by the Test of Time Patch Project function <code class="language-plaintext highlighter-rouge">civ.scen.onSchism</code>.</p>
<h3 id="between-turns">
  
  
    <strong>Between Turns</strong> <a href="#between-turns"><span class="self-link">&#128279</span></a>
  
  
</h3>
    
<p>This execution point occurs at the very beginning of a game turn, before the Barbarian tribe begins its movement.</p>
<h4 id="usage-17">
  
  
    Usage <a href="#usage-17"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<h5 id="consolidatedeventslua-12">
  
  
    <strong>consolidatedEvents.lua</strong> <a href="#consolidatedeventslua-12"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Between Turns</span>
<span class="k">function</span> <span class="nc">events</span><span class="p">.</span><span class="nf">onTurn</span><span class="p">(</span><span class="n">turn</span><span class="p">)</span>
    <span class="c1">--civ.ui.text("The turn is "..tostring(turn)..".")</span>

<span class="k">end</span>

</code></pre></div></div>
<h5 id="eventsfilesonturnlua">
  
  
    <strong>EventsFiles\onTurn.lua</strong> <a href="#eventsfilesonturnlua"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nc">onTurn</span><span class="p">.</span><span class="nf">onTurn</span><span class="p">(</span><span class="n">turn</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"on turn test separate file"</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>

</code></pre></div></div>
<h5 id="discrete-events-15">
  
  
    <strong>Discrete Events</strong> <a href="#discrete-events-15"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete Between Turns event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">discreteEvents</span><span class="p">.</span><span class="n">onTurn</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">turn</span><span class="p">)</span> 
    <span class="c1">--civ.ui.text("discrete on turn event 1")</span>
<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>
<h4 id="implementation-18">
  
  
    Implementation <a href="#implementation-18"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<p>This execution point is provided by the Test of Time Patch Project function <code class="language-plaintext highlighter-rouge">civ.scen.onTurn</code>.</p>
<h3 id="unit-killed-in-combat">
  
  
    <strong>Unit Killed In Combat</strong> <a href="#unit-killed-in-combat"><span class="self-link">&#128279</span></a>
  
  
</h3>
    
<p>This execution point is triggered when a unit is killed as a result of standard Civ II combat.  It is not triggered if a unit is killed by the <a href="/auto_doc/gen.html#defeatunit">gen.defeatUnit</a> function.  The <a href="#unit-defeated">Unit Defeated</a> execution point triggers for both standard combat defeat and event driven defeat.</p>
<h4 id="usage-18">
  
  
    Usage <a href="#usage-18"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<h5 id="consolidatedeventslua-13">
  
  
    <strong>consolidatedEvents.lua</strong> <a href="#consolidatedeventslua-13"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- On unit killed in combat</span>
<span class="k">function</span> <span class="nc">events</span><span class="p">.</span><span class="nf">onUnitKilled</span><span class="p">(</span><span class="n">loser</span><span class="p">,</span><span class="n">winner</span><span class="p">,</span><span class="n">aggressor</span><span class="p">,</span><span class="n">victim</span><span class="p">,</span><span class="n">loserLocation</span><span class="p">,</span><span class="n">winnerVetStatus</span><span class="p">,</span><span class="n">loserVetStatus</span><span class="p">)</span>
    <span class="c1">--civ.ui.text("A "..loser.type.name.." has been defeated by a "..winner.type.name..".")</span>

<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">loser</code> is the unit which was defeated in combat.</p>

<p>The <code class="language-plaintext highlighter-rouge">winner</code> is the unit which won the combat.</p>

<p>The <code class="language-plaintext highlighter-rouge">aggressor</code> is the unit which initiated the combat.</p>

<p>The <code class="language-plaintext highlighter-rouge">victim</code> is the unit which was attacked.</p>

<p>The <code class="language-plaintext highlighter-rouge">loserLocation</code> is the tile where the <code class="language-plaintext highlighter-rouge">loser</code> was standing.  If the <code class="language-plaintext highlighter-rouge">aggressor</code> is the <code class="language-plaintext highlighter-rouge">loser</code>, the code <code class="language-plaintext highlighter-rouge">loser.location</code> will point to a “tile” off the map.</p>

<p>The <code class="language-plaintext highlighter-rouge">winnerVetStatus</code> is the veteran status of the <code class="language-plaintext highlighter-rouge">winner</code> before the battle took place (this event triggers after the game assigns veteran status for victory in combat).</p>

<p>The <code class="language-plaintext highlighter-rouge">loserVetStatus</code> is the veteran status of the <code class="language-plaintext highlighter-rouge">loser</code> before the battle
took place.</p>
<h5 id="eventsfilesonunitkilledlua">
  
  
    <strong>EventsFiles\onUnitKilled.lua</strong> <a href="#eventsfilesonunitkilledlua"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- This will only run when a unit is killed in combat (i.e. not when an event</span>
<span class="c1">-- 'kills' a unit)</span>
<span class="c1">-- note that if the aggressor loses, aggressor.location will not work</span>
<span class="c1">-- note: use loserLocation instead of loser.location, since loser.location doesn't work if the attacker loses</span>
<span class="c1">-- (the game returns a 'tile' off the map)</span>
<span class="k">function</span> <span class="nc">onUnitKilled</span><span class="p">.</span><span class="nf">onUnitKilled</span><span class="p">(</span><span class="n">loser</span><span class="p">,</span><span class="n">winner</span><span class="p">,</span><span class="n">aggressor</span><span class="p">,</span><span class="n">victim</span><span class="p">,</span><span class="n">loserLocation</span><span class="p">,</span><span class="n">winnerVetStatus</span><span class="p">,</span><span class="n">loserVetStatus</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="n">loser</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">" killed by "</span><span class="o">..</span><span class="n">winner</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">" separate file test killed in combat."</span><span class="p">)</span>
    <span class="k">end</span>

<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">loser</code> is the unit which was defeated in combat.</p>

<p>The <code class="language-plaintext highlighter-rouge">winner</code> is the unit which won the combat.</p>

<p>The <code class="language-plaintext highlighter-rouge">aggressor</code> is the unit which initiated the combat.</p>

<p>The <code class="language-plaintext highlighter-rouge">victim</code> is the unit which was attacked.</p>

<p>The <code class="language-plaintext highlighter-rouge">loserLocation</code> is the tile where the <code class="language-plaintext highlighter-rouge">loser</code> was standing.  If the <code class="language-plaintext highlighter-rouge">aggressor</code> is the <code class="language-plaintext highlighter-rouge">loser</code>, the code <code class="language-plaintext highlighter-rouge">loser.location</code> will point to a “tile” off the map.</p>

<p>The <code class="language-plaintext highlighter-rouge">winnerVetStatus</code> is the veteran status of the <code class="language-plaintext highlighter-rouge">winner</code> before the battle took place (this event triggers after the game assigns veteran status for victory in combat).</p>

<p>The <code class="language-plaintext highlighter-rouge">loserVetStatus</code> is the veteran status of the <code class="language-plaintext highlighter-rouge">loser</code> before the battle
took place.</p>
<h5 id="discrete-events-16">
  
  
    <strong>Discrete Events</strong> <a href="#discrete-events-16"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete Unit Killed In Combat event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">discreteEvents</span><span class="p">.</span><span class="n">onUnitKilled</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">loser</span><span class="p">,</span><span class="n">winner</span><span class="p">,</span><span class="n">aggressor</span><span class="p">,</span><span class="n">victim</span><span class="p">,</span><span class="n">loserLocation</span><span class="p">,</span><span class="n">winnerVetStatus</span><span class="p">,</span><span class="n">loserVetStatus</span><span class="p">)</span> 
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="n">loser</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">" was killed by "</span><span class="o">..</span><span class="n">winner</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">" discrete event 1"</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">loser</code> is the unit which was defeated in combat.</p>

<p>The <code class="language-plaintext highlighter-rouge">winner</code> is the unit which won the combat.</p>

<p>The <code class="language-plaintext highlighter-rouge">aggressor</code> is the unit which initiated the combat.</p>

<p>The <code class="language-plaintext highlighter-rouge">victim</code> is the unit which was attacked.</p>

<p>The <code class="language-plaintext highlighter-rouge">loserLocation</code> is the tile where the <code class="language-plaintext highlighter-rouge">loser</code> was standing.  If the <code class="language-plaintext highlighter-rouge">aggressor</code> is the <code class="language-plaintext highlighter-rouge">loser</code>, the code <code class="language-plaintext highlighter-rouge">loser.location</code> will point to a “tile” off the map.</p>

<p>The <code class="language-plaintext highlighter-rouge">winnerVetStatus</code> is the veteran status of the <code class="language-plaintext highlighter-rouge">winner</code> before the battle took place (this event triggers after the game assigns veteran status for victory in combat).</p>

<p>The <code class="language-plaintext highlighter-rouge">loserVetStatus</code> is the veteran status of the <code class="language-plaintext highlighter-rouge">loser</code> before the battle
took place.</p>
<h4 id="implementation-19">
  
  
    Implementation <a href="#implementation-19"><span class="self-link">&#128279</span></a>
  
  
</h4>
    

<p>This event is based primarily on the function <code class="language-plaintext highlighter-rouge">civ.scen.onUnitKilled</code>
function provided by the standard Test of Time Patch Project.  However,
information is also gathered by the function registered to 
<code class="language-plaintext highlighter-rouge">civ.scen.onInitiateCombat</code> in order to populate these variables 
(which are defined outside of either registered function):</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">aggressor</code></li>
  <li><code class="language-plaintext highlighter-rouge">aggressorLocation</code></li>
  <li><code class="language-plaintext highlighter-rouge">aggressorVetStatus</code></li>
  <li><code class="language-plaintext highlighter-rouge">victim</code></li>
  <li><code class="language-plaintext highlighter-rouge">victimVetStatus</code></li>
</ul>

<p>These variables are used to populate the following <code class="language-plaintext highlighter-rouge">onUnitKilled</code> function
parameters, which are not provided by the game itself:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">aggressor</code></li>
  <li><code class="language-plaintext highlighter-rouge">victim</code></li>
  <li><code class="language-plaintext highlighter-rouge">loserLocation</code></li>
  <li><code class="language-plaintext highlighter-rouge">winnerVetStatus</code></li>
  <li><code class="language-plaintext highlighter-rouge">loserVetStatus</code></li>
</ul>
<h3 id="unit-defeated">
  
  
    <strong>Unit Defeated</strong> <a href="#unit-defeated"><span class="self-link">&#128279</span></a>
  
  
</h3>
    

<p>This execution point is triggered when a unit is killed as a result of 
standard Civ II combat, or when it is killed by events through
the use of the <a href="/auto_doc/gen.html#defeatunit">gen.defeatUnit</a> function.</p>
<h4 id="usage-19">
  
  
    Usage <a href="#usage-19"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<h5 id="consolidatedeventslua-14">
  
  
    <strong>consolidatedEvents.lua</strong> <a href="#consolidatedeventslua-14"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- On unit defeated in combat or by some other event</span>
<span class="k">function</span> <span class="nc">events</span><span class="p">.</span><span class="nf">onUnitDefeated</span><span class="p">(</span><span class="n">loser</span><span class="p">,</span><span class="n">winner</span><span class="p">,</span><span class="n">aggressor</span><span class="p">,</span><span class="n">victim</span><span class="p">,</span><span class="n">loserLocation</span><span class="p">,</span><span class="n">winnerVetStatus</span><span class="p">,</span><span class="n">loserVetStatus</span><span class="p">)</span>
    <span class="c1">--civ.ui.text("unit defeated consolidated test")</span>

<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">loser</code> is the unit which was defeated.</p>

<p>The <code class="language-plaintext highlighter-rouge">winner</code> is the unit which won the combat.</p>

<p>The <code class="language-plaintext highlighter-rouge">aggressor</code> is the unit which initiated the combat.</p>

<p>The <code class="language-plaintext highlighter-rouge">victim</code> is the unit which was attacked.</p>

<p>The <code class="language-plaintext highlighter-rouge">loserLocation</code> is the tile where the <code class="language-plaintext highlighter-rouge">loser</code> was standing.  If the <code class="language-plaintext highlighter-rouge">aggressor</code> is the <code class="language-plaintext highlighter-rouge">loser</code>, the code <code class="language-plaintext highlighter-rouge">loser.location</code> will point to a “tile” off the map.</p>

<p>The <code class="language-plaintext highlighter-rouge">winnerVetStatus</code> is the veteran status of the <code class="language-plaintext highlighter-rouge">winner</code> before the battle took place (this event triggers after the game assigns veteran status for victory in combat).</p>

<p>The <code class="language-plaintext highlighter-rouge">loserVetStatus</code> is the veteran status of the <code class="language-plaintext highlighter-rouge">loser</code> before the battle
took place.</p>
<h5 id="eventsfilesonunitdefeatedlua">
  
  
    <strong>EventsFiles\onUnitDefeated.lua</strong> <a href="#eventsfilesonunitdefeatedlua"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- This will run any time a unit is killed, either in combat or by events</span>
<span class="k">function</span> <span class="nc">onUnitDefeated</span><span class="p">.</span><span class="nf">onUnitDefeated</span><span class="p">(</span><span class="n">loser</span><span class="p">,</span><span class="n">winner</span><span class="p">,</span><span class="n">aggressor</span><span class="p">,</span><span class="n">victim</span><span class="p">,</span><span class="n">loserLocation</span><span class="p">,</span><span class="n">winnerVetStatus</span><span class="p">,</span><span class="n">loserVetStatus</span><span class="p">)</span>
    <span class="c1">--civ.ui.text(loser.type.name.." defeated (possibly in an event rather than combat) by "..winner.type.name.." separate file test")</span>

<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">loser</code> is the unit which was defeated.</p>

<p>The <code class="language-plaintext highlighter-rouge">winner</code> is the unit which won the combat.</p>

<p>The <code class="language-plaintext highlighter-rouge">aggressor</code> is the unit which initiated the combat.</p>

<p>The <code class="language-plaintext highlighter-rouge">victim</code> is the unit which was attacked.</p>

<p>The <code class="language-plaintext highlighter-rouge">loserLocation</code> is the tile where the <code class="language-plaintext highlighter-rouge">loser</code> was standing.  If the <code class="language-plaintext highlighter-rouge">aggressor</code> is the <code class="language-plaintext highlighter-rouge">loser</code>, the code <code class="language-plaintext highlighter-rouge">loser.location</code> will point to a “tile” off the map.</p>

<p>The <code class="language-plaintext highlighter-rouge">winnerVetStatus</code> is the veteran status of the <code class="language-plaintext highlighter-rouge">winner</code> before the battle took place (this event triggers after the game assigns veteran status for victory in combat).</p>

<p>The <code class="language-plaintext highlighter-rouge">loserVetStatus</code> is the veteran status of the <code class="language-plaintext highlighter-rouge">loser</code> before the battle
took place.</p>
<h5 id="discrete-events-17">
  
  
    <strong>Discrete Events</strong> <a href="#discrete-events-17"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete Unit Defeated event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">discreteEvents</span><span class="p">.</span><span class="n">onUnitDefeated</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">loser</span><span class="p">,</span><span class="n">winner</span><span class="p">,</span><span class="n">aggressor</span><span class="p">,</span><span class="n">victim</span><span class="p">,</span><span class="n">loserLocation</span><span class="p">,</span><span class="n">winnerVetStatus</span><span class="p">,</span><span class="n">loserVetStatus</span><span class="p">)</span> 
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
    <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="n">loser</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">" was defeated (possibly by event) by "</span><span class="o">..</span><span class="n">winner</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">" discrete event"</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">loser</code> is the unit which was defeated.</p>

<p>The <code class="language-plaintext highlighter-rouge">winner</code> is the unit which won the combat.</p>

<p>The <code class="language-plaintext highlighter-rouge">aggressor</code> is the unit which initiated the combat.</p>

<p>The <code class="language-plaintext highlighter-rouge">victim</code> is the unit which was attacked.</p>

<p>The <code class="language-plaintext highlighter-rouge">loserLocation</code> is the tile where the <code class="language-plaintext highlighter-rouge">loser</code> was standing.  If the <code class="language-plaintext highlighter-rouge">aggressor</code> is the <code class="language-plaintext highlighter-rouge">loser</code>, the code <code class="language-plaintext highlighter-rouge">loser.location</code> will point to a “tile” off the map.</p>

<p>The <code class="language-plaintext highlighter-rouge">winnerVetStatus</code> is the veteran status of the <code class="language-plaintext highlighter-rouge">winner</code> before the battle took place (this event triggers after the game assigns veteran status for victory in combat).</p>

<p>The <code class="language-plaintext highlighter-rouge">loserVetStatus</code> is the veteran status of the <code class="language-plaintext highlighter-rouge">loser</code> before the battle
took place.</p>
<h4 id="implementation-20">
  
  
    Implementation <a href="#implementation-20"><span class="self-link">&#128279</span></a>
  
  
</h4>
    

<p>The Unit Defeated execution point is implemented using the TOTPP function
<code class="language-plaintext highlighter-rouge">civ.scen.onUnitKilled</code>, as well as making the function <code class="language-plaintext highlighter-rouge">gen.defeatUnit</code>
call the registered functions for this execution point.  The function is registered for <code class="language-plaintext highlighter-rouge">gen.defeatUnit</code> by the function <a href="/auto_doc/gen.html#setdeathfunctions">gen.setDeathFunctions</a>.</p>
<h3 id="unit-death">
  
  
    <strong>Unit Death</strong> <a href="#unit-death"><span class="self-link">&#128279</span></a>
  
  
</h3>
    

<p>This execution point is triggered when a unit “dies.”  This includes when it is defeated in combat or by the use of <a href="/auto_doc/gen.html#defeatunit">gen.defeatUnit</a> (as long as it isn’t demoted into another unit by events), and also when the function <a href="/auto_doc/gen.html#killunit">gen.killUnit</a> is called.</p>
<h4 id="usage-20">
  
  
    Usage <a href="#usage-20"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<h5 id="eventsfilesonunitdeathlua">
  
  
    <strong>EventsFiles\onUnitDeath.lua</strong> <a href="#eventsfilesonunitdeathlua"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- this happens whenever a unit 'dies', regardless of combat, as long as it is not replaced</span>
<span class="k">function</span> <span class="nc">onUnitDeath</span><span class="p">.</span><span class="nf">onUnitDeath</span><span class="p">(</span><span class="n">dyingUnit</span><span class="p">)</span>
    <span class="c1">--civ.ui.text(dyingUnit.type.name.." died separate file test")</span>

<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">dyingUnit</code> is the unit which has just been killed.</p>
<h4 id="implementation-21">
  
  
    Implementation <a href="#implementation-21"><span class="self-link">&#128279</span></a>
  
  
</h4>
    

<p>The Unit Death execution point is implemented using the TOTPP function
<code class="language-plaintext highlighter-rouge">civ.scen.onUnitKilled</code>, as well as making the functions <code class="language-plaintext highlighter-rouge">gen.defeatUnit</code> and <code class="language-plaintext highlighter-rouge">gen.killUnit</code>
call the registered function for this execution point.</p>
<h3 id="unit-death-outside-combat">
  
  
    <strong>Unit Death Outside Combat</strong> <a href="#unit-death-outside-combat"><span class="self-link">&#128279</span></a>
  
  
</h3>
    

<p>This execution point is triggered when a unit is “killed” using the function <a href="/auto_doc/gen.html#killunit">gen.killUnit</a>.  It is not triggered when a unit is defeated in combat or by the use of <a href="/auto_doc/gen.html#defeatunit">gen.defeatUnit</a>.</p>
<h4 id="usage-21">
  
  
    Usage <a href="#usage-21"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<h5 id="eventsfilesonunitdeathlua-1">
  
  
    <strong>EventsFiles\onUnitDeath.lua</strong> <a href="#eventsfilesonunitdeathlua-1"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- this happens whenever a unit 'dies', but not through combat (or 'defeat')</span>
<span class="k">function</span> <span class="nc">onUnitDeath</span><span class="p">.</span><span class="nf">onUnitDeathOutsideCombat</span><span class="p">(</span><span class="n">dyingUnit</span><span class="p">)</span>
    <span class="c1">--civ.ui.text(dyingUnit.type.name.." died outside combat separate file test")</span>

<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">dyingUnit</code> is the unit which has just been killed.</p>
<h4 id="implementation-22">
  
  
    Implementation <a href="#implementation-22"><span class="self-link">&#128279</span></a>
  
  
</h4>
    

<p>The Unit Death Outside Combat execution point is implemented by making the function <code class="language-plaintext highlighter-rouge">gen.killUnit</code> call the registered function for this execution point.  That function is registered using <a href="/auto_doc/gen.html#setdeathfunctions">gen.setDeathFunctions</a>.</p>
<h3 id="unit-deleted">
  
  
    <strong>Unit Deleted</strong> <a href="#unit-deleted"><span class="self-link">&#128279</span></a>
  
  
</h3>
    

<p>This execution point is triggered when a unit is deleted from the game.  This includes when it is defeated in combat or by the use of <a href="/auto_doc/gen.html#defeatunit">gen.defeatUnit</a> (even if the unit is “demoted” into another unit), when the function <a href="/auto_doc/gen.html#killunit">gen.killUnit</a> is called, and when the function <a href="/auto_doc/gen.html#deleteunit">gen.deleteUnit</a> is called.  It is not triggered when a unit is disbanded by the player (as of TOTPPv0.18.4), and is not triggered by the use of <a href="/auto_doc/civ.html#deleteunit">civ.deleteUnit</a>.</p>
<h4 id="usage-22">
  
  
    Usage <a href="#usage-22"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<h5 id="eventsfilesonunitdeathlua-2">
  
  
    <strong>EventsFiles\onUnitDeath.lua</strong> <a href="#eventsfilesonunitdeathlua-2"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- this happens if a unit is deleted (either through combat death, or by some other event,</span>
<span class="c1">-- but not if the unit is disbanded)</span>
<span class="c1">-- If the unit isn't being replaced, replacingUnit is nil</span>
<span class="k">function</span> <span class="nc">onUnitDeath</span><span class="p">.</span><span class="nf">onUnitDeleted</span><span class="p">(</span><span class="n">deletedUnit</span><span class="p">,</span><span class="n">replacingUnit</span><span class="p">)</span>
    <span class="c1">--civ.ui.text(deletedUnit.type.name.." deleted and replaced by "..tostring(replacingUnit).." separate file")</span>

<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">deletedUnit</code> is the unit which has just been deleted.</p>

<p>The <code class="language-plaintext highlighter-rouge">replacementUnit</code> is the unit which has replaced the <code class="language-plaintext highlighter-rouge">deletedUnit</code> (if any).  If the <code class="language-plaintext highlighter-rouge">deletedUnit</code> was not replaced, this parameter is <code class="language-plaintext highlighter-rouge">nil</code>.</p>
<h4 id="implementation-23">
  
  
    Implementation <a href="#implementation-23"><span class="self-link">&#128279</span></a>
  
  
</h4>
    

<p>The Unit Deleted execution point is implemented using the TOTPP function
<code class="language-plaintext highlighter-rouge">civ.scen.onUnitKilled</code>, as well as making the functions <code class="language-plaintext highlighter-rouge">gen.defeatUnit</code>, <code class="language-plaintext highlighter-rouge">gen.killUnit</code>, and <code class="language-plaintext highlighter-rouge">gen.deleteUnit</code> call the registered function for this execution point.  The function is registered for <code class="language-plaintext highlighter-rouge">gen.defeatUnit</code> by the function <a href="/auto_doc/gen.html#setdeathfunctions">gen.setDeathFunctions</a>.</p>
<h3 id="city-processing-complete">
  
  
    <strong>City Processing Complete</strong> <a href="#city-processing-complete"><span class="self-link">&#128279</span></a>
  
  
</h3>
    

<p>This execution point is triggered when the game has finished processing city production for a tribe, and before it has a chance to move units.</p>
<h4 id="usage-23">
  
  
    Usage <a href="#usage-23"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<h5 id="consolidatedeventslua-15">
  
  
    <strong>consolidatedEvents.lua</strong> <a href="#consolidatedeventslua-15"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- After Production</span>
<span class="k">function</span> <span class="nc">events</span><span class="p">.</span><span class="nf">onCityProcessingComplete</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span><span class="n">tribe</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"consolidated.onCityProcessingComplete for turn "</span><span class="o">..</span><span class="nb">tostring</span><span class="p">(</span><span class="n">turn</span><span class="p">)</span><span class="o">..</span><span class="s2">" and tribe "</span><span class="o">..</span><span class="n">tribe</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">end</span>

<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">turn</code> is the turn number (an integer).</p>

<p>The <code class="language-plaintext highlighter-rouge">tribe</code> is the tribe which has just finished processing cities.</p>
<h5 id="eventsfilesoncityprocessingcompletelua">
  
  
    <strong>EventsFiles\onCityProcessingComplete.lua</strong> <a href="#eventsfilesoncityprocessingcompletelua"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onCityProcessingComplete</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span><span class="n">tribe</span><span class="p">)</span>
    <span class="c1">--civ.ui.text('after production separate file')</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"onCityProcessingComplete for turn "</span><span class="o">..</span><span class="n">turn</span><span class="o">..</span><span class="s2">" and tribe "</span><span class="o">..</span><span class="n">tribe</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">" separate file"</span><span class="p">)</span>
    <span class="k">end</span>

<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">turn</code> is the turn number (an integer).</p>

<p>The <code class="language-plaintext highlighter-rouge">tribe</code> is the tribe which has just finished processing cities.</p>
<h5 id="discrete-events-18">
  
  
    <strong>Discrete Events</strong> <a href="#discrete-events-18"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete City Processing Complete event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">discreteEvents</span><span class="p">.</span><span class="n">onCityProcessingComplete</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span><span class="n">tribe</span><span class="p">)</span> 
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"discreteEvents.onCityProcessingComplete for "</span><span class="o">..</span><span class="n">tribe</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">" on turn "</span><span class="o">..</span><span class="nb">tostring</span><span class="p">(</span><span class="n">turn</span><span class="p">))</span>
    <span class="k">end</span>
<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">turn</code> is the turn number (an integer).</p>

<p>The <code class="language-plaintext highlighter-rouge">tribe</code> is the tribe which has just finished processing cities.</p>
<h4 id="implementation-24">
  
  
    Implementation <a href="#implementation-24"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<p>This execution point is provided by the Test of Time Patch Project function <code class="language-plaintext highlighter-rouge">civ.scen.onCityProcessingComplete</code>.</p>
<h3 id="before-city-processing">
  
  
    <strong>Before City Processing</strong> <a href="#before-city-processing"><span class="self-link">&#128279</span></a>
  
  
</h3>
    

<p>This execution point is triggered at the start of a tribe’s turn, before the game processes its cities.</p>
<h4 id="usage-24">
  
  
    Usage <a href="#usage-24"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<h5 id="consolidatedeventslua-16">
  
  
    <strong>consolidatedEvents.lua</strong> <a href="#consolidatedeventslua-16"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Before Production</span>
<span class="k">function</span> <span class="nc">events</span><span class="p">.</span><span class="nf">onTribeTurnBegin</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span><span class="n">tribe</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"consolidated.onTribeTurnBegin for turn "</span><span class="o">..</span><span class="nb">tostring</span><span class="p">(</span><span class="n">turn</span><span class="p">)</span><span class="o">..</span><span class="s2">" and tribe "</span><span class="o">..</span><span class="n">tribe</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">end</span>

<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">turn</code> is the turn number (an integer).</p>

<p>The <code class="language-plaintext highlighter-rouge">tribe</code> is the tribe which is about to process cities.</p>
<h5 id="eventsfilesontribeturnbeginlua">
  
  
    <strong>EventsFiles\onTribeTurnBegin.lua</strong> <a href="#eventsfilesontribeturnbeginlua"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onTribeTurnBegin</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span><span class="n">tribe</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"onTribeTurnBegin for turn "</span><span class="o">..</span><span class="n">turn</span><span class="o">..</span><span class="s2">" and tribe "</span><span class="o">..</span><span class="n">tribe</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">" separate file"</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">turn</code> is the turn number (an integer).</p>

<p>The <code class="language-plaintext highlighter-rouge">tribe</code> is the tribe which is about to process cities.</p>
<h5 id="discrete-events-19">
  
  
    <strong>Discrete Events</strong> <a href="#discrete-events-19"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete Before City Processing event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">discreteEvents</span><span class="p">.</span><span class="n">onTribeTurnBegin</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span><span class="n">tribe</span><span class="p">)</span> 
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"discreteEvents.onTribeTurnBegin for "</span><span class="o">..</span><span class="n">tribe</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">" on turn "</span><span class="o">..</span><span class="nb">tostring</span><span class="p">(</span><span class="n">turn</span><span class="p">))</span>
    <span class="k">end</span>
<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">turn</code> is the turn number (an integer).</p>

<p>The <code class="language-plaintext highlighter-rouge">tribe</code> is the tribe which is about to process cities.</p>
<h4 id="implementation-25">
  
  
    Implementation <a href="#implementation-25"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<p>This execution point is provided by the Test of Time Patch Project function <code class="language-plaintext highlighter-rouge">civ.scen.onTribeTurnBegin</code>.</p>
<h3 id="tribe-turn-finished">
  
  
    <strong>Tribe Turn Finished</strong> <a href="#tribe-turn-finished"><span class="self-link">&#128279</span></a>
  
  
</h3>
    

<p>This execution point is triggered at the end of a tribe’s turn.</p>
<h4 id="usage-25">
  
  
    Usage <a href="#usage-25"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<h5 id="consolidatedeventslua-17">
  
  
    <strong>consolidatedEvents.lua</strong> <a href="#consolidatedeventslua-17"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nc">events</span><span class="p">.</span><span class="nf">onTribeTurnEnd</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span><span class="n">tribe</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"consolidated.onTribeTurnEnd for turn "</span><span class="o">..</span><span class="nb">tostring</span><span class="p">(</span><span class="n">turn</span><span class="p">)</span><span class="o">..</span><span class="s2">" and tribe "</span><span class="o">..</span><span class="n">tribe</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">end</span>

<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">turn</code> is the turn number (an integer).</p>

<p>The <code class="language-plaintext highlighter-rouge">tribe</code> is the tribe which has just finished its turn.</p>
<h5 id="eventsfilesontribeturnendlua">
  
  
    <strong>EventsFiles\onTribeTurnEnd.lua</strong> <a href="#eventsfilesontribeturnendlua"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onTribeTurnEnd</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span><span class="n">tribe</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"onTribeTurnEnd for turn "</span><span class="o">..</span><span class="n">turn</span><span class="o">..</span><span class="s2">" and tribe "</span><span class="o">..</span><span class="n">tribe</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">" separate file"</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">turn</code> is the turn number (an integer).</p>

<p>The <code class="language-plaintext highlighter-rouge">tribe</code> is the tribe which has just finished its turn.</p>
<h5 id="discrete-events-20">
  
  
    <strong>Discrete Events</strong> <a href="#discrete-events-20"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete Tribe Turn Finished event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">discreteEvents</span><span class="p">.</span><span class="n">onTribeTurnEnd</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span><span class="n">tribe</span><span class="p">)</span> 
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"discreteEvents.onTribeTurnEnd for "</span><span class="o">..</span><span class="n">tribe</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">" on turn "</span><span class="o">..</span><span class="nb">tostring</span><span class="p">(</span><span class="n">turn</span><span class="p">))</span>
    <span class="k">end</span>
<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">turn</code> is the turn number (an integer).</p>

<p>The <code class="language-plaintext highlighter-rouge">tribe</code> is the tribe which has just finished its turn.</p>
<h4 id="implementation-26">
  
  
    Implementation <a href="#implementation-26"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<p>This execution point is provided by the Test of Time Patch Project function <code class="language-plaintext highlighter-rouge">civ.scen.onTribeTurnEnd</code>.</p>
<h3 id="just-before-city-processed">
  
  
    <strong>Just Before City Processed</strong> <a href="#just-before-city-processed"><span class="self-link">&#128279</span></a>
  
  
</h3>
    

<p>This execution point is triggered just before the game processes a city’s production, at the start of its owner’s turn.  This execution point is implemented during the City Yield Calculation execution point, so anything that can’t be effectively changed during that execution point can’t be changed here either.  For example, changing the cosmic parameter <code class="language-plaintext highlighter-rouge">sizeAquaduct</code> will not change the size a city can grow without an aquaduct, because the size is in place before this execution point is triggered.</p>
<h4 id="usage-26">
  
  
    Usage <a href="#usage-26"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<h5 id="consolidatedeventslua-18">
  
  
    <strong>consolidatedEvents.lua</strong> <a href="#consolidatedeventslua-18"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- On City Processed</span>
<span class="k">function</span> <span class="nc">events</span><span class="p">.</span><span class="nf">onJustBeforeCityProcessed</span><span class="p">(</span><span class="n">city</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"consolidated.onJustBeforeCityProcessed for "</span><span class="o">..</span><span class="n">city</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">end</span>

<span class="k">end</span>

</code></pre></div></div>
<h5 id="eventsfilesonjustbeforecityprocessedlua">
  
  
    <strong>EventsFiles\onJustBeforeCityProcessed.lua</strong> <a href="#eventsfilesonjustbeforecityprocessedlua"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onJustBeforeCityProcessed</span><span class="p">(</span><span class="n">city</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"just before city processed separate file"</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>

</code></pre></div></div>
<h5 id="discrete-events-21">
  
  
    <strong>Discrete Events</strong> <a href="#discrete-events-21"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete Just Before City Processed event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">discreteEvents</span><span class="p">.</span><span class="n">onJustBeforeCityProcessed</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">city</span><span class="p">)</span> 
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"Just before city processed discrete event test for city "</span><span class="o">..</span><span class="n">city</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>
<h4 id="implementation-27">
  
  
    Implementation <a href="#implementation-27"><span class="self-link">&#128279</span></a>
  
  
</h4>
    

<p>The Just Before City Processed execution point is implemented using the TOTPP function <code class="language-plaintext highlighter-rouge">civ.scen.onCalculateCityYield</code>.   During the Before City Processing execution point, a list of the cities that will be processed is created.  (Cities are processed with highest ID number starting first, then working backwards.)  If the previous city processed is just before the current city, then the Just Before City Processed execution point is triggered on the next call to <code class="language-plaintext highlighter-rouge">civ.scen.onCalculateCityYield</code>.  Checks are made to prevent the “Zoom to Home City Trick” from triggering this execution point prematurely.  These checks can fail if a city screen was left open at the end of the player’s last turn, and the player uses the “Zoom to Home City Trick” to open the city screen of the city to be processed next.</p>
<h3 id="just-after-city-processed">
  
  
    <strong>Just After City Processed</strong> <a href="#just-after-city-processed"><span class="self-link">&#128279</span></a>
  
  
</h3>
    

<p>This execution point is triggered just after the game processes a city’s production, at the start of its owner’s turn.</p>
<h4 id="usage-27">
  
  
    Usage <a href="#usage-27"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<h5 id="consolidatedeventslua-19">
  
  
    <strong>consolidatedEvents.lua</strong> <a href="#consolidatedeventslua-19"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- On City Processed</span>
<span class="k">function</span> <span class="nc">events</span><span class="p">.</span><span class="nf">onJustAfterCityProcessed</span><span class="p">(</span><span class="n">city</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"consolidated.onJustAfterCityProcessed for "</span><span class="o">..</span><span class="n">city</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">end</span>

<span class="k">end</span>

</code></pre></div></div>
<h5 id="eventsfilesonjustaftercityprocessedlua">
  
  
    <strong>EventsFiles\onJustAfterCityProcessed.lua</strong> <a href="#eventsfilesonjustaftercityprocessedlua"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onJustAfterCityProcessed</span><span class="p">(</span><span class="n">city</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"just after city processed separate file"</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>

</code></pre></div></div>
<h5 id="discrete-events-22">
  
  
    <strong>Discrete Events</strong> <a href="#discrete-events-22"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete Just After City Processed event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">discreteEvents</span><span class="p">.</span><span class="n">onJustAfterCityProcessed</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">city</span><span class="p">)</span> 
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"Just after city processed discrete event test for city "</span><span class="o">..</span><span class="n">city</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>
<h4 id="implementation-28">
  
  
    Implementation <a href="#implementation-28"><span class="self-link">&#128279</span></a>
  
  
</h4>
    

<p>The Just After City Processed execution point is implemented using the TOTPP function <code class="language-plaintext highlighter-rouge">civ.scen.onCalculateCityYield</code>, checking that the last time <code class="language-plaintext highlighter-rouge">civ.scen.onCalculateCityYield</code> was called, the Just Before City Processed execution point was triggered.  As part of the city processing, each city has its yield calculated at least twice, once before production is applied, and once after.</p>
<h3 id="unit-enters-tile">
  
  
    <strong>Unit Enters Tile</strong> <a href="#unit-enters-tile"><span class="self-link">&#128279</span></a>
  
  
</h3>
    

<p>This execution point is triggered when a unit enters a tile from another tile.</p>

<p>Optionally, the function can return true, in which case no more code will be executed for this event.  This is useful if your event kills the unit, so other events expecting a non-nil unit will not cause errors.</p>

<p>This execution point will not work properly if <code class="language-plaintext highlighter-rouge">civ.scen.compatibility.activeUnitEveryMove</code> is set to <code class="language-plaintext highlighter-rouge">false</code>.  (In the Lua Scenario Template, it is set to <code class="language-plaintext highlighter-rouge">true</code> in the file <code class="language-plaintext highlighter-rouge">LuaParameterFiles\parameters.lua</code>.)</p>
<h4 id="usage-28">
  
  
    Usage <a href="#usage-28"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<h5 id="consolidatedeventslua-20">
  
  
    <strong>consolidatedEvents.lua</strong> <a href="#consolidatedeventslua-20"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- onEnterTile(unit,previousTile,previousDomainSpec)</span>
<span class="c1">-- executes when a unit successfully enters a tile (so not when it attacks</span>
<span class="c1">-- a unit or fails to enter a tile because it lacks movement points)</span>
<span class="k">function</span> <span class="nc">events</span><span class="p">.</span><span class="nf">onEnterTile</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span><span class="n">previousTile</span><span class="p">,</span><span class="n">previousDomainSpec</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"consolidated.onEnterTile: "</span><span class="o">..</span><span class="n">unit</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">" has entered tile ("</span><span class="o">..</span><span class="n">text</span><span class="p">.</span><span class="n">coordinates</span><span class="p">(</span><span class="n">unit</span><span class="p">.</span><span class="n">location</span><span class="p">)</span><span class="o">..</span><span class="s2">") from tile ("</span><span class="o">..</span><span class="n">text</span><span class="p">.</span><span class="n">coordinates</span><span class="p">(</span><span class="n">previousTile</span><span class="p">)</span><span class="o">..</span><span class="s2">")."</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>

</code></pre></div></div>
<h5 id="eventsfilesonentertilelua">
  
  
    <strong>EventsFiles\onEnterTile.lua</strong> <a href="#eventsfilesonentertilelua"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- onEnterTile(unit,previousTile,previousDomainSpec)</span>
<span class="c1">-- executes when a unit successfully enters a tile (so not when it attacks</span>
<span class="c1">-- a unit or fails to enter a tile because it lacks movement points)</span>
<span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onEnterTile</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span><span class="n">previousTile</span><span class="p">,</span><span class="n">previousDomainSpec</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"onEnterTile.onEnterTile: "</span><span class="o">..</span><span class="n">unit</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">" has entered tile ("</span><span class="o">..</span><span class="n">text</span><span class="p">.</span><span class="n">coordinates</span><span class="p">(</span><span class="n">unit</span><span class="p">.</span><span class="n">location</span><span class="p">)</span><span class="o">..</span><span class="s2">") from tile ("</span><span class="o">..</span><span class="n">text</span><span class="p">.</span><span class="n">coordinates</span><span class="p">(</span><span class="n">previousTile</span><span class="p">)</span><span class="o">..</span><span class="s2">")."</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="c1">--if gen.isParadrop(unit.type) and not unit.location.city then</span>
    <span class="c1">--    unit:teleport(previousTile)</span>
    <span class="c1">--    gen.clearParadropped(unit)</span>
    <span class="c1">--end</span>
    <span class="c1">--gen.original.uParatroopers.hold = 1</span>
    <span class="c1">--gen.original.uParatroopers.domain = 2</span>

<span class="k">end</span>

</code></pre></div></div>
<h5 id="discrete-events-23">
  
  
    <strong>Discrete Events</strong> <a href="#discrete-events-23"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete Unit Enters Tile event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- onEnterTile(unit,previousTile)</span>
<span class="c1">-- executes when a unit successfully enters a tile (so not when it attacks</span>
<span class="c1">-- a unit or fails to enter a tile because it lacks movement points)</span>
<span class="n">discreteEvents</span><span class="p">.</span><span class="n">onEnterTile</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span><span class="n">previousTile</span><span class="p">,</span><span class="n">previousDomainSpec</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"discreteEvents.onEnterTile: "</span><span class="o">..</span><span class="n">unit</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">" has entered tile ("</span><span class="o">..</span><span class="n">text</span><span class="p">.</span><span class="n">coordinates</span><span class="p">(</span><span class="n">unit</span><span class="p">.</span><span class="n">location</span><span class="p">)</span><span class="o">..</span><span class="s2">") from tile ("</span><span class="o">..</span><span class="n">text</span><span class="p">.</span><span class="n">coordinates</span><span class="p">(</span><span class="n">previousTile</span><span class="p">)</span><span class="o">..</span><span class="s2">")."</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>
<h4 id="implementation-29">
  
  
    Implementation <a href="#implementation-29"><span class="self-link">&#128279</span></a>
  
  
</h4>
    

<p>This execution point is mostly implemented using the Unit Activation execution point.  Since the execution point is executed when the unit is ready to move again, code can check whether a unit has moved.</p>

<p>When a unit is activated, some information about it is recorded by Lua, including its location.  The next time the a Unit Activation execution point is triggered, the location is compared to the recorded location.  If the unit is now in a different location, the Unit Enters Tile execution point is triggered.</p>

<p>The Get Formatted Date execution point will also check to see if a unit has been moved, in case there is no new active unit to trigger the Unit Activation execution point.  Since the status window is recalculated almost every time a click is made, a human player shouldn’t be able to do much without having this execution point trigger if it is appropriate.  The Tribe Turn Finished execution point also checks to see if a unit has been moved without having this execution point trigger, and if so, triggers this execution point.</p>
<h3 id="unit-given-final-order">
  
  
    <strong>Unit Given Final Order</strong> <a href="#unit-given-final-order"><span class="self-link">&#128279</span></a>
  
  
</h3>
    

<p>This execution point is triggered when a unit is given its final order for the turn.  This can happen because the unit has been detected to have spent all its movement points, or because the tribe’s turn has ended.</p>
<h4 id="usage-29">
  
  
    Usage <a href="#usage-29"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<h5 id="consolidatedeventslua-21">
  
  
    <strong>consolidatedEvents.lua</strong> <a href="#consolidatedeventslua-21"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- onFinalOrderGiven(unit)</span>
<span class="c1">-- executes when a unit has been given its final order for the turn.</span>
<span class="c1">-- that is, when a new unit is active and the previous unit has spent</span>
<span class="c1">-- all its movement points</span>
<span class="k">function</span> <span class="nc">events</span><span class="p">.</span><span class="nf">onFinalOrderGiven</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"consolidated.onFinalOrderGiven: "</span><span class="o">..</span><span class="n">unit</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">" has been given its order."</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>

</code></pre></div></div>
<h5 id="eventsfilesonfinalordergivenlua">
  
  
    <strong>EventsFiles\onFinalOrderGiven.lua</strong> <a href="#eventsfilesonfinalordergivenlua"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onFinalOrderGiven</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"onFinalOrderGiven.onFinalOrderGiven: "</span><span class="o">..</span><span class="n">unit</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">" has been given its order."</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>

</code></pre></div></div>
<h5 id="discrete-events-24">
  
  
    <strong>Discrete Events</strong> <a href="#discrete-events-24"><span class="self-link">&#128279</span></a>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete Unit Given Final Order event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- onFinalOrderGiven(unit)</span>
<span class="c1">-- executes when a unit has been given its final order for the turn.</span>
<span class="c1">-- that is, when a new unit is active and the previous unit has spent</span>
<span class="c1">-- all its movement points</span>
<span class="n">discreteEvents</span><span class="p">.</span><span class="n">onFinalOrderGiven</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"discreteEvents.onFinalOrderGiven: "</span><span class="o">..</span><span class="n">unit</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">" has been given its order."</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>
<h4 id="implementation-30">
  
  
    Implementation <a href="#implementation-30"><span class="self-link">&#128279</span></a>
  
  
</h4>
    

<p>This execution point is implemented using the Unit Activation execution point and the Tribe Turn Finished execution point.  When a unit is activated, some information about it is recorded by Lua.  The code checks the previously activated unit, and, if it no longer has any movement points remaining, triggers this execution point.  At the end of the tribe’s turn, the Tribe Turn Finished execution point checks to see if the unit has any movement points left.  If it does, the Unit Given Final Order execution point is triggered for that unit.</p>
<h3 id="nuclear-attack">
  
  
    <strong>Nuclear Attack</strong> <a href="#nuclear-attack"><span class="self-link">&#128279</span></a>
  
  
</h3>
    
<p>This execution point is triggered when an attack is made by a nuclear 
weapon (either a unit with 99 attack, or a spy).  A nuclear attack does not trigger <code class="language-plaintext highlighter-rouge">civ.scen.onUnitKilled</code>, so
events.lua makes sure to execute the related events.
If the registered function returns <code class="language-plaintext highlighter-rouge">false</code>, the attack is aborted.</p>
<h4 id="usage-30">
  
  
    Usage <a href="#usage-30"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<h4 id="implementation-31">
  
  
    Implementation <a href="#implementation-31"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<p>This execution point is provided by the Test of Time Patch Project function <code class="language-plaintext highlighter-rouge">civ.scen.onUseNuclearWeapon</code>.</p>
<h3 id="get-rush-buy-cost">
  
  
    <strong>Get Rush Buy Cost</strong> <a href="#get-rush-buy-cost"><span class="self-link">&#128279</span></a>
  
  
</h3>
    

<p>This execution point is called when a player checks what the cost is to rush 
buy the city’s current production item.  The registered function must return
an integer with the cost.</p>
<h4 id="usage-31">
  
  
    Usage <a href="#usage-31"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<h5 id="mechanicsfilesrushbuysettingslua">
  
  
    <strong>MechanicsFiles\rushBuySettings.lua</strong> <a href="#mechanicsfilesrushbuysettingslua"><span class="self-link">&#128279</span></a>
  
  
</h5>
    

<p>In the file MechanicsFiles
ushBuySettings.lua, change the following code:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onGetRushBuyCost</span><span class="p">(</span><span class="n">city</span><span class="p">,</span><span class="n">cost</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cost</span>
<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">city</code> parameter is the city where rush-buying is being considered.</p>

<p>The <code class="language-plaintext highlighter-rouge">cost</code> parameter is the game’s default cost to rush buy the current production item.</p>
<h4 id="implementation-32">
  
  
    Implementation <a href="#implementation-32"><span class="self-link">&#128279</span></a>
  
  
</h4>
    

<p>This execution point is implemented using the TOTPP function <code class="language-plaintext highlighter-rouge">civ.scen.onGetRushBuyCost</code>.</p>
<h3 id="get-formatted-date">
  
  
    <strong>Get Formatted Date</strong> <a href="#get-formatted-date"><span class="self-link">&#128279</span></a>
  
  
</h3>
    

<p>This execution point is triggered whenever the game needs to display a date.
Usually, this is because the game is updating the status window for the game,
but the date is also displayed when a city window is open, and also when
the spaceship window is open.  There may be other situations also.</p>

<p>The registered function must return a string to display where the date should
be.  This doesn’t actually have to be a date.  For example, If you have an 
active unit, you might want to display information about the unit in the
status window instead of the date.</p>

<p>Since the status window is recalculated so frequently, the Get Formatted Date
execution point can work almost like an ‘on click’ execution point.  The
Final Order Given and Unit Enters Tile execution points leverage this
ability so that they function properly even when another unit isn’t activated
immediately.  (This is handled in events.lua, so you don’t have to worry about
it when changing the code in onGetFormattedDate.lua.)</p>
<h4 id="usage-32">
  
  
    Usage <a href="#usage-32"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<h5 id="mechanicsfilesongetformatteddate">
  
  
    <strong>MechanicsFiles\onGetFormattedDate</strong> <a href="#mechanicsfilesongetformatteddate"><span class="self-link">&#128279</span></a>
  
  
</h5>
    

<p>You can modify the effects of this execution point by changing the following code
in <code class="language-plaintext highlighter-rouge">MechanicsFiles\onGetFormattedDate</code>:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onGetFormattedDate</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span><span class="n">defaultDateString</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="c1">--print(turn,civ.getTurn())</span>
        <span class="k">return</span> <span class="s2">"Testing Turn "</span><span class="o">..</span><span class="n">turn</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="n">defaultDateString</span>
<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">turn</code> parameter is the turn for the date which is to be displayed.  This is usually the current turn, but not always.  For example, the game
displays the date for a future turn when you are looking at the spaceship
window for a spaceship which has already departed.</p>

<p>The <code class="language-plaintext highlighter-rouge">defaultDateString</code> is the date string which the game would normally
display.  Return this if you do not want to make any changes to the date.</p>

<p>Here is some example code for showing information from the leaderBonus module for the active unit in the status window, instead of the date.  If the unit
is a leader, its rank is displayed.  Otherwise, if the unit has a commander,
the commander’s rank is displayed.  If the unit is neither a leader, nor under
the command of a leader, “No Leader” is displayed.</p>

<p>Note that if there is no active unit, or a city window is opened, the default
date is displayed.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">leaderBonus</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"leaderBonus"</span><span class="p">)</span>
<span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onGetFormattedDate</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span><span class="n">defaultDateString</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">civ</span><span class="p">.</span><span class="n">getCurrentTribe</span><span class="p">().</span><span class="n">isHuman</span> <span class="ow">and</span> <span class="n">civ</span><span class="p">.</span><span class="n">getActiveUnit</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">civ</span><span class="p">.</span><span class="n">getOpenCity</span><span class="p">()</span> <span class="k">then</span>
        <span class="kd">local</span> <span class="n">activeUnit</span> <span class="o">=</span> <span class="n">civ</span><span class="p">.</span><span class="n">getActiveUnit</span><span class="p">()</span>
        <span class="kd">local</span> <span class="n">rank</span> <span class="o">=</span> <span class="n">leaderBonus</span><span class="p">.</span><span class="n">getRank</span><span class="p">(</span><span class="n">activeUnit</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rank</span> <span class="k">then</span>
            <span class="k">return</span> <span class="s2">"Rank: "</span><span class="o">..</span><span class="n">rank</span>
        <span class="k">elseif</span> <span class="n">leaderBonus</span><span class="p">.</span><span class="n">getCommanderRank</span><span class="p">(</span><span class="n">activeUnit</span><span class="p">)</span> <span class="k">then</span>
            <span class="k">return</span> <span class="s2">"Ldr: "</span><span class="o">..</span><span class="n">leaderBonus</span><span class="p">.</span><span class="n">getCommanderRank</span><span class="p">(</span><span class="n">activeUnit</span><span class="p">)</span>
        <span class="k">else</span>
            <span class="k">return</span> <span class="s2">"No Leader"</span>
        <span class="k">end</span>
    <span class="k">else</span>
        <span class="k">return</span> <span class="n">defaultDateString</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="n">defaultDateString</span>
<span class="k">end</span>
</code></pre></div></div>
<h4 id="implementation-33">
  
  
    Implementation <a href="#implementation-33"><span class="self-link">&#128279</span></a>
  
  
</h4>
    

<p>This execution point is implemented using the TOTPP function <code class="language-plaintext highlighter-rouge">civ.scen.onGetFormattedDate</code>.</p>
<h3 id="select-music">
  
  
    <strong>Select Music</strong> <a href="#select-music"><span class="self-link">&#128279</span></a>
  
  
</h3>
    

<p>The Select Music execution point is called whenever the game selects a new
music track to play.  This allows for the scenario designer to ship
customised music with his or her scenario.</p>

<p>This execution point is also used by my <a href="https://github.com/ProfGarfield/ExtendedMusicForTOTPP">Extended Music For TOTPP</a> program.  If your scenario ships customised
music, that overrides the Extended Music Patch.</p>
<h4 id="usage-33">
  
  
    Usage <a href="#usage-33"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<h5 id="luaparameterfilescustommusicintegrationlua">
  
  
    <strong>LuaParameterFiles\customMusicIntegration.lua</strong> <a href="#luaparameterfilescustommusicintegrationlua"><span class="self-link">&#128279</span></a>
  
  
</h5>
    

<p>Adding custom music to your scenario is done by modifying the file <code class="language-plaintext highlighter-rouge">LuaParameterFiles\customMusicIntegration.lua</code>.  Begin by adding a 
directory called <code class="language-plaintext highlighter-rouge">Music</code> to the scenario’s folder, and put your music files
in that directory.  Then, rename the <code class="language-plaintext highlighter-rouge">@PICMUSICTOT</code> section of <code class="language-plaintext highlighter-rouge">Game.txt</code>
to give appropriate names to the tracks.</p>

<p>Next, change the <code class="language-plaintext highlighter-rouge">useCustomMusic</code> variable to <code class="language-plaintext highlighter-rouge">true</code>.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- By default, custom music is disabled</span>
<span class="c1">-- If you don't plan to use custom music, you</span>
<span class="c1">-- may wish to delete @PICKMUSICTOT from Game.txt,</span>
<span class="c1">-- so that the list from the Original folder is used instead.</span>
<span class="c1">-- (There is an "Extended Music For TOTPP" addition that I wrote</span>
<span class="c1">-- which benefits from modifying @PICKMUSICTOT, and which this</span>
<span class="c1">-- module will supersede if active</span>
<span class="kd">local</span> <span class="n">useCustomMusic</span> <span class="o">=</span> <span class="kc">false</span>

</code></pre></div></div>
<p>If this is not done, the scenario won’t have custom music.  (It also won’t have
custom music if the Direct Show Music Patch is not enabled.)</p>

<p>Then, go to this section of code, and change the values in the <code class="language-plaintext highlighter-rouge">trackList</code>
table to reflect the names of the tracks in your <code class="language-plaintext highlighter-rouge">Music</code> directory.  If some
of the tracks are neither in your scenario’s music directory, the game will
search for them in the main <code class="language-plaintext highlighter-rouge">Test of Time\Music</code> directory.  If the track
is not found in either place, a message will be displayed to the player, unless
the scenario’s music directory has a file <code class="language-plaintext highlighter-rouge">missingmusic.txt</code>.  (This file can be empty.)</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">trackList</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1">-- These are the files played for each of the options in</span>
<span class="c1">-- @PICKMUSICTOT</span>
<span class="c1">-- You can add extra entries to trackList, but you should</span>
<span class="c1">-- probably also add entries to @PICKMUSICTOT if you do</span>
<span class="c1">-- (stuff won't break if you don't, just some tracks won't</span>
<span class="c1">-- be selectable, or selected when being played)</span>

<span class="n">trackList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="s2">"Funeral March.mp3"</span>
<span class="n">trackList</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="s2">"Ode to Joy.mp3"</span>
<span class="n">trackList</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="s2">"Crusade.mp3"</span>
<span class="n">trackList</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>  <span class="s2">"Alien.mp3"</span>
<span class="n">trackList</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span>  <span class="s2">"Mongol Horde.mp3"</span>
<span class="n">trackList</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span>  <span class="s2">"The Apocalypse.mp3"</span> <span class="c1">-- note that in @PICKMUSICTOT, this is misspelled</span>
<span class="n">trackList</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span>  <span class="s2">"Jurassic Jungle.mp3"</span>
<span class="n">trackList</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span>  <span class="s2">"New World.mp3"</span>
<span class="n">trackList</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span>  <span class="s2">"Tolkien.mp3"</span>
<span class="n">trackList</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span>  <span class="s2">"Mars Expedition.mp3"</span>
<span class="n">trackList</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Jules Verne.mp3"</span>
<span class="n">trackList</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"They're Here.mp3"</span>
<span class="n">trackList</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"The Dome.mp3"</span>


<span class="c1">-- A check will be made to make sure all the files are available</span>
<span class="c1">-- If the scenario directory does not contain a music folder,</span>
<span class="c1">-- failure will be silent, and missing tracks will be replaced</span>
<span class="c1">-- with default tracks known to be available</span>
<span class="c1">-- Failure will also be silent if a file called missingmusic.txt</span>
<span class="c1">-- is in the music directory</span>
<span class="c1">-- Otherwise, an error will be thrown detailing the missing tracks.</span>

</code></pre></div></div>

<p>Note that although the game ships with 13 tracks, you can have more or fewer
tracks if you prefer.  You should update <code class="language-plaintext highlighter-rouge">@PICKMUSICTOT</code> appropriately,
by adding or removing lines as necessary.</p>

<p>Also, note that tracks 0 and 1 will be played when
civilizations are destroyed and cities celebrate We Love The King Day,
respectively.  Choose appropriate tracks, or leave them with their default
names, and let them be found in the player’s main music directory.</p>
<h4 id="implementation-34">
  
  
    Implementation <a href="#implementation-34"><span class="self-link">&#128279</span></a>
  
  
</h4>
    

<p>This execution point is implemented using the TOTPP function <code class="language-plaintext highlighter-rouge">civ.scen.onSelectMusic</code>.  Note, however, that unlike other execution points, this
function is not called in <code class="language-plaintext highlighter-rouge">events.lua</code>.  Instead, it is called within <code class="language-plaintext highlighter-rouge">LuaParameterFiles\customMusicIntegration.lua</code>.</p>
<h3 id="combat-resolution">
  
  
    <strong>Combat Resolution</strong> <a href="#combat-resolution"><span class="self-link">&#128279</span></a>
  
  
</h3>
    

<p>The Combat Resolution execution point has been superseded by the Combat Declared execution point, and is not in the current version of the Lua Scenario Template.</p>

<p>The registered function is called before every round of combat.  If it returns
true, the combat continues for another round.  If false, the combat ends, and
one of the combatants is destroyed.  (If one has 0 hp, it will be that one.)</p>
<h4 id="usage-34">
  
  
    Usage <a href="#usage-34"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<h5 id="deprecated">
  
  
    <strong>Deprecated</strong> <a href="#deprecated"><span class="self-link">&#128279</span></a>
  
  
</h5>
    

<p>This execution point is deprecated, so the Lua Scenario Template has no section dedicated to it.  If you wish to use it, define a function to be
registered, similar to the following:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="k">function</span> <span class="nf">resolutionFunction</span><span class="p">(</span><span class="n">defaultResolutionFunction</span><span class="p">,</span><span class="n">defender</span><span class="p">,</span><span class="n">attacker</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">defaultResolutionFunction</span><span class="p">(</span><span class="n">defender</span><span class="p">,</span><span class="n">attacker</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>
<p>Then, register it as follows:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">civ</span><span class="p">.</span><span class="n">scen</span><span class="p">.</span><span class="n">onResolveCombat</span><span class="p">(</span><span class="n">resolutionFunction</span><span class="p">)</span>
</code></pre></div></div>
<p>The <code class="language-plaintext highlighter-rouge">defaultResolutionFunction</code> is a function which takes two parameters, the defender and the attacker, and returns true if the combat should continue, and false if it should end.  This function is how the game would normally
determine if combat should continue.  You should change the returned value
when you wish to do something different.</p>

<p>The <code class="language-plaintext highlighter-rouge">defender</code> and <code class="language-plaintext highlighter-rouge">attacker</code> parameters are the units which are engaged
in combat.</p>
<h4 id="implementation-35">
  
  
    Implementation <a href="#implementation-35"><span class="self-link">&#128279</span></a>
  
  
</h4>
    

<p>This execution point can be implemented with the TOTPP function <code class="language-plaintext highlighter-rouge">civ.scen.onResolveCombat</code>.</p>
<h3 id="choose-tile-defender">
  
  
    <strong>Choose Tile Defender</strong> <a href="#choose-tile-defender"><span class="self-link">&#128279</span></a>
  
  
</h3>
    
<p>The code registered tot he Choose Tile Defender execution point is called when the game checks what unit will defend a tile.  This happens both when a tile is actually attacked, and when the AI is determining its goals.  A unit must be returned by the registered function, and that unit will defend the tile if combat actually takes place.  The defending unit can be chosen from a different tile.</p>
<h4 id="usage-35">
  
  
    Usage <a href="#usage-35"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<h5 id="mechanicsfilescombatsettingslua-1">
  
  
    <strong>MechanicsFiles\combatSettings.lua</strong> <a href="#mechanicsfilescombatsettingslua-1"><span class="self-link">&#128279</span></a>
  
  
</h5>
    

<p>You can change the behaviour of the Choose Tile Defender execution point by modifying the function <code class="language-plaintext highlighter-rouge">register.onChooseDefender</code> in the file <code class="language-plaintext highlighter-rouge">MechanicsFiles\combatSettings.lua</code>.  The default implementation is as follows:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onChooseDefender</span><span class="p">(</span><span class="n">defaultFunction</span><span class="p">,</span><span class="n">tile</span><span class="p">,</span><span class="n">attacker</span><span class="p">,</span><span class="n">isCombat</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">bestDefenderValue</span> <span class="o">=</span> <span class="o">-</span><span class="nb">math.huge</span>
    <span class="kd">local</span> <span class="n">bestDefender</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="k">for</span> <span class="n">possibleDefender</span> <span class="k">in</span> <span class="n">tile</span><span class="p">.</span><span class="n">units</span> <span class="k">do</span>
        <span class="kd">local</span> <span class="n">attackerStrength</span><span class="p">,</span> <span class="n">attackerFirepower</span><span class="p">,</span> <span class="n">defenderStrength</span><span class="p">,</span> <span class="n">defenderFirepower</span>
            <span class="o">=</span> <span class="n">computeCombatStatistics</span><span class="p">(</span><span class="n">attacker</span><span class="p">,</span><span class="n">possibleDefender</span><span class="p">,</span><span class="kc">false</span><span class="p">)</span>
        <span class="c1">-- below is what appears to be the standard civ II calculation</span>
        <span class="c1">--local defenderValue = defenderStrength*possibleDefender.hitpoints//possibleDefender.type.hitpoints</span>
        <span class="c1">-- instead of defender strength, however, defenderStrength/attackerStrength is used to account</span>
        <span class="c1">-- for attack buffs/debuffs (which are very few in original game)</span>
        <span class="kd">local</span> <span class="n">defenderValue</span> <span class="o">=</span> <span class="kc">nil</span>
        <span class="k">if</span> <span class="n">attackerStrength</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">then</span>
            <span class="n">defenderValue</span> <span class="o">=</span> <span class="mf">1e7</span> <span class="c1">-- 10 million</span>
        <span class="k">else</span>
            <span class="n">defenderValue</span> <span class="o">=</span> <span class="p">(</span><span class="n">defenderStrength</span><span class="o">/</span><span class="n">attackerStrength</span><span class="p">)</span><span class="o">*</span><span class="n">possibleDefender</span><span class="p">.</span><span class="n">hitpoints</span><span class="o">/</span><span class="n">possibleDefender</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">hitpoints</span>
        <span class="k">end</span>
        <span class="n">defenderValue</span> <span class="o">=</span> <span class="n">defenderValue</span> <span class="o">+</span> <span class="n">defenderValueModifier</span><span class="p">(</span><span class="n">possibleDefender</span><span class="p">,</span><span class="n">tile</span><span class="p">,</span><span class="n">attacker</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">defenderValue</span> <span class="o">&gt;</span> <span class="n">bestDefenderValue</span> <span class="ow">or</span> 
            <span class="p">(</span><span class="n">defenderValue</span> <span class="o">==</span> <span class="n">bestDefenderValue</span> <span class="ow">and</span> <span class="n">possibleDefender</span><span class="p">.</span><span class="n">id</span> <span class="o">&lt;</span> <span class="n">bestDefender</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="k">then</span>
            <span class="n">bestDefenderValue</span> <span class="o">=</span> <span class="n">defenderValue</span>
            <span class="n">bestDefender</span> <span class="o">=</span> <span class="n">possibleDefender</span>
        <span class="k">end</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="n">bestDefender</span>
    <span class="c1">--return defaultFunction(tile,attacker)</span>
<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">tile</code> parameter is the tile which is being attacked.</p>

<p>The <code class="language-plaintext highlighter-rouge">attacker</code> parameter is the unit which is attacking the tile.</p>

<p>The <code class="language-plaintext highlighter-rouge">isCombat</code> parameter is <code class="language-plaintext highlighter-rouge">true</code> if combat will actually take place, and <code class="language-plaintext highlighter-rouge">false</code> if the function is called for AI planning purposes.</p>

<p>The <code class="language-plaintext highlighter-rouge">defaultFunction</code> is the game’s standard function for determining what unit will defend the tile.  To use it, return the result of <code class="language-plaintext highlighter-rouge">defaultFunction(tile,attacker)</code>.</p>

<p>The standard Civ II method for choosing the defender is to choose the unit with the highest “defenderValue”, computed in the following way:</p>

<include src="/_LfE451$e7wdpDqciN6zB@A.xml"></include>

<p>With the division rounded down to the nearest integer.  Although unitDefense takes into account bonuses like the veteran status and the pikeman bonus, this computation does not take unit hitpoints or firepower into account.  For example, a damaged Armor unit (with more than 20 HP remaining) could defend after an Alpine Troops unit, even though it would be a better defender.</p>

<p>The default implementation of <code class="language-plaintext highlighter-rouge">register.onChooseDefender</code> keeps this basic choice system, but does not use the <code class="language-plaintext highlighter-rouge">defaultFunction</code> so that it can take into account combat customisations made in <code class="language-plaintext highlighter-rouge">computeCombatStatistics</code>.  The most notable change is that instead of relying on only the defense value of the candidate unit, the ratio of 
<include src="/_9XYP0yDg8@OBvJCqsFWou7.xml"></include> 
is used instead (without integer division).  This is because the base Civilization II game rarely modifies the attack value of a unit (I think the only case of this is a Partisan attacking a 0 attack unit), while this is an obvious thing to do with Lua.</p>

<p>If the attacker has 0 attack value when facing a certain unit, that unit’s defense value is set to ten million, so that it will be chosen as the defender by default.  (This can be changed in the next step.)</p>

<p>After assigning a value to the candidate defensive unit, that value is altered by adding the result of the following function:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- use this function to add to (or subtract from) the calculated</span>
<span class="c1">-- defender value in order to change onChooseDefender</span>
<span class="c1">-- e.g. if you add 1e8 (100 million) to all air in air protected stacks</span>
<span class="c1">-- when attacked by a fighter, air units will always defend first if they</span>
<span class="c1">-- are available.</span>
<span class="c1">-- If the combat calculator gives an attacker an attack value of 0,</span>
<span class="c1">-- this is converted to a defenderValue of 1e7 (10 million)</span>
<span class="c1">-- If you want this to defend (and cancel the attack) instead of the air unit</span>
<span class="c1">-- (presuming it isn't an air unit itself), you could add 1e6 (1 million) instead</span>
<span class="c1">-- calculated defenderValues are defenderStrength/attackerStrength*healthPercentage.</span>
<span class="c1">-- This should be less than 10,000 (127*8 = 1016), unless you have defense multipliers </span>
<span class="c1">-- of 10 or more, and an attacker with 1 attack and facing a 1/8 penalty.</span>
<span class="kd">local</span> <span class="k">function</span> <span class="nf">defenderValueModifier</span><span class="p">(</span><span class="n">defender</span><span class="p">,</span><span class="n">tile</span><span class="p">,</span><span class="n">attacker</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">simpleSettings</span><span class="p">.</span><span class="n">fightersAttackAirFirst</span> <span class="ow">and</span>
        <span class="n">gen</span><span class="p">.</span><span class="n">isAttackAir</span><span class="p">(</span><span class="n">attacker</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="ow">and</span> <span class="n">defender</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">domain</span> <span class="o">==</span> <span class="n">domain</span><span class="p">.</span><span class="n">air</span> 
        <span class="ow">and</span> <span class="n">defender</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">range</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span>
        <span class="ow">not</span> <span class="n">gen</span><span class="p">.</span><span class="n">hasAirbase</span><span class="p">(</span><span class="n">tile</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tile</span><span class="p">.</span><span class="n">city</span> <span class="ow">and</span>
        <span class="ow">not</span> <span class="n">tileHasCarrierUnit</span><span class="p">(</span><span class="n">tile</span><span class="p">)</span> <span class="k">then</span>
        <span class="k">return</span> <span class="mf">1e8</span>
    <span class="k">end</span>
    <span class="k">if</span> <span class="n">defender</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">domain</span> <span class="o">==</span> <span class="n">domain</span><span class="p">.</span><span class="n">ground</span> <span class="ow">and</span> <span class="n">tile</span><span class="p">.</span><span class="n">baseTerrain</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="mi">10</span> <span class="k">then</span>
        <span class="k">return</span> <span class="o">-</span><span class="mf">1e8</span>
    <span class="k">end</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">landAirCargo</span><span class="p">.</span><span class="n">canDefend</span><span class="p">(</span><span class="n">defender</span><span class="p">)</span> <span class="k">then</span>
        <span class="k">return</span> <span class="o">-</span><span class="mf">1e8</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">defenderValueModifier</code> function is meant to force certain units to defend with either higher or lower priority, even if some other unit would be a better defender.  For example, if <code class="language-plaintext highlighter-rouge">MechanicsFiles\simpleSettings.lua</code> has been changed to make fighters attack air first, then <code class="language-plaintext highlighter-rouge">defenderValueModifier</code> adds 100 million (<code class="language-plaintext highlighter-rouge">1e8</code>) to the value of all air
units when a fighter unit attacks.  This ensures that air units will always be chosen as defenders when a fighter attacks, even if they are not the best defenders.  Similarly, ground units on ocean tiles subtract 100 million, so they’ll never defend if a ship can defend them.</p>

<p>With a finalized defender value, <code class="language-plaintext highlighter-rouge">register.onChooseDefender</code> determines if the candidate defender is the best found so far, and, if so, updates the <code class="language-plaintext highlighter-rouge">bestDefender</code> variable.  After checking all units, <code class="language-plaintext highlighter-rouge">bestDefender</code> is returned.</p>
<h4 id="implementation-36">
  
  
    Implementation <a href="#implementation-36"><span class="self-link">&#128279</span></a>
  
  
</h4>
    

<p>The Choose Tile Defender execution point is implemented using the TOTPP function <code class="language-plaintext highlighter-rouge">civ.scen.onChooseDefender</code>.</p>
<h3 id="check-if-city-can-build-item">
  
  
    <strong>Check If City Can Build Item</strong> <a href="#check-if-city-can-build-item"><span class="self-link">&#128279</span></a>
  
  
</h3>
    

<p>The code for this execution point is executed whenever a city needs to determine if it can build an item.  If the called function returns <code class="language-plaintext highlighter-rouge">true</code>, then the item can be built by the city; if <code class="language-plaintext highlighter-rouge">false</code> it can’t.  This usually (possibly always, but I don’t know for sure) means that this execution point is run in batches of 256, for all the possible units, improvements, and wonders, that a city could build.</p>
<h4 id="usage-36">
  
  
    Usage <a href="#usage-36"><span class="self-link">&#128279</span></a>
  
  
</h4>
    
<h5 id="mechanicsfilescanbuildsettingslua">
  
  
    <strong>MechanicsFiles\canBuildSettings.lua</strong> <a href="#mechanicsfilescanbuildsettingslua"><span class="self-link">&#128279</span></a>
  
  
</h5>
    

<p>The Lua Scenario Template allows you to register tables in the file <code class="language-plaintext highlighter-rouge">MechanicsFiles\canBuildSettings.lua</code> which will be translated by the <code class="language-plaintext highlighter-rouge">canBuild</code> module into a suitable function to be registered with the <code class="language-plaintext highlighter-rouge">civ.scen.onCanBuild</code> function.  The Template does not provide a way to directly provide a function for this execution point.  However, the <code class="language-plaintext highlighter-rouge">conditionFunction</code> key allows you to register arbitrary code for whether a city can build a certain item, so you can make arbitrary conditions.</p>

<p>If you are not using the Template, this is the outline for registering the function:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="k">function</span> <span class="nf">canCityBuild</span><span class="p">(</span><span class="n">defaultBuildFunction</span><span class="p">,</span><span class="n">city</span><span class="p">,</span><span class="n">item</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">defaultBuildFunction</span><span class="p">(</span><span class="n">city</span><span class="p">,</span><span class="n">item</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">city</code> parameter is the city that is checking if the <code class="language-plaintext highlighter-rouge">item</code> can be built.</p>

<p>The <code class="language-plaintext highlighter-rouge">item</code> parameter is the unitTypeObject, improvementObject, or wonderObject that the city is checking if it can build.</p>

<p>The <code class="language-plaintext highlighter-rouge">defaultBuildFunction</code> is the game’s standard function for determining if a city can build an item.  The call <code class="language-plaintext highlighter-rouge">defaultBuildFunction(city,item)</code> returns true if the <code class="language-plaintext highlighter-rouge">city</code> can build the <code class="language-plaintext highlighter-rouge">item</code> under regular Civ II rules (prerequisite technology required, unitType not expired, improvement not already built, etc.).</p>

<p>You don’t have to use the result of the <code class="language-plaintext highlighter-rouge">defaultBuildFunction</code> if you don’t want to.  You can allow a city to build the <code class="language-plaintext highlighter-rouge">item</code> by returning <code class="language-plaintext highlighter-rouge">true</code> even if the <code class="language-plaintext highlighter-rouge">defaultBuildFunction</code> would return <code class="language-plaintext highlighter-rouge">false</code>.</p>

<p>Once you’ve written your <code class="language-plaintext highlighter-rouge">canCityBuild</code> function, you would register it using the function call</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">civ</span><span class="p">.</span><span class="n">scen</span><span class="p">.</span><span class="n">onCanBuild</span><span class="p">(</span><span class="n">canCityBuild</span><span class="p">)</span>
</code></pre></div></div>
<h4 id="implementation-37">
  
  
    Implementation <a href="#implementation-37"><span class="self-link">&#128279</span></a>
  
  
</h4>
    

<p>This execution point is implemented with the TOTPP function <code class="language-plaintext highlighter-rouge">civ.scen.onCanBuild</code>.</p>

  </div>
</article>
<!--
    <p>Lua Events function by running code at certain predetermined points during the Civilization II: Test of Time game.  The term “Execution Point”
refers to one of these points where code that has been registered is executed.  Everything that can be achieved with Lua 
must be done through these execution points.  Sometimes, complicated events will use more than one of these execution
points to achieve their effect.</p>

<p>In some cases, the execution point expects code which will return a value that influences how the game works.</p>

<p>The Test of Time Patch Project provides many execution points.  However, in order to improve programming convenience, the Lua Scenario Template
provides even more execution points by running the pre-existing execution points only at certain times.</p>
<h3 id="unit-activation">
  
  
    <a href="#unit-activation">&#128279</a> <strong>Unit Activation</strong>
  
  
</h3>
    
<p>This code is executed whenever a unit is activated or has moved but still has movement points left.
In <code class="language-plaintext highlighter-rouge">LuaParameterFilesparameters.lua</code>, the field <code class="language-plaintext highlighter-rouge">civ.scen.compatibility.activateUnitEveryMove</code> is
set to true.  If this is not done (or in old versions of the Test of Time Patch Project), human
units don’t execute the registered activation code after moving.</p>

<p>This event can optionally return <code class="language-plaintext highlighter-rouge">true</code> or a function.  In either case, the activation of the unit is cancelled.  The movement allowance of the unit’s type will
temporarily be set to 0, and all further code for this event will be cancelled.</p>

<p>If the event returns a function, that function will be called just before the next unit
is activated.  (You may wish to put the unit to sleep, for example.)</p>

<p>Failure to return a value here is equivalent to returning nil, which will make 
the activation code execute as normal.</p>
<h4 id="usage">
  
  
    <a href="#usage">&#128279</a> Usage
  
  
</h4>
    
<h5 id="consolidatedeventslua">
  
  
    <a href="#consolidatedeventslua">&#128279</a> <strong>consolidatedEvents.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Unit Activation</span>
<span class="c1">--Registers a function to be called every time a unit is activated. The callback takes the unit activated as a parameter, and the source of unit activation. `source` is `true` if activated by keyboard or mouse click, `false` if activated by the game itself. `repeatMove` is `true` if it's a repeat activation caused by moving, `false` otherwise.</span>
<span class="c1">--If the function returns true, the unit activation will be cancelled.</span>
<span class="c1">--No further activation code will be executed, and the unit's type</span>
<span class="c1">--will temporarily be set to have 0 movement points.</span>
<span class="c1">--If the function returns function(unit), then the unit activation</span>
<span class="c1">--will be cancelled, and the function returned will be executed</span>
<span class="c1">--just before another unit is activated.  (You may wish to put</span>
<span class="c1">--the unit to sleep, for example.)</span>
<span class="c1">--Not returning anything is equivalent to returning nil, which is</span>
<span class="c1">--acceptable, and keeps the unit activation going.</span>
<span class="k">function</span> <span class="nc">events</span><span class="p">.</span><span class="nf">onActivateUnit</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span><span class="n">source</span><span class="p">,</span><span class="n">repeatMove</span><span class="p">)</span>
    <span class="c1">--civ.ui.text("Unit activation consolidated test")</span>

<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">unit</code> parameter is the unit that has been activated.</p>

<p>The <code class="language-plaintext highlighter-rouge">source</code> parameter is <code class="language-plaintext highlighter-rouge">true</code> if the unit was activated by keyboard or mouse, and
<code class="language-plaintext highlighter-rouge">false</code> if it was activated by the game itself.</p>

<p>The <code class="language-plaintext highlighter-rouge">repeatMove</code> parameter is <code class="language-plaintext highlighter-rouge">true</code> if the execution point is triggered by a repeated activation.</p>
<h5 id="eventsfilesonactivateunitlua">
  
  
    <a href="#eventsfilesonactivateunitlua">&#128279</a> <strong>EventsFiles\onActivateUnit.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">--Registers a function to be called every time a unit is activated. The callback takes the unit activated as a parameter, and the source of unit activation. `source` is `true` if activated by keyboard or mouse click, `false` if activated by the game itself. `repeatMove` is `true` if it's a repeat activation caused by moving, `false` otherwise.</span>
<span class="c1">--If the function returns true, the unit activation will be cancelled.</span>
<span class="c1">--No further activation code will be executed, and the unit's type</span>
<span class="c1">--will temporarily be set to have 0 movement points.</span>
<span class="c1">--If the function returns function(unit), then the unit activation</span>
<span class="c1">--will be cancelled, and the function returned will be executed</span>
<span class="c1">--just before another unit is activated.  (You may wish to put</span>
<span class="c1">--the unit to sleep, for example.)</span>
<span class="c1">--Not returning anything is equivalent to returning nil, which is</span>
<span class="c1">--acceptable, and keeps the unit activation going.</span>
<span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onActivateUnit</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span><span class="n">source</span><span class="p">,</span><span class="n">repeatMove</span><span class="p">)</span>
    <span class="c1">--civ.ui.text("unit activation separate file")</span>

<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">unit</code> parameter is the unit that has been activated.</p>

<p>The <code class="language-plaintext highlighter-rouge">source</code> parameter is <code class="language-plaintext highlighter-rouge">true</code> if the unit was activated by keyboard or mouse, and
<code class="language-plaintext highlighter-rouge">false</code> if it was activated by the game itself.</p>

<p>The <code class="language-plaintext highlighter-rouge">repeatMove</code> parameter is <code class="language-plaintext highlighter-rouge">true</code> if the execution point is triggered by a repeated activation.</p>
<h5 id="discrete-events">
  
  
    <a href="#discrete-events">&#128279</a> <strong>Discrete Events</strong>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete Unit Activation event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">--Registers a function to be called every time a unit is activated. The callback takes the unit activated as a parameter, and the source of unit activation. `source` is `true` if activated by keyboard or mouse click, `false` if activated by the game itself. `repeatMove` is `true` if it's a repeat activation caused by moving, `false` otherwise.</span>
<span class="c1">--If the function returns true, the unit activation will be cancelled.</span>
<span class="c1">--No further activation code will be executed, and the unit's type</span>
<span class="c1">--will temporarily be set to have 0 movement points.</span>
<span class="c1">--If the function returns function(unit), then the unit activation</span>
<span class="c1">--will be cancelled, and the function returned will be executed</span>
<span class="c1">--just before another unit is activated.  (You may wish to put</span>
<span class="c1">--the unit to sleep, for example.)</span>
<span class="c1">--Not returning anything is equivalent to returning nil, which is</span>
<span class="c1">--acceptable, and keeps the unit activation going.</span>
<span class="n">discreteEvents</span><span class="p">.</span><span class="n">onActivateUnit</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span><span class="n">source</span><span class="p">,</span><span class="n">repeatMove</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"Unit activation Discrete Event"</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">unit</code> parameter is the unit that has been activated.</p>

<p>The <code class="language-plaintext highlighter-rouge">source</code> parameter is <code class="language-plaintext highlighter-rouge">true</code> if the unit was activated by keyboard or mouse, and
<code class="language-plaintext highlighter-rouge">false</code> if it was activated by the game itself.</p>

<p>The <code class="language-plaintext highlighter-rouge">repeatMove</code> parameter is <code class="language-plaintext highlighter-rouge">true</code> if the execution point is triggered by a repeated activation.</p>
<h4 id="implementation">
  
  
    <a href="#implementation">&#128279</a> Implementation
  
  
</h4>
    
<p>This execution point is provided by the Test of Time Patch Project function <code class="language-plaintext highlighter-rouge">civ.scen.onActivateUnit</code>.</p>
<h3 id="unit-bribery">
  
  
    <a href="#unit-bribery">&#128279</a> <strong>Unit Bribery</strong>
  
  
</h3>
    
<p>Code will be executed whenever a unit is bribed.</p>
<h4 id="usage-1">
  
  
    <a href="#usage-1">&#128279</a> Usage
  
  
</h4>
    
<h5 id="consolidatedeventslua-1">
  
  
    <a href="#consolidatedeventslua-1">&#128279</a> <strong>consolidatedEvents.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- On Unit Bribery</span>
<span class="k">function</span> <span class="nc">events</span><span class="p">.</span><span class="nf">onBribeUnit</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span><span class="n">previousOwner</span><span class="p">)</span>
    <span class="c1">--civ.ui.text("Bribe unit consolidated test")</span>

<span class="k">end</span>

</code></pre></div></div>
<p>The <code class="language-plaintext highlighter-rouge">unit</code> is the unit that was just bribed.</p>

<p>The <code class="language-plaintext highlighter-rouge">previous owner</code> is the tribe that owned the unit before.</p>
<h5 id="eventsfilesonbribeunitlua">
  
  
    <a href="#eventsfilesonbribeunitlua">&#128279</a> <strong>EventsFiles\onBribeUnit.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onBribeUnit</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span><span class="n">previousOwner</span><span class="p">)</span>
    <span class="c1">--civ.ui.text("On bribe unit separate file")</span>
<span class="k">end</span>

</code></pre></div></div>
<p>The <code class="language-plaintext highlighter-rouge">unit</code> is the unit that was just bribed.</p>

<p>The <code class="language-plaintext highlighter-rouge">previous owner</code> is the tribe that owned the unit before.</p>
<h5 id="discrete-events-1">
  
  
    <a href="#discrete-events-1">&#128279</a> <strong>Discrete Events</strong>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete Unit Bribery event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">discreteEvents</span><span class="p">.</span><span class="n">onBribeUnit</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span><span class="n">previousOwner</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"Bribe unit discrete event test"</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>
<p>The <code class="language-plaintext highlighter-rouge">unit</code> is the unit that was just bribed.</p>

<p>The <code class="language-plaintext highlighter-rouge">previous owner</code> is the tribe that owned the unit before.</p>
<h4 id="implementation-1">
  
  
    <a href="#implementation-1">&#128279</a> Implementation
  
  
</h4>
    
<p>This execution point is provided by the Test of Time Patch Project function <code class="language-plaintext highlighter-rouge">civ.scen.onBribeUnit</code>.</p>
<h3 id="city-yield-calculation">
  
  
    <a href="#city-yield-calculation">&#128279</a> <strong>City Yield Calculation</strong>
  
  
</h3>
    

<p>Allows code to be executed whenever a city computes its production.  This can happen both at the start of the turn, and when the human player opens the city screen.  It can also happen when a player changes the tax rate.</p>

<p>Additionally, the returned values of the registered function
can be used to modify the city’s production.</p>

<p>This execution point registers a function to be called every time a city calculates its total resource yield. The function inputs are the city, and the food, shields and trade of its tiles. Returns a 5-tuple of modifiers, food change, shield change before waste, shield change after waste, trade change before corruption, trade change after corruption. These modifiers are applied at the following points in the calculation:</p>

<ol>
  <li>Calculate yield from all worked tiles</li>
  <li><strong>Run onCalculateCityYield</strong></li>
  <li><strong>Add foodChange, shieldChangeBeforeWaste and tradeChangeBeforeCorruption</strong></li>
  <li>Add changes from food trade routes</li>
  <li>Add shields from improvements</li>
  <li>Calculate and subtract waste</li>
  <li>Calculate corruption and add changes from commodity trade routes</li>
  <li>Calculate corruption again (now using the value after trade routes) and subtract.</li>
  <li><strong>Add shieldChangeAfterWaste and tradeChangeAfterCorruption</strong></li>
  <li>Calculate Tax/Lux/Sci</li>
</ol>
<h4 id="usage-2">
  
  
    <a href="#usage-2">&#128279</a> Usage
  
  
</h4>
    
<h5 id="mechanicsfilescalculatecityyieldlua">
  
  
    <a href="#mechanicsfilescalculatecityyieldlua">&#128279</a> <strong>MechanicsFiles\calculateCityYield.lua</strong>
  
  
</h5>
    
<p>In the <code class="language-plaintext highlighter-rouge">MechanicsFiles</code> folder, change the file called <code class="language-plaintext highlighter-rouge">calculateCityYield.lua</code>.  Change the function <code class="language-plaintext highlighter-rouge">cityYield.onCalculateCityYield</code> in order to change this event.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nc">cityYield</span><span class="p">.</span><span class="nf">onCalculateCityYield</span><span class="p">(</span><span class="n">city</span><span class="p">,</span><span class="n">food</span><span class="p">,</span><span class="n">shields</span><span class="p">,</span><span class="n">trade</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">extraFood</span><span class="p">,</span><span class="n">extraShields</span><span class="p">,</span><span class="n">extraTrade</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span> <span class="c1">-- resources to add to compensate</span>
            <span class="c1">-- for terrain changes made during the city yield calculation</span>
            <span class="c1">-- If you remove the above line, remember to remove the references to</span>
            <span class="c1">-- these variables in the return line at the end of this function</span>
    <span class="c1">-- If you are not making any terrain production value changes in this</span>
    <span class="c1">-- function, you can take out the code below this line and above a</span>
    <span class="c1">-- corresponding line below</span>
    <span class="c1">-- Any changes to terrain production should go here</span>
    
    <span class="c1">-- verify strategic targets, in case terrain changes or something</span>
    <span class="k">if</span> <span class="n">strategicTargetsAvailable</span> <span class="k">then</span>
        <span class="k">for</span> <span class="n">target</span> <span class="k">in</span> <span class="n">strat</span><span class="p">.</span><span class="n">iterateTargets</span><span class="p">(</span><span class="n">city</span><span class="p">)</span> <span class="k">do</span>
            <span class="n">strat</span><span class="p">.</span><span class="n">verifyTarget</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
        <span class="k">end</span>
    <span class="k">end</span>
    


    <span class="c1">-- Any changes to terrain production should be before this line</span>
    <span class="kd">local</span> <span class="n">correctFood</span><span class="p">,</span><span class="n">correctShields</span><span class="p">,</span><span class="n">correctTrade</span> <span class="o">=</span> <span class="n">baseProduction</span><span class="p">(</span><span class="n">city</span><span class="p">,</span><span class="kc">true</span><span class="p">)</span>
    <span class="n">extraFood</span> <span class="o">=</span> <span class="n">correctFood</span><span class="o">-</span><span class="n">food</span>
    <span class="n">food</span> <span class="o">=</span> <span class="n">correctFood</span>
    <span class="n">extraShields</span> <span class="o">=</span> <span class="n">correctShields</span> <span class="o">-</span> <span class="n">shields</span>
    <span class="n">shields</span> <span class="o">=</span> <span class="n">correctShields</span>
    <span class="n">extraTrade</span> <span class="o">=</span> <span class="n">correctTrade</span> <span class="o">-</span> <span class="n">trade</span>
    <span class="n">trade</span> <span class="o">=</span> <span class="n">correctTrade</span>
    <span class="c1">-- If you are not making any terrain production value change in this</span>
    <span class="c1">-- function, you can take out the code above this line and below</span>
    <span class="c1">-- the corresponding line above</span>
    <span class="c1">-- You can take out the lines even if you have a beforeProduction event</span>
    <span class="c1">-- that changes terrain production, since that has been compensated for</span>
    <span class="c1">-- in the events.lua file</span>


    <span class="c1">-- After this point, the variables food, shields, and trade will refer to their</span>
    <span class="c1">-- 'correct' values, even if you've changed terrain production values</span>

    <span class="c1">-- change the values of these variables to reflect the changes you would like to</span>
    <span class="c1">-- make to these different production values</span>
    <span class="kd">local</span> <span class="n">foodChange</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="kd">local</span> <span class="n">shieldChangeBeforeWaste</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">-- changes the value before factory/power plant applied</span>
    <span class="kd">local</span> <span class="n">shieldChangeAfterWaste</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">-- changes the value after factory/power plant applied</span>
    <span class="kd">local</span> <span class="n">tradeChangeBeforeCorruption</span> <span class="o">=</span> <span class="mi">0</span> 
    <span class="kd">local</span> <span class="n">tradeChangeAfterCorruption</span> <span class="o">=</span> <span class="mi">0</span> 

    <span class="k">return</span>  <span class="n">foodChange</span><span class="o">+</span><span class="n">extraFood</span><span class="p">,</span>
            <span class="n">shieldChangeBeforeWaste</span> <span class="o">+</span> <span class="n">extraShields</span><span class="p">,</span>
            <span class="n">shieldChangeAfterWaste</span><span class="p">,</span>
            <span class="n">tradeChangeBeforeCorruption</span><span class="o">+</span> <span class="n">extraTrade</span><span class="p">,</span>
            <span class="n">tradeChangeAfterCorruption</span>
<span class="k">end</span>

</code></pre></div></div>

<p>If you desire to make changes to terrain production, you should do so between the lines
<code class="language-plaintext highlighter-rouge">-- Any changes to terrain production should go here</code>
and
<code class="language-plaintext highlighter-rouge">-- Any changes to terrain production should be before this line</code>.</p>

<p>This is because the <code class="language-plaintext highlighter-rouge">food</code>, <code class="language-plaintext highlighter-rouge">shield</code>, and <code class="language-plaintext highlighter-rouge">trade</code> arguments are computed before any changes are made to terrain production, and so these variables must be updated, which is done by the time the code reaches the lines</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- After this point, the variables food, shields, and trade will refer to their</span>
<span class="c1">-- 'correct' values, even if you've changed terrain production values</span>
</code></pre></div></div>

<p>You may wish to consider using the Custom Cosmic module if you are interested in making changes to terrain production.</p>

<p>If you are interested in making changes to food, shield, or trade production which does not depend on special changes to terrain productivity, you can do so by changing the values of the variables <code class="language-plaintext highlighter-rouge">foodChange</code>, <code class="language-plaintext highlighter-rouge">shieldChangeBeforeWaste</code>, <code class="language-plaintext highlighter-rouge">shieldChangeAfterWaste</code>, <code class="language-plaintext highlighter-rouge">tradeChangeBeforeCorruption</code>, and <code class="language-plaintext highlighter-rouge">tradeChangeAfterCorruption</code>.</p>

<p>Note that there are two different shield changes.  The first one is applied before the factory, power plant, and waste modifications are computed, and the second one is applied after.  The same is true for the trade changes, except that the first one is applied before the corruption is applied, and the second one is applied after the corruption is applied.</p>

<p>The <code class="language-plaintext highlighter-rouge">city</code> parameter is the city whose production is being calculated.</p>

<p>The <code class="language-plaintext highlighter-rouge">food</code> parameter is the amount of food the city is producing.  This is updated part way through the function, to account for any changes to terrain production.</p>

<p>The <code class="language-plaintext highlighter-rouge">shields</code> parameter is the amount of shields the city is producing.  This is updated part way through the function, to account for any changes to terrain production.</p>

<p>The <code class="language-plaintext highlighter-rouge">trade</code> parameter is the amount of trade the city is producing.  This is updated part way through the function, to account for any changes to terrain production.</p>
<h4 id="implementation-2">
  
  
    <a href="#implementation-2">&#128279</a> Implementation
  
  
</h4>
    
<h4 id="implementation-3">
  
  
    <a href="#implementation-3">&#128279</a> Implementation
  
  
</h4>
    

<p>This execution point is implemented using the function <code class="language-plaintext highlighter-rouge">civ.scen.onCalculateCityYield</code>.</p>
<h3 id="centauri-arrival">
  
  
    <a href="#centauri-arrival">&#128279</a> <strong>Centauri Arrival</strong>
  
  
</h3>
    
<p>Executes code when a tribe’s spaceship reaches its target.</p>
<h4 id="usage-3">
  
  
    <a href="#usage-3">&#128279</a> Usage
  
  
</h4>
    
<h5 id="consolidatedeventslua-2">
  
  
    <a href="#consolidatedeventslua-2">&#128279</a> <strong>consolidatedEvents.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- On Centauri Arrival</span>
<span class="c1">-- This is available with games started as an extended original game,</span>
<span class="c1">-- but not with games started as a standard game (I think, this hasn't been looked at too closely)</span>
<span class="k">function</span> <span class="nc">events</span><span class="p">.</span><span class="nf">onCentauriArrival</span><span class="p">(</span><span class="n">tribe</span><span class="p">)</span>
    <span class="c1">--civ.ui.text(tribe.name.." has reached Alpha Centauri.")</span>

<span class="k">end</span>

</code></pre></div></div>
<p>The <code class="language-plaintext highlighter-rouge">tribe</code> is the tribe whose spaceship has reached its destination.</p>
<h5 id="eventsfilesoncentauriarrivallua">
  
  
    <a href="#eventsfilesoncentauriarrivallua">&#128279</a> <strong>EventsFiles\onCentauriArrival.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onCentauriArrival</span><span class="p">(</span><span class="n">tribe</span><span class="p">)</span>
    <span class="c1">--civ.ui.text("centauri arrival separate file")</span>

<span class="k">end</span>

</code></pre></div></div>
<p>The <code class="language-plaintext highlighter-rouge">tribe</code> is the tribe whose spaceship has reached its destination.</p>
<h5 id="discrete-events-2">
  
  
    <a href="#discrete-events-2">&#128279</a> <strong>Discrete Events</strong>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete Centauri Arrival event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">discreteEvents</span><span class="p">.</span><span class="n">onCentauriArrival</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">tribe</span><span class="p">)</span>
    <span class="c1">--civ.ui.text(tribe.name.." arrived at centauri discrete event")</span>
<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>
<p>The <code class="language-plaintext highlighter-rouge">tribe</code> is the tribe whose spaceship has reached its destination.</p>
<h4 id="implementation-4">
  
  
    <a href="#implementation-4">&#128279</a> Implementation
  
  
</h4>
    
<p>This execution point is provided by the Test of Time Patch Project function <code class="language-plaintext highlighter-rouge">civ.scen.onCentauriArrival</code>.</p>
<h3 id="city-destruction">
  
  
    <a href="#city-destruction">&#128279</a> <strong>City Destruction</strong>
  
  
</h3>
    
<p>Executes code when a city is destroyed.</p>
<h4 id="usage-4">
  
  
    <a href="#usage-4">&#128279</a> Usage
  
  
</h4>
    
<h5 id="consolidatedeventslua-3">
  
  
    <a href="#consolidatedeventslua-3">&#128279</a> <strong>consolidatedEvents.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- City destruction</span>
<span class="k">function</span> <span class="nc">events</span><span class="p">.</span><span class="nf">onCityDestroyed</span><span class="p">(</span><span class="n">city</span><span class="p">)</span>
    <span class="c1">--civ.ui.text("City destroyed consolidated test")</span>

<span class="k">end</span>

</code></pre></div></div>
<p>The <code class="language-plaintext highlighter-rouge">city</code> it the city that was just destroyed.</p>
<h5 id="eventsfilesoncitydestroyedlua">
  
  
    <a href="#eventsfilesoncitydestroyedlua">&#128279</a> <strong>EventsFiles\onCityDestroyed.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- This function will be registered for the onCityDestroyed</span>
<span class="c1">-- execution point</span>
<span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onCityDestroyed</span><span class="p">(</span><span class="n">city</span><span class="p">)</span>
    <span class="c1">--civ.ui.text("on city destroyed separate file")</span>
<span class="k">end</span>

</code></pre></div></div>
<p>The <code class="language-plaintext highlighter-rouge">city</code> it the city that was just destroyed.</p>
<h5 id="discrete-events-3">
  
  
    <a href="#discrete-events-3">&#128279</a> <strong>Discrete Events</strong>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete City Destruction event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">discreteEvents</span><span class="p">.</span><span class="n">onCityDestroyed</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">city</span><span class="p">)</span> 
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"City destroyed discrete event test"</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>
<p>The <code class="language-plaintext highlighter-rouge">city</code> it the city that was just destroyed.</p>
<h4 id="implementation-5">
  
  
    <a href="#implementation-5">&#128279</a> Implementation
  
  
</h4>
    
<p>This execution point is provided by the Test of Time Patch Project function <code class="language-plaintext highlighter-rouge">civ.scen.onCityDestroyed</code>.</p>
<h3 id="city-founded">
  
  
    <a href="#city-founded">&#128279</a> <strong>City Founded</strong>
  
  
</h3>
    

<p>Executes code when a city is founded, just before the “What Shall We
 Name This City” dialog box.  You can change the suggested name for the city
at this time by changing the <a href="auto_doc/cityObject.html#name"><code class="language-plaintext highlighter-rouge">city.name</code></a> field.</p>

<p>You can (optionally) return a function to be called if the city is
not built after all (if the city is cancelled during the naming
process).  For example, if you change the terrain under or around the city
when it is founded, you can change it back here.  If you write city founded code in more than one place
(such as multiple discrete events, or using both the Events Files and
consolidated events), all returned functions are executed.</p>
<h4 id="usage-5">
  
  
    <a href="#usage-5">&#128279</a> Usage
  
  
</h4>
    
<h5 id="consolidatedeventslua-4">
  
  
    <a href="#consolidatedeventslua-4">&#128279</a> <strong>consolidatedEvents.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- On City Founded</span>
<span class="k">function</span> <span class="nc">events</span><span class="p">.</span><span class="nf">onCityFounded</span><span class="p">(</span><span class="n">city</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"consolidated.onCityFounded for "</span><span class="o">..</span><span class="n">city</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="c1">-- the cityCancelled() function is executed if the player</span>
    <span class="c1">-- decides not to found the city after all</span>
    <span class="c1">-- (so you can undo terrain changes, etc.</span>
    <span class="kd">local</span> <span class="k">function</span> <span class="nf">cityCancelled</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
            <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"consolidated.onCityFounded city cancelled for "</span><span class="o">..</span><span class="n">city</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">end</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="n">cityCancelled</span>
<span class="k">end</span>

</code></pre></div></div>
<p>The <code class="language-plaintext highlighter-rouge">city</code> is the city that is being founded.</p>
<h5 id="eventsfilesoncityfoundedlua">
  
  
    <a href="#eventsfilesoncityfoundedlua">&#128279</a> <strong>EventsFiles\onCityFounded.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onCityFounded</span><span class="p">(</span><span class="n">city</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"separate file onCityFounded for "</span><span class="o">..</span><span class="n">city</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="c1">-- the cityCancelled() function is executed if the player</span>
    <span class="c1">-- decides not to found the city after all</span>
    <span class="c1">-- (so you can undo terrain changes, etc.</span>
    <span class="kd">local</span> <span class="k">function</span> <span class="nf">cityCancelled</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
            <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"separate file onCityFounded city cancelled for "</span><span class="o">..</span><span class="n">city</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">end</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="n">cityCancelled</span>
<span class="k">end</span>

</code></pre></div></div>
<p>The <code class="language-plaintext highlighter-rouge">city</code> is the city that is being founded.</p>
<h5 id="discrete-events-4">
  
  
    <a href="#discrete-events-4">&#128279</a> <strong>Discrete Events</strong>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete City Founded event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">discreteEvents</span><span class="p">.</span><span class="n">onCityFounded</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">city</span><span class="p">)</span> 
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"discreteEvents.onCityFounded for "</span><span class="o">..</span><span class="n">city</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="c1">-- the cityCancelled() function is executed if the player</span>
    <span class="c1">-- decides not to found the city after all</span>
    <span class="c1">-- (so you can undo terrain changes, etc.</span>
    <span class="kd">local</span> <span class="k">function</span> <span class="nf">cityCancelled</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
            <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"discreteEvents.onCityFounded city cancelled for "</span><span class="o">..</span><span class="n">city</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">end</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="n">cityCancelled</span>
<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>
<p>The <code class="language-plaintext highlighter-rouge">city</code> is the city that is being founded.</p>
<h4 id="implementation-6">
  
  
    <a href="#implementation-6">&#128279</a> Implementation
  
  
</h4>
    
<p>This execution point is provided by the Test of Time Patch Project function <code class="language-plaintext highlighter-rouge">civ.scen.onCityFounded</code>.</p>
<h3 id="city-production">
  
  
    <a href="#city-production">&#128279</a> <strong>City Production</strong>
  
  
</h3>
    
<p>Executes code when a city completes production of something.</p>
<h4 id="usage-6">
  
  
    <a href="#usage-6">&#128279</a> Usage
  
  
</h4>
    
<h5 id="consolidatedeventslua-5">
  
  
    <a href="#consolidatedeventslua-5">&#128279</a> <strong>consolidatedEvents.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- On city production (when a city produces a unit/improvement/wonder)</span>
<span class="k">function</span> <span class="nc">events</span><span class="p">.</span><span class="nf">onCityProduction</span><span class="p">(</span><span class="n">city</span><span class="p">,</span><span class="n">prod</span><span class="p">)</span>
    <span class="c1">--civ.ui.text(city.name.." has procuded something.")</span>

<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">city</code> is the city which just completed production.</p>

<p>The <code class="language-plaintext highlighter-rouge">prod</code> is the item that was produced.  If a unit was produced,
it is a unit Object (not a unitType object).  If an improvement or
wonder was completed, <code class="language-plaintext highlighter-rouge">prod</code> is the corresponding improvement object
 or wonder object.</p>
<h5 id="eventsfilesoncityproductionlua">
  
  
    <a href="#eventsfilesoncityproductionlua">&#128279</a> <strong>EventsFiles\onCityProduction.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nc">onCityProduction</span><span class="p">.</span><span class="nf">onCityProduction</span><span class="p">(</span><span class="n">city</span><span class="p">,</span><span class="n">prod</span><span class="p">)</span>
    <span class="c1">--civ.ui.text("City production separate file")</span>


<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">city</code> is the city which just completed production.</p>

<p>The <code class="language-plaintext highlighter-rouge">prod</code> is the item that was produced.  If a unit was produced,
it is a unit Object (not a unitType object).  If an improvement or
wonder was completed, <code class="language-plaintext highlighter-rouge">prod</code> is the corresponding improvement object
 or wonder object.</p>
<h5 id="discrete-events-5">
  
  
    <a href="#discrete-events-5">&#128279</a> <strong>Discrete Events</strong>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete City Production event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">discreteEvents</span><span class="p">.</span><span class="n">onCityProduction</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">city</span><span class="p">,</span><span class="n">item</span><span class="p">)</span> 
    <span class="c1">--civ.ui.text("City production discrete event test")</span>

<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">city</code> is the city which just completed production.</p>

<p>The <code class="language-plaintext highlighter-rouge">prod</code> is the item that was produced.  If a unit was produced,
it is a unit Object (not a unitType object).  If an improvement or
wonder was completed, <code class="language-plaintext highlighter-rouge">prod</code> is the corresponding improvement object
 or wonder object.</p>
<h4 id="implementation-7">
  
  
    <a href="#implementation-7">&#128279</a> Implementation
  
  
</h4>
    
<p>This execution point is provided by the Test of Time Patch Project function <code class="language-plaintext highlighter-rouge">civ.scen.onCityProduction</code>.</p>
<h3 id="city-captured">
  
  
    <a href="#city-captured">&#128279</a> <strong>City Captured</strong>
  
  
</h3>
    

<p>This execution point is triggered when a city is captured by another tribe.  The execution point takes place after the city has been captured, but before the units supported by the city are disbanded.</p>
<h4 id="usage-7">
  
  
    <a href="#usage-7">&#128279</a> Usage
  
  
</h4>
    
<h5 id="consolidatedeventslua-6">
  
  
    <a href="#consolidatedeventslua-6">&#128279</a> <strong>consolidatedEvents.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- On City Taken</span>
<span class="c1">-- (get conqueror by using city.owner)</span>
<span class="k">function</span> <span class="nc">events</span><span class="p">.</span><span class="nf">onCityTaken</span><span class="p">(</span><span class="n">city</span><span class="p">,</span><span class="n">defender</span><span class="p">)</span>
    <span class="c1">--civ.ui.text(city.name.." captured from the "..defender.name.." by the "..city.owner.name..". Consolidated Events.")</span>

<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">city</code> is the city that was captured.</p>

<p>The <code class="language-plaintext highlighter-rouge">defender</code> is the tribe that owned the city before it was captured.  To get the tribe that captured the city, use <code class="language-plaintext highlighter-rouge">city.owner</code>.</p>
<h5 id="eventsfilesoncitytakenlua">
  
  
    <a href="#eventsfilesoncitytakenlua">&#128279</a> <strong>EventsFiles\onCityTaken.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onCityTaken</span><span class="p">(</span><span class="n">city</span><span class="p">,</span><span class="n">defender</span><span class="p">)</span>
    <span class="c1">--civ.ui.text("city taken separate file test")</span>

<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">city</code> is the city that was captured.</p>

<p>The <code class="language-plaintext highlighter-rouge">defender</code> is the tribe that owned the city before it was captured.  To get the tribe that captured the city, use <code class="language-plaintext highlighter-rouge">city.owner</code>.</p>
<h5 id="discrete-events-6">
  
  
    <a href="#discrete-events-6">&#128279</a> <strong>Discrete Events</strong>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete City Captured event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">discreteEvents</span><span class="p">.</span><span class="n">onCityTaken</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">city</span><span class="p">,</span><span class="n">defender</span><span class="p">)</span> 
    <span class="c1">--civ.ui.text(city.name.." taken from "..defender.name.." discrete event")</span>


<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">city</code> is the city that was captured.</p>

<p>The <code class="language-plaintext highlighter-rouge">defender</code> is the tribe that owned the city before it was captured.  To get the tribe that captured the city, use <code class="language-plaintext highlighter-rouge">city.owner</code>.</p>
<h4 id="implementation-8">
  
  
    <a href="#implementation-8">&#128279</a> Implementation
  
  
</h4>
    
<p>This execution point is provided by the Test of Time Patch Project function <code class="language-plaintext highlighter-rouge">civ.scen.onCityTaken</code>.</p>
<h3 id="city-window-opened">
  
  
    <a href="#city-window-opened">&#128279</a> <strong>City Window Opened</strong>
  
  
</h3>
    

<p>This execution point is triggered when a city window is opened.  Note that the AI does not open city windows.</p>
<h4 id="usage-8">
  
  
    <a href="#usage-8">&#128279</a> Usage
  
  
</h4>
    
<h5 id="eventsfilesoncitywindowopenedlua">
  
  
    <a href="#eventsfilesoncitywindowopenedlua">&#128279</a> <strong>EventsFiles\onCityWindowOpened.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">---Add any events to happen when a city window is opened.</span>
<span class="c1">---(Note that the AI doesn't open city windows.)</span>
<span class="c1">---@param city cityObject The city that is being examined.</span>
<span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onCityWindowOpened</span><span class="p">(</span><span class="n">city</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"eventsFiles\\onCityWindowOpened.lua: onCityWindowOpened called with city: "</span><span class="o">..</span><span class="n">city</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>

</code></pre></div></div>
<p>The <code class="language-plaintext highlighter-rouge">city</code> is the city whose window is being opened.</p>
<h5 id="discrete-events-7">
  
  
    <a href="#discrete-events-7">&#128279</a> <strong>Discrete Events</strong>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete City Window Opened event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Executes when a city window is opened.</span>
<span class="c1">-- Note that the AI doesn't open city windows.</span>
<span class="n">discreteEvents</span><span class="p">.</span><span class="n">onCityWindowOpened</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">city</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"discreteEvents.onCityWindowOpened: The city window for "</span><span class="o">..</span><span class="n">city</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">" has been opened."</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>
<p>The <code class="language-plaintext highlighter-rouge">city</code> is the city whose window is being opened.</p>
<h4 id="implementation-9">
  
  
    <a href="#implementation-9">&#128279</a> Implementation
  
  
</h4>
    

<p>This execution point is implemented using the TOTPP function <code class="language-plaintext highlighter-rouge">civ.scen.onGetFormattedDate</code> and checking if there is currently a city window open by using <code class="language-plaintext highlighter-rouge">civ.getOpenCity</code>.  The most recently opened city is kept track of, to make sure that the execution point is only triggered once per city window, particularly so that a window hidden behind the map doesn’t continuously trigger the execution point.  Closing and opening the same city window will trigger the execution point again.</p>
<h3 id="game-end">
  
  
    <a href="#game-end">&#128279</a> <strong>Game End</strong>
  
  
</h3>
    

<p>This execution point is triggered when the game ends.  If the registered function returns true, then the game actually ends (default behavior).  If the registered function returns false, then the game does not end.  Since there are multiple ways to register a function for this execution point, if any of the registered functions returns false, then the game does not end.</p>
<h4 id="usage-9">
  
  
    <a href="#usage-9">&#128279</a> Usage
  
  
</h4>
    
<h5 id="consolidatedeventslua-7">
  
  
    <a href="#consolidatedeventslua-7">&#128279</a> <strong>consolidatedEvents.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- On Game Ends</span>
<span class="c1">-- Return true if the game ends as normal,</span>
<span class="c1">-- and false otherwise.</span>
<span class="c1">-- This is combined with the discrete events and the</span>
<span class="c1">-- legacy events, as well as a separate onGameEnds.lua file</span>
<span class="c1">-- If any of these return false, then game end is prevented</span>
<span class="c1">-- Lua Function Reference Info:</span>
<span class="c1">--onGameEnds</span>
<span class="c1">--civ.scen.onGameEnds(function (reason) -&gt; boolean) -&gt; void</span>
<span class="c1">--</span>
<span class="c1">--Registers a function that is called when the game ends. `reason` is an integer between 1 and 6:</span>
<span class="c1">--1 and 2 - Space race victory. This does not trigger if `onCentauriArrival` has a callback registered.</span>
<span class="c1">--3 - Conquest victory</span>
<span class="c1">--4 - Defeat</span>
<span class="c1">--5 - Retirement</span>
<span class="c1">--6 - Macro ENDGAME action</span>
<span class="c1">--Return `true` to end the game, `false` to keep playing.</span>
<span class="c1">--</span>
<span class="k">function</span> <span class="nc">events</span><span class="p">.</span><span class="nf">onGameEnds</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">true</span>
<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">reason</code> is an integer with 6 possible values:</p>
<ol>
  <li>Space race victory achieved by the active player.  (Can’t happen if <code class="language-plaintext highlighter-rouge">civ.scen.onCentauriArrival</code> is registered.)</li>
  <li>Space race victory achieved by another player.  (Can’t happen if <code class="language-plaintext highlighter-rouge">civ.scen.onCentauriArrival</code> is registered.)</li>
  <li>Conquest Victory</li>
  <li>Defeat</li>
  <li>Retirement</li>
  <li><a href="auto_doc/civ.html#endGame">civ.endGame</a> was called.  (Or the Macro Language equivalent.)</li>
</ol>
<h5 id="eventsfilesongameendslua">
  
  
    <a href="#eventsfilesongameendslua">&#128279</a> <strong>EventsFiles\onGameEnds.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- discreteEvents.onGameEnds and</span>
<span class="c1">-- consolidated.onGameEnds</span>
<span class="c1">-- also return booleans.  True means that the </span>
<span class="c1">-- game ends as normal, which is the default behaviour.</span>
<span class="c1">-- If any of the registered functions return false, then</span>
<span class="c1">-- the game doesn't end</span>
<span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onGameEnds</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">true</span>
<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">reason</code> is an integer with 6 possible values:</p>
<ol>
  <li>Space race victory achieved by the active player.  (Can’t happen if <code class="language-plaintext highlighter-rouge">civ.scen.onCentauriArrival</code> is registered.)</li>
  <li>Space race victory achieved by another player.  (Can’t happen if <code class="language-plaintext highlighter-rouge">civ.scen.onCentauriArrival</code> is registered.)</li>
  <li>Conquest Victory</li>
  <li>Defeat</li>
  <li>Retirement</li>
  <li><a href="auto_doc/civ.html#endGame">civ.endGame</a> was called.  (Or the Macro Language equivalent.)</li>
</ol>
<h5 id="discrete-events-8">
  
  
    <a href="#discrete-events-8">&#128279</a> <strong>Discrete Events</strong>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete Game End event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- On Game Ends</span>
<span class="c1">-- Return true if the game ends as normal,</span>
<span class="c1">-- and false otherwise.</span>
<span class="c1">-- This is combined with the consolidated events and the</span>
<span class="c1">-- legacy events, as well as a separate onGameEnds.lua file</span>
<span class="c1">-- If any of these return false, then game end is prevented</span>
<span class="c1">-- Not documented or experimented with much</span>
<span class="c1">-- based on legacy event engine code, reason is an integer</span>
<span class="n">discreteEvents</span><span class="p">.</span><span class="n">onGameEnds</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span>
    <span class="c1">-- return false to stop the game from ending</span>
    <span class="k">return</span> <span class="kc">true</span>
<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">reason</code> is an integer with 6 possible values:</p>
<ol>
  <li>Space race victory achieved by the active player.  (Can’t happen if <code class="language-plaintext highlighter-rouge">civ.scen.onCentauriArrival</code> is registered.)</li>
  <li>Space race victory achieved by another player.  (Can’t happen if <code class="language-plaintext highlighter-rouge">civ.scen.onCentauriArrival</code> is registered.)</li>
  <li>Conquest Victory</li>
  <li>Defeat</li>
  <li>Retirement</li>
  <li><a href="auto_doc/civ.html#endGame">civ.endGame</a> was called.  (Or the Macro Language equivalent.)</li>
</ol>
<h4 id="implementation-10">
  
  
    <a href="#implementation-10">&#128279</a> Implementation
  
  
</h4>
    
<p>This execution point is provided by the Test of Time Patch Project function <code class="language-plaintext highlighter-rouge">civ.scen.onGameEnds</code>.</p>
<h3 id="combat-declared">
  
  
    <a href="#combat-declared">&#128279</a> <strong>Combat Declared</strong>
  
  
</h3>
    
<p>When combat is initiated, the function registered for this execution point is called, and returns an iterator (coroutine) which is called for every round of
combat.  Combat will end when the iterator stops returning values (or returns <code class="language-plaintext highlighter-rouge">nil</code>).</p>

<p>The scenario designer can either handle all the effects of combat manually for
a round of combat by telling the iterator to yield true, and the unit over which
the combat ‘explosion’ should be animated.  Alternatively, the coroutine can
return false, along with that round’s combat statistics, and the game’s combat
system will “roll the dice” and determine who should be damaged and where
the combat explosion should be animated.</p>
<h4 id="usage-10">
  
  
    <a href="#usage-10">&#128279</a> Usage
  
  
</h4>
    
<h5 id="mechanicsfilescombatsettingslua">
  
  
    <a href="#mechanicsfilescombatsettingslua">&#128279</a> <strong>MechanicsFiles/combatSettings.lua</strong>
  
  
</h5>
    
<p>In the <code class="language-plaintext highlighter-rouge">MechanicsFiles</code> folder, change the file called <code class="language-plaintext highlighter-rouge">combatSettings.lua</code>.  Change the function <code class="language-plaintext highlighter-rouge">register.onInitiateCombatMakeCoroutine</code> in order to change this event.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onInitiateCombatMakeCoroutine</span><span class="p">(</span><span class="n">attacker</span><span class="p">,</span><span class="n">defender</span><span class="p">,</span><span class="n">attackerDie</span><span class="p">,</span><span class="n">attackerPower</span><span class="p">,</span><span class="n">defenderDie</span><span class="p">,</span><span class="n">defenderPower</span><span class="p">,</span><span class="n">isSneakAttack</span><span class="p">)</span>

    <span class="n">leaderBonus</span><span class="p">.</span><span class="n">updateCommander</span><span class="p">(</span><span class="n">attacker</span><span class="p">)</span>
    <span class="n">leaderBonus</span><span class="p">.</span><span class="n">updateCommander</span><span class="p">(</span><span class="n">defender</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">maxCombatRounds</span> <span class="o">=</span> <span class="nb">math.huge</span> <span class="c1">-- If you want to limit combat to a specific number of</span>
                                        <span class="c1">-- turns, set this variable</span>

    <span class="kd">local</span> <span class="n">calculatedAttackerStrength</span><span class="p">,</span> 
            <span class="n">calculatedAttackerFirepower</span><span class="p">,</span>
            <span class="n">calculatedDefenderStrength</span><span class="p">,</span> 
            <span class="n">calculatedDefenderFirepower</span> <span class="o">=</span> <span class="n">computeCombatStatistics</span><span class="p">(</span><span class="n">attacker</span><span class="p">,</span><span class="n">defender</span><span class="p">,</span><span class="n">isSneakAttack</span><span class="p">)</span>
    <span class="c1">--if calculatedAttackerStrength ~= attackerDie then</span>
    <span class="c1">--    civ.ui.text("Attacker: calculated: "..calculatedAttackerStrength.." actual: "..attackerDie)</span>
    <span class="c1">--end</span>
    <span class="c1">--if calculatedDefenderStrength ~= defenderDie then</span>
    <span class="c1">--    civ.ui.text("Defender: calculated: "..calculatedDefenderStrength.." actual: "..defenderDie)</span>
    <span class="c1">--end</span>
    <span class="c1">--if calculatedAttackerFirepower ~= attackerPower then</span>
    <span class="c1">--    civ.ui.text("AttackerFP: calculated: "..calculatedAttackerFirepower.." actual: "..attackerPower)</span>
    <span class="c1">--end</span>
    <span class="c1">--if calculatedDefenderFirepower ~= defenderPower then</span>
    <span class="c1">--    civ.ui.text("DefenderFP: calculated: "..calculatedDefenderFirepower.." actual: "..defenderPower)</span>
    <span class="c1">--end</span>
    <span class="k">if</span> <span class="n">calculatedAttackerStrength</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">then</span>
        <span class="n">maxCombatRounds</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">attacker</span><span class="p">.</span><span class="n">owner</span><span class="p">.</span><span class="n">isHuman</span> <span class="k">then</span>
            <span class="n">text</span><span class="p">.</span><span class="n">simple</span><span class="p">(</span><span class="s2">"Our "</span><span class="o">..</span><span class="n">attacker</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">" unit can't fight the defending "</span><span class="o">..</span><span class="n">defender</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">".  The attack has been cancelled."</span><span class="p">,</span><span class="s2">"Defense Minister"</span><span class="p">)</span>
        <span class="k">end</span>
    <span class="k">end</span>
    <span class="c1">-- %Report Combat Strength%</span>
    <span class="c1">--civ.ui.text("Attacker: "..tostring(calculatedAttackerStrength/8).." FP:"..calculatedAttackerFirepower.." Defender: "..tostring(calculatedDefenderStrength/8).." FP:"..calculatedDefenderFirepower)</span>
            
    <span class="k">return</span> <span class="nb">coroutine.create</span><span class="p">(</span><span class="k">function</span><span class="p">()</span>
        <span class="kd">local</span> <span class="n">round</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span><span class="p">(</span><span class="n">round</span> <span class="o">&lt;</span> <span class="n">maxCombatRounds</span> <span class="ow">and</span> <span class="n">attacker</span><span class="p">.</span><span class="n">hitpoints</span> <span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">defender</span><span class="p">.</span><span class="n">hitpoints</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">do</span>

            <span class="k">if</span> <span class="kc">false</span> <span class="k">then</span>
                <span class="c1">-- If the coroutine yields true as its first value, </span>
                <span class="c1">-- the game's default combat resolution is skipped for that round </span>
                <span class="c1">-- and the designer is responsible for updating damage. </span>
                <span class="c1">-- The second value yielded is either the attacker or the defender, </span>
                <span class="c1">-- this is used to render animations etc. </span>
                <span class="c1">-- In this case the coroutine resumes without any values.</span>

                <span class="nb">coroutine.yield</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span><span class="n">defender</span><span class="p">)</span>
            <span class="k">else</span>

                <span class="c1">--If the coroutine yields false as its first value, </span>
                <span class="c1">--the game runs its default combat algorithm. The designer </span>
                <span class="c1">--can additionally yield modified values for attackerDie, </span>
                <span class="c1">--attackerPower, defenderDie and defenderPower (in this order) </span>
                <span class="c1">--which will be used by the game for that round.</span>

                <span class="kd">local</span> <span class="n">newAttackerDie</span> <span class="o">=</span> <span class="n">calculatedAttackerStrength</span>
                <span class="kd">local</span> <span class="n">newAttackerFirepower</span> <span class="o">=</span> <span class="n">calculatedAttackerFirepower</span>
                <span class="kd">local</span> <span class="n">newDefenderDie</span> <span class="o">=</span> <span class="n">calculatedDefenderStrength</span>
                <span class="kd">local</span> <span class="n">newDefenderFirepower</span> <span class="o">=</span> <span class="n">calculatedDefenderFirepower</span>
                <span class="kd">local</span> <span class="n">result</span> <span class="o">=</span> <span class="nb">coroutine.yield</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span><span class="n">newAttackerDie</span><span class="p">,</span><span class="n">newAttackerFirepower</span><span class="p">,</span><span class="n">newDefenderDie</span><span class="p">,</span><span class="n">newDefenderFirepower</span><span class="p">)</span>

                <span class="c1">--In this case the coroutine resumes with the result of the round, </span>
                <span class="c1">--a table containing four values:</span>
                    <span class="c1">-- winner, this is either attacker or defender.</span>
                    <span class="c1">-- attackerRoll, the result of the attacker's die roll</span>
                    <span class="c1">-- defenderRoll, the result of the defender's die roll</span>
                    <span class="c1">-- reroll, true if a reroll happened. This can happen only </span>
                         <span class="c1">-- if the attacker is tribe 0, the defender is a unit </span>
                         <span class="c1">-- guarding a city, and the city is the capital or </span>
                         <span class="c1">-- the tribe has less than 8 cities in total and </span>
                         <span class="c1">-- the attacker's die roll is higher than the </span>
                         <span class="c1">-- defender's. A reroll can happen at most once.</span>


            <span class="k">end</span>
            <span class="n">round</span> <span class="o">=</span> <span class="n">round</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">end</span>
        <span class="c1">-- once we get here, combat stops</span>
    <span class="k">end</span><span class="p">)</span>
<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">attacker</code> is the unit which is attacking.</p>

<p>The <code class="language-plaintext highlighter-rouge">defender</code> is the unit which is being attacked.</p>

<p>The <code class="language-plaintext highlighter-rouge">attackerDie</code> is the the game’s standard calculation for the attack value of the attacker.</p>

<p>The <code class="language-plaintext highlighter-rouge">attackerPower</code> is the attackers firepower, as determined by the game’s standard calculations.</p>

<p>The <code class="language-plaintext highlighter-rouge">defenderDie</code> is the the game’s standard calculation for the defense value of the defender.</p>

<p>The <code class="language-plaintext highlighter-rouge">defenderPower</code> is the defenders firepower, as determined by the game’s standard calculations.</p>

<p>The <code class="language-plaintext highlighter-rouge">isSneakAttack</code> parameter is true if a “sneak attack” is in progress. That is, If the attacker is conducting a sneak attack (i.e., breaking a Cease Fire or Peace Treaty) and the defender belongs to a tribe controlled by a human player, the attacker receives a x2 adjustment (bonus).</p>

<p>A round of combat can be thought of as the attacker rolling an attackerDie-sided die, and the defender rolling a defenderDie-sided die.  The attacker’s roll is compared to the defender’s roll, and the higher number wins
that round of combat (if the rolls are equal, the defender wins).  The loser</p>

<p>This function and the iterator returned can be heavily modified depending on how the scenario designer wants combat to happen.  What follows describes 
are notes on the default behaviour.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">leaderBonus</span><span class="p">.</span><span class="n">updateCommander</span><span class="p">(</span><span class="n">attacker</span><span class="p">)</span>
    <span class="n">leaderBonus</span><span class="p">.</span><span class="n">updateCommander</span><span class="p">(</span><span class="n">defender</span><span class="p">)</span>
</code></pre></div></div>
<p>Here, the Leader Bonus Module confirms that the units have the correct leader.  (If you’re not using the Leader Bonus Module, then this doesn’t matter.)</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kd">local</span> <span class="n">maxCombatRounds</span> <span class="o">=</span> <span class="nb">math.huge</span> <span class="c1">-- If you want to limit combat to a specific number of</span>
                                        <span class="c1">-- turns, set this variable</span>
</code></pre></div></div>

<p>This variable is used to limit the number of rounds of combat.  If you want to limit combat to a specific number of turns, set this variable.  Otherwise, it will be set to infinity (in which case, hp reduction will end combat).</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kd">local</span> <span class="n">calculatedAttackerStrength</span><span class="p">,</span> 
            <span class="n">calculatedAttackerFirepower</span><span class="p">,</span>
            <span class="n">calculatedDefenderStrength</span><span class="p">,</span> 
            <span class="n">calculatedDefenderFirepower</span> <span class="o">=</span> <span class="n">computeCombatStatistics</span><span class="p">(</span><span class="n">attacker</span><span class="p">,</span><span class="n">defender</span><span class="p">,</span><span class="n">isSneakAttack</span><span class="p">)</span>
</code></pre></div></div>

<p>Instead of relying on the game’s standard calculations of combat strength,
this code uses the function <code class="language-plaintext highlighter-rouge">computeCombatStatistics</code> (found earlier in the same file) to calculate the
statistics.  By default, this function takes account of combat changes
defined in other modules (such as the Combat Modifiers Module) and
combines them with <a href="https://forums.civfanatics.com/threads/civilization-ii-combat-guide-v2-0-updates.673992/">Knighttime’s combat calculation code</a>.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">if</span> <span class="n">calculatedAttackerStrength</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">then</span>
        <span class="n">maxCombatRounds</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">attacker</span><span class="p">.</span><span class="n">owner</span><span class="p">.</span><span class="n">isHuman</span> <span class="k">then</span>
            <span class="n">text</span><span class="p">.</span><span class="n">simple</span><span class="p">(</span><span class="s2">"Our "</span><span class="o">..</span><span class="n">attacker</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">" unit can't fight the defending "</span><span class="o">..</span><span class="n">defender</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">".  The attack has been cancelled."</span><span class="p">,</span><span class="s2">"Defense Minister"</span><span class="p">)</span>
        <span class="k">end</span>
    <span class="k">end</span>
</code></pre></div></div>

<p>In the standard Civilization II game, units with 0 attack are unable to initiate combat.  However, it may be that the <code class="language-plaintext highlighter-rouge">computeCombatStatistics</code>
gives a unit 0 attack, even though the unit type normally can make attacks (for example, if a unit is ineffective against a particular defender).  In this case, the code sets the maximum number of combat rounds to 0, thereby stopping the attack, and displays a message to the human player.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1">-- %Report Combat Strength%</span>
    <span class="c1">--civ.ui.text("Attacker: "..tostring(calculatedAttackerStrength/8).." FP:"..calculatedAttackerFirepower.." Defender: "..tostring(calculatedDefenderStrength/8).." FP:"..calculatedDefenderFirepower)</span>
</code></pre></div></div>

<p>Comment out this line if you don’t want a text box to display the combat statistics.  Having this active during development is likely to be useful,
but you will probably want to do something fancier if you intend to display
combat statistics in your final release.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="k">while</span><span class="p">(</span><span class="n">round</span> <span class="o">&lt;</span> <span class="n">maxCombatRounds</span> <span class="ow">and</span> <span class="n">attacker</span><span class="p">.</span><span class="n">hitpoints</span> <span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">defender</span><span class="p">.</span><span class="n">hitpoints</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">do</span>
</code></pre></div></div>

<p>This is the main loop of the combat.  Combat will continue until the maximum number of combat rounds is reached, or until one of the units is killed.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">if</span> <span class="kc">false</span> <span class="k">then</span>
        <span class="c1">-- If the coroutine yields true as its first value, </span>
        <span class="c1">-- the game's default combat resolution is skipped for that round </span>
        <span class="c1">-- and the designer is responsible for updating damage. </span>
        <span class="c1">-- The second value yielded is either the attacker or the defender, </span>
        <span class="c1">-- this is used to render animations etc. </span>
        <span class="c1">-- In this case the coroutine resumes without any values.</span>

        <span class="nb">coroutine.yield</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span><span class="n">defender</span><span class="p">)</span>
</code></pre></div></div>

<p>By default, the combat iterator won’t return true.  If the coroutine yields true as its first value, the game’s default combat resolution is skipped for that round and the designer is responsible for updating damage.  The second value yielded is either the attacker or the defender, this is used to render animations etc.  In this case the coroutine resumes without any values.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1">--If the coroutine yields false as its first value, </span>
    <span class="c1">--the game runs its default combat algorithm. The designer </span>
    <span class="c1">--can additionally yield modified values for attackerDie, </span>
    <span class="c1">--attackerPower, defenderDie and defenderPower (in this order) </span>
    <span class="c1">--which will be used by the game for that round.</span>

    <span class="kd">local</span> <span class="n">newAttackerDie</span> <span class="o">=</span> <span class="n">calculatedAttackerStrength</span>
    <span class="kd">local</span> <span class="n">newAttackerFirepower</span> <span class="o">=</span> <span class="n">calculatedAttackerFirepower</span>
    <span class="kd">local</span> <span class="n">newDefenderDie</span> <span class="o">=</span> <span class="n">calculatedDefenderStrength</span>
    <span class="kd">local</span> <span class="n">newDefenderFirepower</span> <span class="o">=</span> <span class="n">calculatedDefenderFirepower</span>
    <span class="kd">local</span> <span class="n">result</span> <span class="o">=</span> <span class="nb">coroutine.yield</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span><span class="n">newAttackerDie</span><span class="p">,</span><span class="n">newAttackerFirepower</span><span class="p">,</span><span class="n">newDefenderDie</span><span class="p">,</span><span class="n">newDefenderFirepower</span><span class="p">)</span>

    <span class="c1">--In this case the coroutine resumes with the result of the round, </span>
    <span class="c1">--a table containing four values:</span>
        <span class="c1">-- winner, this is either attacker or defender.</span>
        <span class="c1">-- attackerRoll, the result of the attacker's die roll</span>
        <span class="c1">-- defenderRoll, the result of the defender's die roll</span>
        <span class="c1">-- reroll, true if a reroll happened. This can happen only </span>
             <span class="c1">-- if the attacker is tribe 0, the defender is a unit </span>
             <span class="c1">-- guarding a city, and the city is the capital or </span>
             <span class="c1">-- the tribe has less than 8 cities in total and </span>
             <span class="c1">-- the attacker's die roll is higher than the </span>
             <span class="c1">-- defender's. A reroll can happen at most once.</span>
</code></pre></div></div>

<p>By default, the combat iterator will yield false as its first value.  The game
will run standard combat calculations based on the values assigned to
<code class="language-plaintext highlighter-rouge">newAttackerDie</code>, <code class="language-plaintext highlighter-rouge">newAttackerFirepower</code>, <code class="language-plaintext highlighter-rouge">newDefenderDie</code> and <code class="language-plaintext highlighter-rouge">newDefenderFirepower</code>.  Change these from their calculated values if
you want to change combat effectiveness based on events that happen during combat.</p>

<p>The <code class="language-plaintext highlighter-rouge">result</code> variable will contain the result of the round, a table containing four values assigned to the keys <code class="language-plaintext highlighter-rouge">winner</code>, <code class="language-plaintext highlighter-rouge">attackerRoll</code>, <code class="language-plaintext highlighter-rouge">defenderRoll</code> and <code class="language-plaintext highlighter-rouge">reroll</code>.  <code class="language-plaintext highlighter-rouge">winner</code> will be either <code class="language-plaintext highlighter-rouge">attacker</code> or <code class="language-plaintext highlighter-rouge">defender</code>.  <code class="language-plaintext highlighter-rouge">attackerRoll</code> and <code class="language-plaintext highlighter-rouge">defenderRoll</code> will be the results of the die rolls.  <code class="language-plaintext highlighter-rouge">reroll</code> will be <code class="language-plaintext highlighter-rouge">true</code> if a reroll happened. This can happen only if the attacker is tribe 0, the defender is a unit guarding a city, and the city is the capital or the tribe has less than 8 cities in total and the attacker’s die roll is higher than the defender’s. A reroll can happen at most once.</p>
<h4 id="implementation-11">
  
  
    <a href="#implementation-11">&#128279</a> Implementation
  
  
</h4>
    

<p>This execution point is implemented using the TOTPP function <code class="language-plaintext highlighter-rouge">civ.scen.onInitiateCombat</code>.</p>
<h3 id="key-press">
  
  
    <a href="#key-press">&#128279</a> <strong>Key Press</strong>
  
  
</h3>
    

<p>The Key Press execution point is triggered every time a key is pressed.  A code for the key that
was pressed is passed to the registered function.  The <a href="auto_doc/keyboard.html">keyboard module</a> provides a table of codes with human readable index values.</p>

<p>Many key press events are registered in the file <code class="language-plaintext highlighter-rouge">MechanicsFiles\keyPressSettings.lua</code>.</p>
<h4 id="usage-11">
  
  
    <a href="#usage-11">&#128279</a> Usage
  
  
</h4>
    
<h5 id="consolidatedeventslua-8">
  
  
    <a href="#consolidatedeventslua-8">&#128279</a> <strong>consolidatedEvents.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- On key press</span>
<span class="k">function</span> <span class="nc">events</span><span class="p">.</span><span class="nf">onKeyPress</span><span class="p">(</span><span class="n">keyCode</span><span class="p">)</span>
    <span class="c1">--if keyCode == keyboard.backspace then</span>
    <span class="c1">--    civ.ui.text("backspace pressed")</span>
    <span class="c1">--end</span>

<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">keyCode</code> parameter is an integer corresponding to a keyboard key.</p>
<h5 id="eventsfilesonkeypresslua">
  
  
    <a href="#eventsfilesonkeypresslua">&#128279</a> <strong>EventsFiles\onKeyPress.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onKeyPress</span><span class="p">(</span><span class="n">keyCode</span><span class="p">)</span>
    <span class="c1">--civ.ui.text("key press test separate file")</span>
<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">keyCode</code> parameter is an integer corresponding to a keyboard key.</p>
<h5 id="discrete-events-9">
  
  
    <a href="#discrete-events-9">&#128279</a> <strong>Discrete Events</strong>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete Key Press event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- The keyCode is an integer that corresponds to a particular key on the keyboard.</span>
<span class="c1">-- The keyboard module provides names for these codes.</span>
<span class="n">discreteEvents</span><span class="p">.</span><span class="n">onKeyPress</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">keyCode</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="ow">and</span> <span class="n">keyboard</span><span class="p">.</span><span class="n">backspace</span> <span class="o">==</span> <span class="n">keyCode</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"discreteEvents.onKeyPress: The backspace key has been pressed."</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">keyCode</code> parameter is an integer corresponding to a keyboard key.</p>
<h4 id="implementation-12">
  
  
    <a href="#implementation-12">&#128279</a> Implementation
  
  
</h4>
    
<p>This execution point is provided by the Test of Time Patch Project function <code class="language-plaintext highlighter-rouge">civ.scen.onKeyPress</code>.</p>
<h3 id="game-loaded">
  
  
    <a href="#game-loaded">&#128279</a> <strong>Game Loaded</strong>
  
  
</h3>
    

<p>The Game Loaded execution point is triggered when a game is loaded from a saved game file.  This happens after the <code class="language-plaintext highlighter-rouge">events.lua</code> file is executed, and before the Scenario Loaded execution point is triggered.  The main purpose of this execution point is to read data which has been added to the saved game file by the Game Saved execution point, and convert it back to a table (known as the “state table”, so that Lua events can have custom data saved between sessions.</p>
<h4 id="usage-12">
  
  
    <a href="#usage-12">&#128279</a> Usage
  
  
</h4>
    
<h5 id="eventslua">
  
  
    <a href="#eventslua">&#128279</a> <strong>events.lua</strong>
  
  
</h5>
    

<p>The Game Loaded execution point is not meant to be used by scenario designers.  The Scenario Loaded execution point is preferred.  That is why it is only accessible through the <code class="language-plaintext highlighter-rouge">events.lua</code> file.  However, if you need to change it for some reason, you should change ths
code within that file:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="k">function</span> <span class="nf">doOnLoad</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span><span class="c1">--&gt;void</span>
    <span class="c1">-- if buffer is compressed, it is decompressed, otherwise the</span>
    <span class="c1">-- buffer itself is used</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">civlua</span><span class="p">.</span><span class="n">unserialize</span><span class="p">(</span><span class="n">lualzw</span><span class="p">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="ow">or</span> <span class="n">buffer</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">stateTableKeys</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">discreteEvents</span><span class="p">.</span><span class="n">performLinkStateToModules</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="n">stateTableKeys</span><span class="p">)</span>
    <span class="c1">--linkStateTableToModules()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Enter console.commands() to see a list of keys in the console table.  Some give access to functions in modules, others will run event code."</span><span class="p">)</span>
<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">buffer</code> is a string, which will be converted back into the state
table using <code class="language-plaintext highlighter-rouge">civlua.unserialize</code>.  This template uses the lualzw module
to compress the data, so it is decompressed here as well.  (If the data isn’t
compressed, <code class="language-plaintext highlighter-rouge">lualzw.decompress</code> returns <code class="language-plaintext highlighter-rouge">nil</code>, so the raw string is used instead.)</p>
<h5 id="discrete-events-10">
  
  
    <a href="#discrete-events-10">&#128279</a> <strong>Discrete Events</strong>
  
  
</h5>
    

<p>The Discrete Events module allows access to the Game Loaded execution point.  This
is so that scenario modules can save data between sessions, by linking to the
state table.  The state table is a table which is saved to the saved game file.</p>

<p>Here is an example of how to use <code class="language-plaintext highlighter-rouge">discreteEvents.linkStateToModules</code> to provide access to the state table within a module.  This code is from the <code class="language-plaintext highlighter-rouge">LuaCore
avy.lua</code> file:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">):</span><span class="n">minVersion</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<p>This module needs to keep track of whether a ship can unload, because there are
circumstances where a unit has the ability to unload for the rest of the turn,
even though the function determining if the unit can unload would no longer 
return true.  Since we want this to persist between saving and loading, we
must use the state table.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">canUnload</span> <span class="o">=</span> <span class="s2">"state not linked"</span>
<span class="c1">-- canUnload[unit.id] = tileID or nil</span>
<span class="c1">-- a unit in this table can unload itself or carried units even</span>
<span class="c1">-- if it otherwise wouldn't be able to, as long</span>
<span class="c1">-- as it is still on the tile specified</span>
</code></pre></div></div>

<p>Here, the variable <code class="language-plaintext highlighter-rouge">canUnload</code> is defined.  At the moment, it is a string,
but during the Game Loaded execution point, the variable’s value will be
changed to one of the tables in the state table.  So, any functions
in this module can treat this variable as a table, as long as they are not
called until after the Game Loaded execution point has passed.</p>

<p>We need to write a “link state” function to associate the variable with the
an appropriate table in the state table.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nc">navy</span><span class="p">.</span><span class="nf">linkState</span><span class="p">(</span><span class="n">canUnloadTableFromState</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">canUnloadTableFromState</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"table"</span> <span class="k">then</span>
        <span class="n">canUnload</span> <span class="o">=</span> <span class="n">canUnloadTableFromState</span>
    <span class="k">else</span>
        <span class="nb">error</span><span class="p">(</span><span class="s2">"navy.linkState: table expected as argument.  Received: "</span><span class="o">..</span><span class="nb">tostring</span><span class="p">(</span><span class="n">canUnloadTableFromState</span><span class="p">))</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>When called, this function assigns the <code class="language-plaintext highlighter-rouge">canUnloadTableFromState</code> as the value
for the canUnload variable.  An error is generated if it isn’t an actual table.</p>

<p>Next, we register an event using <code class="language-plaintext highlighter-rouge">discreteEvents.linkStateToModules</code>:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">discreteEvents</span><span class="p">.</span><span class="n">linkStateToModules</span><span class="p">(</span> <span class="k">function</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="n">stateTableKeys</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">keyName</span> <span class="o">=</span> <span class="s2">"navyModuleState"</span>
    <span class="k">if</span> <span class="n">stateTableKeys</span><span class="p">[</span><span class="n">keyName</span><span class="p">]</span> <span class="k">then</span>
        <span class="nb">error</span><span class="p">(</span><span class="s1">'"'</span><span class="o">..</span><span class="n">keyName</span><span class="o">..</span><span class="s1">'" is used as a key for the state table on at least two occasions.'</span><span class="p">)</span>
    <span class="k">else</span>
        <span class="n">stateTableKeys</span><span class="p">[</span><span class="n">keyName</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="k">end</span>
    <span class="c1">-- link the state table to the module</span>
    <span class="n">state</span><span class="p">[</span><span class="n">keyName</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="n">keyName</span><span class="p">]</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="n">navy</span><span class="p">.</span><span class="n">linkState</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="n">keyName</span><span class="p">])</span>
<span class="k">end</span><span class="p">)</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">discreteEvents.linkStateToModules</code> event provides the entire state table as the first argument, and a table containing the names of all the keys in the state table as the second argument (in the form stateTableKeys[keyName] = true).</p>

<p>In this function, we decide that the table for this module will have the key
“navyModuleState” in the overall state table.  Next, we check to see if that
key is already in use.  If it is, we generate an error.  If it isn’t, we add
it to the list of keys in use.</p>

<p>Next, we make sure that the table for this module exists in the state table.
If it doesn’t, we create an empty table for it.  Finally, we call the <code class="language-plaintext highlighter-rouge">navy.linkState</code> function defined earlier, passing the table for this module as the argument.</p>
<h4 id="implementation-13">
  
  
    <a href="#implementation-13">&#128279</a> Implementation
  
  
</h4>
    

<p>This execution point is implemented using the TOTPP function <code class="language-plaintext highlighter-rouge">civ.scen.onLoad</code>.</p>
<h3 id="game-saved">
  
  
    <a href="#game-saved">&#128279</a> <strong>Game Saved</strong>
  
  
</h3>
    

<p>The Game Saved execution point is triggered when a game is saved to a
file.  As part of this process, the state table is converted to a string
and saved to the file.    The Game Loaded execution point
converts the string back into a table, once the game is loaded.</p>

<p>Strictly speaking, any string could be saved to
the end of the file, but the Lua Scenario Template saves the state table and
I know of no scenarios where something other than
a string conversion of the state table is saved.</p>

<p>In the Lua Scenario Template, the saved string is compressed using the
lualzw module.  This is done to reduce the size of the saved game file.</p>
<h4 id="usage-13">
  
  
    <a href="#usage-13">&#128279</a> Usage
  
  
</h4>
    
<h5 id="eventslua-1">
  
  
    <a href="#eventslua-1">&#128279</a> <strong>events.lua</strong>
  
  
</h5>
    

<p>If you need to change the string that is saved to the file, you must
change this code within the <code class="language-plaintext highlighter-rouge">events.lua</code> file:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="k">function</span> <span class="nf">doOnSave</span><span class="p">()</span> <span class="c1">--&gt; string</span>
    <span class="n">discreteEvents</span><span class="p">.</span><span class="n">performOnSave</span><span class="p">()</span>
    <span class="c1">-- compress the text representation of the state table, so saved game files are smaller</span>
    <span class="k">return</span> <span class="n">lualzw</span><span class="p">.</span><span class="n">compress</span><span class="p">(</span><span class="n">civlua</span><span class="p">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
<span class="k">end</span>

</code></pre></div></div>

<p>This will probably never be necessary, since you can simply add some
extra information as an entry in the state table.  Accessing this
execution point through using the Discrete Events module does not
let you change the string that is saved to the file.</p>
<h5 id="discrete-events-11">
  
  
    <a href="#discrete-events-11">&#128279</a> <strong>Discrete Events</strong>
  
  
</h5>
    

<p>The Discrete Events module allows access to the Game Saved execution point 
by registering code using the function <code class="language-plaintext highlighter-rouge">discreteEvents.onSave</code>.  The
registered function receives no arguments.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">discreteEvents</span><span class="p">.</span><span class="n">onSave</span><span class="p">(</span> <span class="k">function</span><span class="p">()</span>
    <span class="c1">-- code to execute when the game is saved</span>
<span class="k">end</span><span class="p">)</span>
</code></pre></div></div>
<h4 id="implementation-14">
  
  
    <a href="#implementation-14">&#128279</a> Implementation
  
  
</h4>
    

<p>This execution point is implemented using the TOTPP function <code class="language-plaintext highlighter-rouge">civ.scen.onSave</code>.</p>
<h3 id="scenario-loaded">
  
  
    <a href="#scenario-loaded">&#128279</a> <strong>Scenario Loaded</strong>
  
  
</h3>
    

<p>The Scenario Loaded execution point is triggered when the game is loaded, but before anything else happens.  Despite its name, it is not triggered solely by starting a new scenario.  It is also triggered when a save file is loaded.</p>

<p>The Scenario Loaded execution point is triggered after the Game Loaded execution point.</p>
<h4 id="usage-14">
  
  
    <a href="#usage-14">&#128279</a> Usage
  
  
</h4>
    
<h5 id="consolidatedeventslua-9">
  
  
    <a href="#consolidatedeventslua-9">&#128279</a> <strong>consolidatedEvents.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- On Scenario Loaded</span>
<span class="k">function</span> <span class="nc">events</span><span class="p">.</span><span class="nf">onScenarioLoaded</span><span class="p">()</span>
    <span class="c1">--civ.ui.text("Scenario Loaded consolidated event")</span>

<span class="k">end</span>

</code></pre></div></div>
<h5 id="eventsfilesonscenarioloadedlua">
  
  
    <a href="#eventsfilesonscenarioloadedlua">&#128279</a> <strong>EventsFiles\onScenarioLoaded.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onScenarioLoaded</span><span class="p">()</span>
    <span class="c1">--civ.ui.text("on scenario loaded separate event file")</span>

<span class="k">end</span>

</code></pre></div></div>
<h5 id="discrete-events-12">
  
  
    <a href="#discrete-events-12">&#128279</a> <strong>Discrete Events</strong>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete Scenario Loaded event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">discreteEvents</span><span class="p">.</span><span class="n">onScenarioLoaded</span><span class="p">(</span><span class="k">function</span><span class="p">()</span> 
    <span class="c1">--civ.ui.text("discrete event on scenario loaded")</span>

<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>
<h4 id="implementation-15">
  
  
    <a href="#implementation-15">&#128279</a> Implementation
  
  
</h4>
    
<p>This execution point is provided by the Test of Time Patch Project function <code class="language-plaintext highlighter-rouge">civ.scen.onScenarioLoaded</code>.</p>
<h3 id="negotiation">
  
  
    <a href="#negotiation">&#128279</a> <strong>Negotiation</strong>
  
  
</h3>
    

<p>This execution point is triggered when a tribe (the <code class="language-plaintext highlighter-rouge">talker</code>) attempts
to negotiate with a different tribe (the <code class="language-plaintext highlighter-rouge">listener</code>).  If the registered
function returns <code class="language-plaintext highlighter-rouge">true</code>, the tribes can talk.  If <code class="language-plaintext highlighter-rouge">false</code>,
they can’t (and won’t appear in the foreign minister menu).</p>

<p>The Lua Scenario Template offers multiple ways to register functions
for this execution point.  If any of them return false, then negotiation
between the two parties is disabled.</p>
<h4 id="usage-15">
  
  
    <a href="#usage-15">&#128279</a> Usage
  
  
</h4>
    
<h5 id="consolidatedeventslua-10">
  
  
    <a href="#consolidatedeventslua-10">&#128279</a> <strong>consolidatedEvents.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- On Negotiation </span>
<span class="c1">-- Return true if the talker can contact the listener,</span>
<span class="c1">-- and false otherwise.</span>
<span class="c1">-- This is combined with the discrete events and the</span>
<span class="c1">-- legacy events, as well as a separate onNegotiation.lua file</span>
<span class="c1">-- If any of these return false, then negotiation is prevented</span>
<span class="k">function</span> <span class="nc">events</span><span class="p">.</span><span class="nf">onNegotiation</span><span class="p">(</span><span class="n">talker</span><span class="p">,</span><span class="n">listener</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">true</span>
<span class="k">end</span>

</code></pre></div></div>
<h5 id="eventsfilesonnegotiationlua">
  
  
    <a href="#eventsfilesonnegotiationlua">&#128279</a> <strong>EventsFiles\onNegotiation.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- discreteEvents.onNegotiation and</span>
<span class="c1">-- consolidated.onNegotiation</span>
<span class="c1">-- also return booleans.  True means that the talker</span>
<span class="c1">-- can begin negotiations with the listener.</span>
<span class="c1">-- If any of the events return false, negotiations are</span>
<span class="c1">-- prevented, even if other negotiation events return true</span>
<span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onNegotiation</span><span class="p">(</span><span class="n">talker</span><span class="p">,</span><span class="n">listener</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">true</span>
<span class="k">end</span>

</code></pre></div></div>
<h5 id="discrete-events-13">
  
  
    <a href="#discrete-events-13">&#128279</a> <strong>Discrete Events</strong>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete Negotiation event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- On Negotiation </span>
<span class="c1">-- Return true if the talker can contact the listener,</span>
<span class="c1">-- and false otherwise.</span>
<span class="c1">-- This is combined with the consolidated events and the</span>
<span class="c1">-- legacy events, as well as a separate onNegotiation.lua file</span>
<span class="c1">-- If any of these return false, then negotiation is prevented</span>
<span class="n">discreteEvents</span><span class="p">.</span><span class="n">onNegotiation</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">talker</span><span class="p">,</span><span class="n">listener</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">true</span>
<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>
<h4 id="implementation-16">
  
  
    <a href="#implementation-16">&#128279</a> Implementation
  
  
</h4>
    
<p>This execution point is provided by the Test of Time Patch Project function <code class="language-plaintext highlighter-rouge">civ.scen.onNegotiation</code>.</p>
<h3 id="tribe-schism">
  
  
    <a href="#tribe-schism">&#128279</a> <strong>Tribe Schism</strong>
  
  
</h3>
    

<p>The code from this execution point is executed when a <code class="language-plaintext highlighter-rouge">tribe</code> could be split
because its capital is taken.  The event will trigger even if there is no
free civ slot for the rebel tribe to occupy, but will not occur
if a schism is not possible because of other schism mechanics.</p>

<p>If the registered function returns <code class="language-plaintext highlighter-rouge">true</code>, then the schism is allowed
(as long as there is an empty tribe slot).  If <code class="language-plaintext highlighter-rouge">false</code> is returned, 
then schism is prevented.</p>

<p>The Lua Scenario Template offers multiple ways to register functions
for this execution point.  If any of them return false, then schism
is prevented in this instance.</p>

<p>I think (but don’t know for sure) that the requirements for a schism
are that:</p>
<ol>
  <li>The tribe capturing the capital must have a weaker power rating than the defending tribe.</li>
  <li>The defending tribe must be controlled by an AI.</li>
</ol>
<h4 id="usage-16">
  
  
    <a href="#usage-16">&#128279</a> Usage
  
  
</h4>
    
<h5 id="consolidatedeventslua-11">
  
  
    <a href="#consolidatedeventslua-11">&#128279</a> <strong>consolidatedEvents.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- On Schism </span>
<span class="c1">-- Return true (default) if the tribe can schism,</span>
<span class="c1">-- and false otherwise.</span>
<span class="c1">-- This is combined with the discrete events and the</span>
<span class="c1">-- legacy events, as well as a separate onSchism.lua file</span>
<span class="c1">-- If any of these return false, then schism is prevented</span>
<span class="k">function</span> <span class="nc">events</span><span class="p">.</span><span class="nf">onSchism</span><span class="p">(</span><span class="n">tribe</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">true</span>
<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">tribe</code> is the tribe that just lost its capital and will undergo schism if there is an available tribe slot (unless this
event prevents it).</p>
<h5 id="eventsfilesonschismlua">
  
  
    <a href="#eventsfilesonschismlua">&#128279</a> <strong>EventsFiles\onSchism.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- discreteEvents.onSchism and</span>
<span class="c1">-- consolidated.onSchism</span>
<span class="c1">-- also return booleans.  True means that the tribe can schism</span>
<span class="c1">-- (default behaviour).</span>
<span class="c1">-- If any of the events return false, schism is </span>
<span class="c1">-- prevented, even if other schism events return true</span>
<span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onSchism</span><span class="p">(</span><span class="n">tribe</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">true</span>
<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">tribe</code> is the tribe that just lost its capital and will undergo schism if there is an available tribe slot (unless this
event prevents it).</p>
<h5 id="discrete-events-14">
  
  
    <a href="#discrete-events-14">&#128279</a> <strong>Discrete Events</strong>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete Tribe Schism event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- On Schism </span>
<span class="c1">-- Return true (default) if the tribe can schism,</span>
<span class="c1">-- and false otherwise.</span>
<span class="c1">-- This is combined with the consolidated events and the</span>
<span class="c1">-- legacy events, as well as a separate onSchism.lua file</span>
<span class="c1">-- If any of these return false, then schism is prevented</span>
<span class="n">discreteEvents</span><span class="p">.</span><span class="n">onSchism</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">tribe</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">true</span>
<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">tribe</code> is the tribe that just lost its capital and will undergo schism if there is an available tribe slot (unless this
event prevents it).</p>
<h4 id="implementation-17">
  
  
    <a href="#implementation-17">&#128279</a> Implementation
  
  
</h4>
    
<p>This execution point is provided by the Test of Time Patch Project function <code class="language-plaintext highlighter-rouge">civ.scen.onSchism</code>.</p>
<h3 id="between-turns">
  
  
    <a href="#between-turns">&#128279</a> <strong>Between Turns</strong>
  
  
</h3>
    
<p>This execution point occurs at the very beginning of a game turn, before the Barbarian tribe begins its movement.</p>
<h4 id="usage-17">
  
  
    <a href="#usage-17">&#128279</a> Usage
  
  
</h4>
    
<h5 id="consolidatedeventslua-12">
  
  
    <a href="#consolidatedeventslua-12">&#128279</a> <strong>consolidatedEvents.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Between Turns</span>
<span class="k">function</span> <span class="nc">events</span><span class="p">.</span><span class="nf">onTurn</span><span class="p">(</span><span class="n">turn</span><span class="p">)</span>
    <span class="c1">--civ.ui.text("The turn is "..tostring(turn)..".")</span>

<span class="k">end</span>

</code></pre></div></div>
<h5 id="eventsfilesonturnlua">
  
  
    <a href="#eventsfilesonturnlua">&#128279</a> <strong>EventsFiles\onTurn.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nc">onTurn</span><span class="p">.</span><span class="nf">onTurn</span><span class="p">(</span><span class="n">turn</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"on turn test separate file"</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>

</code></pre></div></div>
<h5 id="discrete-events-15">
  
  
    <a href="#discrete-events-15">&#128279</a> <strong>Discrete Events</strong>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete Between Turns event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">discreteEvents</span><span class="p">.</span><span class="n">onTurn</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">turn</span><span class="p">)</span> 
    <span class="c1">--civ.ui.text("discrete on turn event 1")</span>
<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>
<h4 id="implementation-18">
  
  
    <a href="#implementation-18">&#128279</a> Implementation
  
  
</h4>
    
<p>This execution point is provided by the Test of Time Patch Project function <code class="language-plaintext highlighter-rouge">civ.scen.onTurn</code>.</p>
<h3 id="unit-killed-in-combat">
  
  
    <a href="#unit-killed-in-combat">&#128279</a> <strong>Unit Killed In Combat</strong>
  
  
</h3>
    
<p>This execution point is triggered when a unit is killed as a result of standard Civ II combat.  It is not triggered if a unit is killed by the <a href="/auto_doc/gen.html#defeatunit">gen.defeatUnit</a> function.  The <a href="#unit-defeated">Unit Defeated</a> execution point triggers for both standard combat defeat and event driven defeat.</p>
<h4 id="usage-18">
  
  
    <a href="#usage-18">&#128279</a> Usage
  
  
</h4>
    
<h5 id="consolidatedeventslua-13">
  
  
    <a href="#consolidatedeventslua-13">&#128279</a> <strong>consolidatedEvents.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- On unit killed in combat</span>
<span class="k">function</span> <span class="nc">events</span><span class="p">.</span><span class="nf">onUnitKilled</span><span class="p">(</span><span class="n">loser</span><span class="p">,</span><span class="n">winner</span><span class="p">,</span><span class="n">aggressor</span><span class="p">,</span><span class="n">victim</span><span class="p">,</span><span class="n">loserLocation</span><span class="p">,</span><span class="n">winnerVetStatus</span><span class="p">,</span><span class="n">loserVetStatus</span><span class="p">)</span>
    <span class="c1">--civ.ui.text("A "..loser.type.name.." has been defeated by a "..winner.type.name..".")</span>

<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">loser</code> is the unit which was defeated in combat.</p>

<p>The <code class="language-plaintext highlighter-rouge">winner</code> is the unit which won the combat.</p>

<p>The <code class="language-plaintext highlighter-rouge">aggressor</code> is the unit which initiated the combat.</p>

<p>The <code class="language-plaintext highlighter-rouge">victim</code> is the unit which was attacked.</p>

<p>The <code class="language-plaintext highlighter-rouge">loserLocation</code> is the tile where the <code class="language-plaintext highlighter-rouge">loser</code> was standing.  If the <code class="language-plaintext highlighter-rouge">aggressor</code> is the <code class="language-plaintext highlighter-rouge">loser</code>, the code <code class="language-plaintext highlighter-rouge">loser.location</code> will point to a “tile” off the map.</p>

<p>The <code class="language-plaintext highlighter-rouge">winnerVetStatus</code> is the veteran status of the <code class="language-plaintext highlighter-rouge">winner</code> before the battle took place (this event triggers after the game assigns veteran status for victory in combat).</p>

<p>The <code class="language-plaintext highlighter-rouge">loserVetStatus</code> is the veteran status of the <code class="language-plaintext highlighter-rouge">loser</code> before the battle
took place.</p>
<h5 id="eventsfilesonunitkilledlua">
  
  
    <a href="#eventsfilesonunitkilledlua">&#128279</a> <strong>EventsFiles\onUnitKilled.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- This will only run when a unit is killed in combat (i.e. not when an event</span>
<span class="c1">-- 'kills' a unit)</span>
<span class="c1">-- note that if the aggressor loses, aggressor.location will not work</span>
<span class="c1">-- note: use loserLocation instead of loser.location, since loser.location doesn't work if the attacker loses</span>
<span class="c1">-- (the game returns a 'tile' off the map)</span>
<span class="k">function</span> <span class="nc">onUnitKilled</span><span class="p">.</span><span class="nf">onUnitKilled</span><span class="p">(</span><span class="n">loser</span><span class="p">,</span><span class="n">winner</span><span class="p">,</span><span class="n">aggressor</span><span class="p">,</span><span class="n">victim</span><span class="p">,</span><span class="n">loserLocation</span><span class="p">,</span><span class="n">winnerVetStatus</span><span class="p">,</span><span class="n">loserVetStatus</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="n">loser</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">" killed by "</span><span class="o">..</span><span class="n">winner</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">" separate file test killed in combat."</span><span class="p">)</span>
    <span class="k">end</span>

<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">loser</code> is the unit which was defeated in combat.</p>

<p>The <code class="language-plaintext highlighter-rouge">winner</code> is the unit which won the combat.</p>

<p>The <code class="language-plaintext highlighter-rouge">aggressor</code> is the unit which initiated the combat.</p>

<p>The <code class="language-plaintext highlighter-rouge">victim</code> is the unit which was attacked.</p>

<p>The <code class="language-plaintext highlighter-rouge">loserLocation</code> is the tile where the <code class="language-plaintext highlighter-rouge">loser</code> was standing.  If the <code class="language-plaintext highlighter-rouge">aggressor</code> is the <code class="language-plaintext highlighter-rouge">loser</code>, the code <code class="language-plaintext highlighter-rouge">loser.location</code> will point to a “tile” off the map.</p>

<p>The <code class="language-plaintext highlighter-rouge">winnerVetStatus</code> is the veteran status of the <code class="language-plaintext highlighter-rouge">winner</code> before the battle took place (this event triggers after the game assigns veteran status for victory in combat).</p>

<p>The <code class="language-plaintext highlighter-rouge">loserVetStatus</code> is the veteran status of the <code class="language-plaintext highlighter-rouge">loser</code> before the battle
took place.</p>
<h5 id="discrete-events-16">
  
  
    <a href="#discrete-events-16">&#128279</a> <strong>Discrete Events</strong>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete Unit Killed In Combat event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">discreteEvents</span><span class="p">.</span><span class="n">onUnitKilled</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">loser</span><span class="p">,</span><span class="n">winner</span><span class="p">,</span><span class="n">aggressor</span><span class="p">,</span><span class="n">victim</span><span class="p">,</span><span class="n">loserLocation</span><span class="p">,</span><span class="n">winnerVetStatus</span><span class="p">,</span><span class="n">loserVetStatus</span><span class="p">)</span> 
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="n">loser</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">" was killed by "</span><span class="o">..</span><span class="n">winner</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">" discrete event 1"</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">loser</code> is the unit which was defeated in combat.</p>

<p>The <code class="language-plaintext highlighter-rouge">winner</code> is the unit which won the combat.</p>

<p>The <code class="language-plaintext highlighter-rouge">aggressor</code> is the unit which initiated the combat.</p>

<p>The <code class="language-plaintext highlighter-rouge">victim</code> is the unit which was attacked.</p>

<p>The <code class="language-plaintext highlighter-rouge">loserLocation</code> is the tile where the <code class="language-plaintext highlighter-rouge">loser</code> was standing.  If the <code class="language-plaintext highlighter-rouge">aggressor</code> is the <code class="language-plaintext highlighter-rouge">loser</code>, the code <code class="language-plaintext highlighter-rouge">loser.location</code> will point to a “tile” off the map.</p>

<p>The <code class="language-plaintext highlighter-rouge">winnerVetStatus</code> is the veteran status of the <code class="language-plaintext highlighter-rouge">winner</code> before the battle took place (this event triggers after the game assigns veteran status for victory in combat).</p>

<p>The <code class="language-plaintext highlighter-rouge">loserVetStatus</code> is the veteran status of the <code class="language-plaintext highlighter-rouge">loser</code> before the battle
took place.</p>
<h4 id="implementation-19">
  
  
    <a href="#implementation-19">&#128279</a> Implementation
  
  
</h4>
    

<p>This event is based primarily on the function <code class="language-plaintext highlighter-rouge">civ.scen.onUnitKilled</code>
function provided by the standard Test of Time Patch Project.  However,
information is also gathered by the function registered to 
<code class="language-plaintext highlighter-rouge">civ.scen.onInitiateCombat</code> in order to populate these variables 
(which are defined outside of either registered function):</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">aggressor</code></li>
  <li><code class="language-plaintext highlighter-rouge">aggressorLocation</code></li>
  <li><code class="language-plaintext highlighter-rouge">aggressorVetStatus</code></li>
  <li><code class="language-plaintext highlighter-rouge">victim</code></li>
  <li><code class="language-plaintext highlighter-rouge">victimVetStatus</code></li>
</ul>

<p>These variables are used to populate the following <code class="language-plaintext highlighter-rouge">onUnitKilled</code> function
parameters, which are not provided by the game itself:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">aggressor</code></li>
  <li><code class="language-plaintext highlighter-rouge">victim</code></li>
  <li><code class="language-plaintext highlighter-rouge">loserLocation</code></li>
  <li><code class="language-plaintext highlighter-rouge">winnerVetStatus</code></li>
  <li><code class="language-plaintext highlighter-rouge">loserVetStatus</code></li>
</ul>
<h3 id="unit-defeated">
  
  
    <a href="#unit-defeated">&#128279</a> <strong>Unit Defeated</strong>
  
  
</h3>
    

<p>This execution point is triggered when a unit is killed as a result of 
standard Civ II combat, or when it is killed by events through
the use of the <a href="/auto_doc/gen.html#defeatunit">gen.defeatUnit</a> function.</p>
<h4 id="usage-19">
  
  
    <a href="#usage-19">&#128279</a> Usage
  
  
</h4>
    
<h5 id="consolidatedeventslua-14">
  
  
    <a href="#consolidatedeventslua-14">&#128279</a> <strong>consolidatedEvents.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- On unit defeated in combat or by some other event</span>
<span class="k">function</span> <span class="nc">events</span><span class="p">.</span><span class="nf">onUnitDefeated</span><span class="p">(</span><span class="n">loser</span><span class="p">,</span><span class="n">winner</span><span class="p">,</span><span class="n">aggressor</span><span class="p">,</span><span class="n">victim</span><span class="p">,</span><span class="n">loserLocation</span><span class="p">,</span><span class="n">winnerVetStatus</span><span class="p">,</span><span class="n">loserVetStatus</span><span class="p">)</span>
    <span class="c1">--civ.ui.text("unit defeated consolidated test")</span>

<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">loser</code> is the unit which was defeated.</p>

<p>The <code class="language-plaintext highlighter-rouge">winner</code> is the unit which won the combat.</p>

<p>The <code class="language-plaintext highlighter-rouge">aggressor</code> is the unit which initiated the combat.</p>

<p>The <code class="language-plaintext highlighter-rouge">victim</code> is the unit which was attacked.</p>

<p>The <code class="language-plaintext highlighter-rouge">loserLocation</code> is the tile where the <code class="language-plaintext highlighter-rouge">loser</code> was standing.  If the <code class="language-plaintext highlighter-rouge">aggressor</code> is the <code class="language-plaintext highlighter-rouge">loser</code>, the code <code class="language-plaintext highlighter-rouge">loser.location</code> will point to a “tile” off the map.</p>

<p>The <code class="language-plaintext highlighter-rouge">winnerVetStatus</code> is the veteran status of the <code class="language-plaintext highlighter-rouge">winner</code> before the battle took place (this event triggers after the game assigns veteran status for victory in combat).</p>

<p>The <code class="language-plaintext highlighter-rouge">loserVetStatus</code> is the veteran status of the <code class="language-plaintext highlighter-rouge">loser</code> before the battle
took place.</p>
<h5 id="eventsfilesonunitdefeatedlua">
  
  
    <a href="#eventsfilesonunitdefeatedlua">&#128279</a> <strong>EventsFiles\onUnitDefeated.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- This will run any time a unit is killed, either in combat or by events</span>
<span class="k">function</span> <span class="nc">onUnitDefeated</span><span class="p">.</span><span class="nf">onUnitDefeated</span><span class="p">(</span><span class="n">loser</span><span class="p">,</span><span class="n">winner</span><span class="p">,</span><span class="n">aggressor</span><span class="p">,</span><span class="n">victim</span><span class="p">,</span><span class="n">loserLocation</span><span class="p">,</span><span class="n">winnerVetStatus</span><span class="p">,</span><span class="n">loserVetStatus</span><span class="p">)</span>
    <span class="c1">--civ.ui.text(loser.type.name.." defeated (possibly in an event rather than combat) by "..winner.type.name.." separate file test")</span>

<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">loser</code> is the unit which was defeated.</p>

<p>The <code class="language-plaintext highlighter-rouge">winner</code> is the unit which won the combat.</p>

<p>The <code class="language-plaintext highlighter-rouge">aggressor</code> is the unit which initiated the combat.</p>

<p>The <code class="language-plaintext highlighter-rouge">victim</code> is the unit which was attacked.</p>

<p>The <code class="language-plaintext highlighter-rouge">loserLocation</code> is the tile where the <code class="language-plaintext highlighter-rouge">loser</code> was standing.  If the <code class="language-plaintext highlighter-rouge">aggressor</code> is the <code class="language-plaintext highlighter-rouge">loser</code>, the code <code class="language-plaintext highlighter-rouge">loser.location</code> will point to a “tile” off the map.</p>

<p>The <code class="language-plaintext highlighter-rouge">winnerVetStatus</code> is the veteran status of the <code class="language-plaintext highlighter-rouge">winner</code> before the battle took place (this event triggers after the game assigns veteran status for victory in combat).</p>

<p>The <code class="language-plaintext highlighter-rouge">loserVetStatus</code> is the veteran status of the <code class="language-plaintext highlighter-rouge">loser</code> before the battle
took place.</p>
<h5 id="discrete-events-17">
  
  
    <a href="#discrete-events-17">&#128279</a> <strong>Discrete Events</strong>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete Unit Defeated event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">discreteEvents</span><span class="p">.</span><span class="n">onUnitDefeated</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">loser</span><span class="p">,</span><span class="n">winner</span><span class="p">,</span><span class="n">aggressor</span><span class="p">,</span><span class="n">victim</span><span class="p">,</span><span class="n">loserLocation</span><span class="p">,</span><span class="n">winnerVetStatus</span><span class="p">,</span><span class="n">loserVetStatus</span><span class="p">)</span> 
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
    <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="n">loser</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">" was defeated (possibly by event) by "</span><span class="o">..</span><span class="n">winner</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">" discrete event"</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">loser</code> is the unit which was defeated.</p>

<p>The <code class="language-plaintext highlighter-rouge">winner</code> is the unit which won the combat.</p>

<p>The <code class="language-plaintext highlighter-rouge">aggressor</code> is the unit which initiated the combat.</p>

<p>The <code class="language-plaintext highlighter-rouge">victim</code> is the unit which was attacked.</p>

<p>The <code class="language-plaintext highlighter-rouge">loserLocation</code> is the tile where the <code class="language-plaintext highlighter-rouge">loser</code> was standing.  If the <code class="language-plaintext highlighter-rouge">aggressor</code> is the <code class="language-plaintext highlighter-rouge">loser</code>, the code <code class="language-plaintext highlighter-rouge">loser.location</code> will point to a “tile” off the map.</p>

<p>The <code class="language-plaintext highlighter-rouge">winnerVetStatus</code> is the veteran status of the <code class="language-plaintext highlighter-rouge">winner</code> before the battle took place (this event triggers after the game assigns veteran status for victory in combat).</p>

<p>The <code class="language-plaintext highlighter-rouge">loserVetStatus</code> is the veteran status of the <code class="language-plaintext highlighter-rouge">loser</code> before the battle
took place.</p>
<h4 id="implementation-20">
  
  
    <a href="#implementation-20">&#128279</a> Implementation
  
  
</h4>
    

<p>The Unit Defeated execution point is implemented using the TOTPP function
<code class="language-plaintext highlighter-rouge">civ.scen.onUnitKilled</code>, as well as making the function <code class="language-plaintext highlighter-rouge">gen.defeatUnit</code>
call the registered functions for this execution point.  The function is registered for <code class="language-plaintext highlighter-rouge">gen.defeatUnit</code> by the function <a href="/auto_doc/gen.html#setdeathfunctions">gen.setDeathFunctions</a>.</p>
<h3 id="unit-death">
  
  
    <a href="#unit-death">&#128279</a> <strong>Unit Death</strong>
  
  
</h3>
    

<p>This execution point is triggered when a unit “dies.”  This includes when it is defeated in combat or by the use of <a href="/auto_doc/gen.html#defeatunit">gen.defeatUnit</a> (as long as it isn’t demoted into another unit by events), and also when the function <a href="/auto_doc/gen.html#killunit">gen.killUnit</a> is called.</p>
<h4 id="usage-20">
  
  
    <a href="#usage-20">&#128279</a> Usage
  
  
</h4>
    
<h5 id="eventsfilesonunitdeathlua">
  
  
    <a href="#eventsfilesonunitdeathlua">&#128279</a> <strong>EventsFiles\onUnitDeath.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- this happens whenever a unit 'dies', regardless of combat, as long as it is not replaced</span>
<span class="k">function</span> <span class="nc">onUnitDeath</span><span class="p">.</span><span class="nf">onUnitDeath</span><span class="p">(</span><span class="n">dyingUnit</span><span class="p">)</span>
    <span class="c1">--civ.ui.text(dyingUnit.type.name.." died separate file test")</span>

<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">dyingUnit</code> is the unit which has just been killed.</p>
<h4 id="implementation-21">
  
  
    <a href="#implementation-21">&#128279</a> Implementation
  
  
</h4>
    

<p>The Unit Death execution point is implemented using the TOTPP function
<code class="language-plaintext highlighter-rouge">civ.scen.onUnitKilled</code>, as well as making the functions <code class="language-plaintext highlighter-rouge">gen.defeatUnit</code> and <code class="language-plaintext highlighter-rouge">gen.killUnit</code>
call the registered function for this execution point.</p>
<h3 id="unit-death-outside-combat">
  
  
    <a href="#unit-death-outside-combat">&#128279</a> <strong>Unit Death Outside Combat</strong>
  
  
</h3>
    

<p>This execution point is triggered when a unit is “killed” using the function <a href="/auto_doc/gen.html#killunit">gen.killUnit</a>.  It is not triggered when a unit is defeated in combat or by the use of <a href="/auto_doc/gen.html#defeatunit">gen.defeatUnit</a>.</p>
<h4 id="usage-21">
  
  
    <a href="#usage-21">&#128279</a> Usage
  
  
</h4>
    
<h5 id="eventsfilesonunitdeathlua-1">
  
  
    <a href="#eventsfilesonunitdeathlua-1">&#128279</a> <strong>EventsFiles\onUnitDeath.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- this happens whenever a unit 'dies', but not through combat (or 'defeat')</span>
<span class="k">function</span> <span class="nc">onUnitDeath</span><span class="p">.</span><span class="nf">onUnitDeathOutsideCombat</span><span class="p">(</span><span class="n">dyingUnit</span><span class="p">)</span>
    <span class="c1">--civ.ui.text(dyingUnit.type.name.." died outside combat separate file test")</span>

<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">dyingUnit</code> is the unit which has just been killed.</p>
<h4 id="implementation-22">
  
  
    <a href="#implementation-22">&#128279</a> Implementation
  
  
</h4>
    

<p>The Unit Death Outside Combat execution point is implemented by making the function <code class="language-plaintext highlighter-rouge">gen.killUnit</code> call the registered function for this execution point.  That function is registered using <a href="/auto_doc/gen.html#setdeathfunctions">gen.setDeathFunctions</a>.</p>
<h3 id="unit-deleted">
  
  
    <a href="#unit-deleted">&#128279</a> <strong>Unit Deleted</strong>
  
  
</h3>
    

<p>This execution point is triggered when a unit is deleted from the game.  This includes when it is defeated in combat or by the use of <a href="/auto_doc/gen.html#defeatunit">gen.defeatUnit</a> (even if the unit is “demoted” into another unit), when the function <a href="/auto_doc/gen.html#killunit">gen.killUnit</a> is called, and when the function <a href="/auto_doc/gen.html#deleteunit">gen.deleteUnit</a> is called.  It is not triggered when a unit is disbanded by the player (as of TOTPPv0.18.4), and is not triggered by the use of <a href="/auto_doc/civ.html#deleteunit">civ.deleteUnit</a>.</p>
<h4 id="usage-22">
  
  
    <a href="#usage-22">&#128279</a> Usage
  
  
</h4>
    
<h5 id="eventsfilesonunitdeathlua-2">
  
  
    <a href="#eventsfilesonunitdeathlua-2">&#128279</a> <strong>EventsFiles\onUnitDeath.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- this happens if a unit is deleted (either through combat death, or by some other event,</span>
<span class="c1">-- but not if the unit is disbanded)</span>
<span class="c1">-- If the unit isn't being replaced, replacingUnit is nil</span>
<span class="k">function</span> <span class="nc">onUnitDeath</span><span class="p">.</span><span class="nf">onUnitDeleted</span><span class="p">(</span><span class="n">deletedUnit</span><span class="p">,</span><span class="n">replacingUnit</span><span class="p">)</span>
    <span class="c1">--civ.ui.text(deletedUnit.type.name.." deleted and replaced by "..tostring(replacingUnit).." separate file")</span>

<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">deletedUnit</code> is the unit which has just been deleted.</p>

<p>The <code class="language-plaintext highlighter-rouge">replacementUnit</code> is the unit which has replaced the <code class="language-plaintext highlighter-rouge">deletedUnit</code> (if any).  If the <code class="language-plaintext highlighter-rouge">deletedUnit</code> was not replaced, this parameter is <code class="language-plaintext highlighter-rouge">nil</code>.</p>
<h4 id="implementation-23">
  
  
    <a href="#implementation-23">&#128279</a> Implementation
  
  
</h4>
    

<p>The Unit Deleted execution point is implemented using the TOTPP function
<code class="language-plaintext highlighter-rouge">civ.scen.onUnitKilled</code>, as well as making the functions <code class="language-plaintext highlighter-rouge">gen.defeatUnit</code>, <code class="language-plaintext highlighter-rouge">gen.killUnit</code>, and <code class="language-plaintext highlighter-rouge">gen.deleteUnit</code> call the registered function for this execution point.  The function is registered for <code class="language-plaintext highlighter-rouge">gen.defeatUnit</code> by the function <a href="/auto_doc/gen.html#setdeathfunctions">gen.setDeathFunctions</a>.</p>
<h3 id="city-processing-complete">
  
  
    <a href="#city-processing-complete">&#128279</a> <strong>City Processing Complete</strong>
  
  
</h3>
    

<p>This execution point is triggered when the game has finished processing city production for a tribe, and before it has a chance to move units.</p>
<h4 id="usage-23">
  
  
    <a href="#usage-23">&#128279</a> Usage
  
  
</h4>
    
<h5 id="consolidatedeventslua-15">
  
  
    <a href="#consolidatedeventslua-15">&#128279</a> <strong>consolidatedEvents.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- After Production</span>
<span class="k">function</span> <span class="nc">events</span><span class="p">.</span><span class="nf">onCityProcessingComplete</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span><span class="n">tribe</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"consolidated.onCityProcessingComplete for turn "</span><span class="o">..</span><span class="nb">tostring</span><span class="p">(</span><span class="n">turn</span><span class="p">)</span><span class="o">..</span><span class="s2">" and tribe "</span><span class="o">..</span><span class="n">tribe</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">end</span>

<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">turn</code> is the turn number (an integer).</p>

<p>The <code class="language-plaintext highlighter-rouge">tribe</code> is the tribe which has just finished processing cities.</p>
<h5 id="eventsfilesoncityprocessingcompletelua">
  
  
    <a href="#eventsfilesoncityprocessingcompletelua">&#128279</a> <strong>EventsFiles\onCityProcessingComplete.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onCityProcessingComplete</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span><span class="n">tribe</span><span class="p">)</span>
    <span class="c1">--civ.ui.text('after production separate file')</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"onCityProcessingComplete for turn "</span><span class="o">..</span><span class="n">turn</span><span class="o">..</span><span class="s2">" and tribe "</span><span class="o">..</span><span class="n">tribe</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">" separate file"</span><span class="p">)</span>
    <span class="k">end</span>

<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">turn</code> is the turn number (an integer).</p>

<p>The <code class="language-plaintext highlighter-rouge">tribe</code> is the tribe which has just finished processing cities.</p>
<h5 id="discrete-events-18">
  
  
    <a href="#discrete-events-18">&#128279</a> <strong>Discrete Events</strong>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete City Processing Complete event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">discreteEvents</span><span class="p">.</span><span class="n">onCityProcessingComplete</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span><span class="n">tribe</span><span class="p">)</span> 
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"discreteEvents.onCityProcessingComplete for "</span><span class="o">..</span><span class="n">tribe</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">" on turn "</span><span class="o">..</span><span class="nb">tostring</span><span class="p">(</span><span class="n">turn</span><span class="p">))</span>
    <span class="k">end</span>
<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">turn</code> is the turn number (an integer).</p>

<p>The <code class="language-plaintext highlighter-rouge">tribe</code> is the tribe which has just finished processing cities.</p>
<h4 id="implementation-24">
  
  
    <a href="#implementation-24">&#128279</a> Implementation
  
  
</h4>
    
<p>This execution point is provided by the Test of Time Patch Project function <code class="language-plaintext highlighter-rouge">civ.scen.onCityProcessingComplete</code>.</p>
<h3 id="before-city-processing">
  
  
    <a href="#before-city-processing">&#128279</a> <strong>Before City Processing</strong>
  
  
</h3>
    

<p>This execution point is triggered at the start of a tribe’s turn, before the game processes its cities.</p>
<h4 id="usage-24">
  
  
    <a href="#usage-24">&#128279</a> Usage
  
  
</h4>
    
<h5 id="consolidatedeventslua-16">
  
  
    <a href="#consolidatedeventslua-16">&#128279</a> <strong>consolidatedEvents.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Before Production</span>
<span class="k">function</span> <span class="nc">events</span><span class="p">.</span><span class="nf">onTribeTurnBegin</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span><span class="n">tribe</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"consolidated.onTribeTurnBegin for turn "</span><span class="o">..</span><span class="nb">tostring</span><span class="p">(</span><span class="n">turn</span><span class="p">)</span><span class="o">..</span><span class="s2">" and tribe "</span><span class="o">..</span><span class="n">tribe</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">end</span>

<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">turn</code> is the turn number (an integer).</p>

<p>The <code class="language-plaintext highlighter-rouge">tribe</code> is the tribe which is about to process cities.</p>
<h5 id="eventsfilesontribeturnbeginlua">
  
  
    <a href="#eventsfilesontribeturnbeginlua">&#128279</a> <strong>EventsFiles\onTribeTurnBegin.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onTribeTurnBegin</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span><span class="n">tribe</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"onTribeTurnBegin for turn "</span><span class="o">..</span><span class="n">turn</span><span class="o">..</span><span class="s2">" and tribe "</span><span class="o">..</span><span class="n">tribe</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">" separate file"</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">turn</code> is the turn number (an integer).</p>

<p>The <code class="language-plaintext highlighter-rouge">tribe</code> is the tribe which is about to process cities.</p>
<h5 id="discrete-events-19">
  
  
    <a href="#discrete-events-19">&#128279</a> <strong>Discrete Events</strong>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete Before City Processing event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">discreteEvents</span><span class="p">.</span><span class="n">onTribeTurnBegin</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span><span class="n">tribe</span><span class="p">)</span> 
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"discreteEvents.onTribeTurnBegin for "</span><span class="o">..</span><span class="n">tribe</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">" on turn "</span><span class="o">..</span><span class="nb">tostring</span><span class="p">(</span><span class="n">turn</span><span class="p">))</span>
    <span class="k">end</span>
<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">turn</code> is the turn number (an integer).</p>

<p>The <code class="language-plaintext highlighter-rouge">tribe</code> is the tribe which is about to process cities.</p>
<h4 id="implementation-25">
  
  
    <a href="#implementation-25">&#128279</a> Implementation
  
  
</h4>
    
<p>This execution point is provided by the Test of Time Patch Project function <code class="language-plaintext highlighter-rouge">civ.scen.onTribeTurnBegin</code>.</p>
<h3 id="tribe-turn-finished">
  
  
    <a href="#tribe-turn-finished">&#128279</a> <strong>Tribe Turn Finished</strong>
  
  
</h3>
    

<p>This execution point is triggered at the end of a tribe’s turn.</p>
<h4 id="usage-25">
  
  
    <a href="#usage-25">&#128279</a> Usage
  
  
</h4>
    
<h5 id="consolidatedeventslua-17">
  
  
    <a href="#consolidatedeventslua-17">&#128279</a> <strong>consolidatedEvents.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nc">events</span><span class="p">.</span><span class="nf">onTribeTurnEnd</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span><span class="n">tribe</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"consolidated.onTribeTurnEnd for turn "</span><span class="o">..</span><span class="nb">tostring</span><span class="p">(</span><span class="n">turn</span><span class="p">)</span><span class="o">..</span><span class="s2">" and tribe "</span><span class="o">..</span><span class="n">tribe</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">end</span>

<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">turn</code> is the turn number (an integer).</p>

<p>The <code class="language-plaintext highlighter-rouge">tribe</code> is the tribe which has just finished its turn.</p>
<h5 id="eventsfilesontribeturnendlua">
  
  
    <a href="#eventsfilesontribeturnendlua">&#128279</a> <strong>EventsFiles\onTribeTurnEnd.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onTribeTurnEnd</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span><span class="n">tribe</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"onTribeTurnEnd for turn "</span><span class="o">..</span><span class="n">turn</span><span class="o">..</span><span class="s2">" and tribe "</span><span class="o">..</span><span class="n">tribe</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">" separate file"</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">turn</code> is the turn number (an integer).</p>

<p>The <code class="language-plaintext highlighter-rouge">tribe</code> is the tribe which has just finished its turn.</p>
<h5 id="discrete-events-20">
  
  
    <a href="#discrete-events-20">&#128279</a> <strong>Discrete Events</strong>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete Tribe Turn Finished event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">discreteEvents</span><span class="p">.</span><span class="n">onTribeTurnEnd</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span><span class="n">tribe</span><span class="p">)</span> 
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"discreteEvents.onTribeTurnEnd for "</span><span class="o">..</span><span class="n">tribe</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">" on turn "</span><span class="o">..</span><span class="nb">tostring</span><span class="p">(</span><span class="n">turn</span><span class="p">))</span>
    <span class="k">end</span>
<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">turn</code> is the turn number (an integer).</p>

<p>The <code class="language-plaintext highlighter-rouge">tribe</code> is the tribe which has just finished its turn.</p>
<h4 id="implementation-26">
  
  
    <a href="#implementation-26">&#128279</a> Implementation
  
  
</h4>
    
<p>This execution point is provided by the Test of Time Patch Project function <code class="language-plaintext highlighter-rouge">civ.scen.onTribeTurnEnd</code>.</p>
<h3 id="just-before-city-processed">
  
  
    <a href="#just-before-city-processed">&#128279</a> <strong>Just Before City Processed</strong>
  
  
</h3>
    

<p>This execution point is triggered just before the game processes a city’s production, at the start of its owner’s turn.  This execution point is implemented during the City Yield Calculation execution point, so anything that can’t be effectively changed during that execution point can’t be changed here either.  For example, changing the cosmic parameter <code class="language-plaintext highlighter-rouge">sizeAquaduct</code> will not change the size a city can grow without an aquaduct, because the size is in place before this execution point is triggered.</p>
<h4 id="usage-26">
  
  
    <a href="#usage-26">&#128279</a> Usage
  
  
</h4>
    
<h5 id="consolidatedeventslua-18">
  
  
    <a href="#consolidatedeventslua-18">&#128279</a> <strong>consolidatedEvents.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- On City Processed</span>
<span class="k">function</span> <span class="nc">events</span><span class="p">.</span><span class="nf">onJustBeforeCityProcessed</span><span class="p">(</span><span class="n">city</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"consolidated.onJustBeforeCityProcessed for "</span><span class="o">..</span><span class="n">city</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">end</span>

<span class="k">end</span>

</code></pre></div></div>
<h5 id="eventsfilesonjustbeforecityprocessedlua">
  
  
    <a href="#eventsfilesonjustbeforecityprocessedlua">&#128279</a> <strong>EventsFiles\onJustBeforeCityProcessed.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onJustBeforeCityProcessed</span><span class="p">(</span><span class="n">city</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"just before city processed separate file"</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>

</code></pre></div></div>
<h5 id="discrete-events-21">
  
  
    <a href="#discrete-events-21">&#128279</a> <strong>Discrete Events</strong>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete Just Before City Processed event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">discreteEvents</span><span class="p">.</span><span class="n">onJustBeforeCityProcessed</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">city</span><span class="p">)</span> 
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"Just before city processed discrete event test for city "</span><span class="o">..</span><span class="n">city</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>
<h4 id="implementation-27">
  
  
    <a href="#implementation-27">&#128279</a> Implementation
  
  
</h4>
    

<p>The Just Before City Processed execution point is implemented using the TOTPP function <code class="language-plaintext highlighter-rouge">civ.scen.onCalculateCityYield</code>.   During the Before City Processing execution point, a list of the cities that will be processed is created.  (Cities are processed with highest ID number starting first, then working backwards.)  If the previous city processed is just before the current city, then the Just Before City Processed execution point is triggered on the next call to <code class="language-plaintext highlighter-rouge">civ.scen.onCalculateCityYield</code>.  Checks are made to prevent the “Zoom to Home City Trick” from triggering this execution point prematurely.  These checks can fail if a city screen was left open at the end of the player’s last turn, and the player uses the “Zoom to Home City Trick” to open the city screen of the city to be processed next.</p>
<h3 id="just-after-city-processed">
  
  
    <a href="#just-after-city-processed">&#128279</a> <strong>Just After City Processed</strong>
  
  
</h3>
    

<p>This execution point is triggered just after the game processes a city’s production, at the start of its owner’s turn.</p>
<h4 id="usage-27">
  
  
    <a href="#usage-27">&#128279</a> Usage
  
  
</h4>
    
<h5 id="consolidatedeventslua-19">
  
  
    <a href="#consolidatedeventslua-19">&#128279</a> <strong>consolidatedEvents.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- On City Processed</span>
<span class="k">function</span> <span class="nc">events</span><span class="p">.</span><span class="nf">onJustAfterCityProcessed</span><span class="p">(</span><span class="n">city</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"consolidated.onJustAfterCityProcessed for "</span><span class="o">..</span><span class="n">city</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">end</span>

<span class="k">end</span>

</code></pre></div></div>
<h5 id="eventsfilesonjustaftercityprocessedlua">
  
  
    <a href="#eventsfilesonjustaftercityprocessedlua">&#128279</a> <strong>EventsFiles\onJustAfterCityProcessed.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onJustAfterCityProcessed</span><span class="p">(</span><span class="n">city</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"just after city processed separate file"</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>

</code></pre></div></div>
<h5 id="discrete-events-22">
  
  
    <a href="#discrete-events-22">&#128279</a> <strong>Discrete Events</strong>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete Just After City Processed event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">discreteEvents</span><span class="p">.</span><span class="n">onJustAfterCityProcessed</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">city</span><span class="p">)</span> 
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"Just after city processed discrete event test for city "</span><span class="o">..</span><span class="n">city</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>
<h4 id="implementation-28">
  
  
    <a href="#implementation-28">&#128279</a> Implementation
  
  
</h4>
    

<p>The Just After City Processed execution point is implemented using the TOTPP function <code class="language-plaintext highlighter-rouge">civ.scen.onCalculateCityYield</code>, checking that the last time <code class="language-plaintext highlighter-rouge">civ.scen.onCalculateCityYield</code> was called, the Just Before City Processed execution point was triggered.  As part of the city processing, each city has its yield calculated at least twice, once before production is applied, and once after.</p>
<h3 id="unit-enters-tile">
  
  
    <a href="#unit-enters-tile">&#128279</a> <strong>Unit Enters Tile</strong>
  
  
</h3>
    

<p>This execution point is triggered when a unit enters a tile from another tile.</p>

<p>Optionally, the function can return true, in which case no more code will be executed for this event.  This is useful if your event kills the unit, so other events expecting a non-nil unit will not cause errors.</p>

<p>This execution point will not work properly if <code class="language-plaintext highlighter-rouge">civ.scen.compatibility.activeUnitEveryMove</code> is set to <code class="language-plaintext highlighter-rouge">false</code>.  (In the Lua Scenario Template, it is set to <code class="language-plaintext highlighter-rouge">true</code> in the file <code class="language-plaintext highlighter-rouge">LuaParameterFiles\parameters.lua</code>.)</p>
<h4 id="usage-28">
  
  
    <a href="#usage-28">&#128279</a> Usage
  
  
</h4>
    
<h5 id="consolidatedeventslua-20">
  
  
    <a href="#consolidatedeventslua-20">&#128279</a> <strong>consolidatedEvents.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- onEnterTile(unit,previousTile,previousDomainSpec)</span>
<span class="c1">-- executes when a unit successfully enters a tile (so not when it attacks</span>
<span class="c1">-- a unit or fails to enter a tile because it lacks movement points)</span>
<span class="k">function</span> <span class="nc">events</span><span class="p">.</span><span class="nf">onEnterTile</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span><span class="n">previousTile</span><span class="p">,</span><span class="n">previousDomainSpec</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"consolidated.onEnterTile: "</span><span class="o">..</span><span class="n">unit</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">" has entered tile ("</span><span class="o">..</span><span class="n">text</span><span class="p">.</span><span class="n">coordinates</span><span class="p">(</span><span class="n">unit</span><span class="p">.</span><span class="n">location</span><span class="p">)</span><span class="o">..</span><span class="s2">") from tile ("</span><span class="o">..</span><span class="n">text</span><span class="p">.</span><span class="n">coordinates</span><span class="p">(</span><span class="n">previousTile</span><span class="p">)</span><span class="o">..</span><span class="s2">")."</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>

</code></pre></div></div>
<h5 id="eventsfilesonentertilelua">
  
  
    <a href="#eventsfilesonentertilelua">&#128279</a> <strong>EventsFiles\onEnterTile.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- onEnterTile(unit,previousTile,previousDomainSpec)</span>
<span class="c1">-- executes when a unit successfully enters a tile (so not when it attacks</span>
<span class="c1">-- a unit or fails to enter a tile because it lacks movement points)</span>
<span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onEnterTile</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span><span class="n">previousTile</span><span class="p">,</span><span class="n">previousDomainSpec</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"onEnterTile.onEnterTile: "</span><span class="o">..</span><span class="n">unit</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">" has entered tile ("</span><span class="o">..</span><span class="n">text</span><span class="p">.</span><span class="n">coordinates</span><span class="p">(</span><span class="n">unit</span><span class="p">.</span><span class="n">location</span><span class="p">)</span><span class="o">..</span><span class="s2">") from tile ("</span><span class="o">..</span><span class="n">text</span><span class="p">.</span><span class="n">coordinates</span><span class="p">(</span><span class="n">previousTile</span><span class="p">)</span><span class="o">..</span><span class="s2">")."</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="c1">--if gen.isParadrop(unit.type) and not unit.location.city then</span>
    <span class="c1">--    unit:teleport(previousTile)</span>
    <span class="c1">--    gen.clearParadropped(unit)</span>
    <span class="c1">--end</span>
    <span class="c1">--gen.original.uParatroopers.hold = 1</span>
    <span class="c1">--gen.original.uParatroopers.domain = 2</span>

<span class="k">end</span>

</code></pre></div></div>
<h5 id="discrete-events-23">
  
  
    <a href="#discrete-events-23">&#128279</a> <strong>Discrete Events</strong>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete Unit Enters Tile event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- onEnterTile(unit,previousTile)</span>
<span class="c1">-- executes when a unit successfully enters a tile (so not when it attacks</span>
<span class="c1">-- a unit or fails to enter a tile because it lacks movement points)</span>
<span class="n">discreteEvents</span><span class="p">.</span><span class="n">onEnterTile</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span><span class="n">previousTile</span><span class="p">,</span><span class="n">previousDomainSpec</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"discreteEvents.onEnterTile: "</span><span class="o">..</span><span class="n">unit</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">" has entered tile ("</span><span class="o">..</span><span class="n">text</span><span class="p">.</span><span class="n">coordinates</span><span class="p">(</span><span class="n">unit</span><span class="p">.</span><span class="n">location</span><span class="p">)</span><span class="o">..</span><span class="s2">") from tile ("</span><span class="o">..</span><span class="n">text</span><span class="p">.</span><span class="n">coordinates</span><span class="p">(</span><span class="n">previousTile</span><span class="p">)</span><span class="o">..</span><span class="s2">")."</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>
<h4 id="implementation-29">
  
  
    <a href="#implementation-29">&#128279</a> Implementation
  
  
</h4>
    

<p>This execution point is mostly implemented using the Unit Activation execution point.  Since the execution point is executed when the unit is ready to move again, code can check whether a unit has moved.</p>

<p>When a unit is activated, some information about it is recorded by Lua, including its location.  The next time the a Unit Activation execution point is triggered, the location is compared to the recorded location.  If the unit is now in a different location, the Unit Enters Tile execution point is triggered.</p>

<p>The Get Formatted Date execution point will also check to see if a unit has been moved, in case there is no new active unit to trigger the Unit Activation execution point.  Since the status window is recalculated almost every time a click is made, a human player shouldn’t be able to do much without having this execution point trigger if it is appropriate.  The Tribe Turn Finished execution point also checks to see if a unit has been moved without having this execution point trigger, and if so, triggers this execution point.</p>
<h3 id="unit-given-final-order">
  
  
    <a href="#unit-given-final-order">&#128279</a> <strong>Unit Given Final Order</strong>
  
  
</h3>
    

<p>This execution point is triggered when a unit is given its final order for the turn.  This can happen because the unit has been detected to have spent all its movement points, or because the tribe’s turn has ended.</p>
<h4 id="usage-29">
  
  
    <a href="#usage-29">&#128279</a> Usage
  
  
</h4>
    
<h5 id="consolidatedeventslua-21">
  
  
    <a href="#consolidatedeventslua-21">&#128279</a> <strong>consolidatedEvents.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- onFinalOrderGiven(unit)</span>
<span class="c1">-- executes when a unit has been given its final order for the turn.</span>
<span class="c1">-- that is, when a new unit is active and the previous unit has spent</span>
<span class="c1">-- all its movement points</span>
<span class="k">function</span> <span class="nc">events</span><span class="p">.</span><span class="nf">onFinalOrderGiven</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"consolidated.onFinalOrderGiven: "</span><span class="o">..</span><span class="n">unit</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">" has been given its order."</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>

</code></pre></div></div>
<h5 id="eventsfilesonfinalordergivenlua">
  
  
    <a href="#eventsfilesonfinalordergivenlua">&#128279</a> <strong>EventsFiles\onFinalOrderGiven.lua</strong>
  
  
</h5>
    
<p>Change this function:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onFinalOrderGiven</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"onFinalOrderGiven.onFinalOrderGiven: "</span><span class="o">..</span><span class="n">unit</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">" has been given its order."</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>

</code></pre></div></div>
<h5 id="discrete-events-24">
  
  
    <a href="#discrete-events-24">&#128279</a> <strong>Discrete Events</strong>
  
  
</h5>
    
<p>In any file in which you wish to register discrete events, you must require the Discrete Events Module:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">discreteEvents</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"discreteEventsRegistrar"</span><span class="p">)</span>
</code></pre></div></div>
<p>This is the example of a discrete Unit Given Final Order event within <code class="language-plaintext highlighter-rouge">discreteEvents.lua</code>:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- onFinalOrderGiven(unit)</span>
<span class="c1">-- executes when a unit has been given its final order for the turn.</span>
<span class="c1">-- that is, when a new unit is active and the previous unit has spent</span>
<span class="c1">-- all its movement points</span>
<span class="n">discreteEvents</span><span class="p">.</span><span class="n">onFinalOrderGiven</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="n">civ</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="s2">"discreteEvents.onFinalOrderGiven: "</span><span class="o">..</span><span class="n">unit</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">" has been given its order."</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span><span class="p">)</span>

</code></pre></div></div>
<h4 id="implementation-30">
  
  
    <a href="#implementation-30">&#128279</a> Implementation
  
  
</h4>
    

<p>This execution point is implemented using the Unit Activation execution point and the Tribe Turn Finished execution point.  When a unit is activated, some information about it is recorded by Lua.  The code checks the previously activated unit, and, if it no longer has any movement points remaining, triggers this execution point.  At the end of the tribe’s turn, the Tribe Turn Finished execution point checks to see if the unit has any movement points left.  If it does, the Unit Given Final Order execution point is triggered for that unit.</p>
<h3 id="nuclear-attack">
  
  
    <a href="#nuclear-attack">&#128279</a> <strong>Nuclear Attack</strong>
  
  
</h3>
    
<p>This execution point is triggered when an attack is made by a nuclear 
weapon (either a unit with 99 attack, or a spy).  A nuclear attack does not trigger <code class="language-plaintext highlighter-rouge">civ.scen.onUnitKilled</code>, so
events.lua makes sure to execute the related events.
If the registered function returns <code class="language-plaintext highlighter-rouge">false</code>, the attack is aborted.</p>
<h4 id="usage-30">
  
  
    <a href="#usage-30">&#128279</a> Usage
  
  
</h4>
    
<h4 id="implementation-31">
  
  
    <a href="#implementation-31">&#128279</a> Implementation
  
  
</h4>
    
<p>This execution point is provided by the Test of Time Patch Project function <code class="language-plaintext highlighter-rouge">civ.scen.onUseNuclearWeapon</code>.</p>
<h3 id="get-rush-buy-cost">
  
  
    <a href="#get-rush-buy-cost">&#128279</a> <strong>Get Rush Buy Cost</strong>
  
  
</h3>
    

<p>This execution point is called when a player checks what the cost is to rush 
buy the city’s current production item.  The registered function must return
an integer with the cost.</p>
<h4 id="usage-31">
  
  
    <a href="#usage-31">&#128279</a> Usage
  
  
</h4>
    
<h5 id="mechanicsfilesrushbuysettingslua">
  
  
    <a href="#mechanicsfilesrushbuysettingslua">&#128279</a> <strong>MechanicsFiles\rushBuySettings.lua</strong>
  
  
</h5>
    

<p>In the file MechanicsFiles
ushBuySettings.lua, change the following code:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onGetRushBuyCost</span><span class="p">(</span><span class="n">city</span><span class="p">,</span><span class="n">cost</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cost</span>
<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">city</code> parameter is the city where rush-buying is being considered.</p>

<p>The <code class="language-plaintext highlighter-rouge">cost</code> parameter is the game’s default cost to rush buy the current production item.</p>
<h4 id="implementation-32">
  
  
    <a href="#implementation-32">&#128279</a> Implementation
  
  
</h4>
    

<p>This execution point is implemented using the TOTPP function <code class="language-plaintext highlighter-rouge">civ.scen.onGetRushBuyCost</code>.</p>
<h3 id="get-formatted-date">
  
  
    <a href="#get-formatted-date">&#128279</a> <strong>Get Formatted Date</strong>
  
  
</h3>
    

<p>This execution point is triggered whenever the game needs to display a date.
Usually, this is because the game is updating the status window for the game,
but the date is also displayed when a city window is open, and also when
the spaceship window is open.  There may be other situations also.</p>

<p>The registered function must return a string to display where the date should
be.  This doesn’t actually have to be a date.  For example, If you have an 
active unit, you might want to display information about the unit in the
status window instead of the date.</p>

<p>Since the status window is recalculated so frequently, the Get Formatted Date
execution point can work almost like an ‘on click’ execution point.  The
Final Order Given and Unit Enters Tile execution points leverage this
ability so that they function properly even when another unit isn’t activated
immediately.  (This is handled in events.lua, so you don’t have to worry about
it when changing the code in onGetFormattedDate.lua.)</p>
<h4 id="usage-32">
  
  
    <a href="#usage-32">&#128279</a> Usage
  
  
</h4>
    
<h5 id="mechanicsfilesongetformatteddate">
  
  
    <a href="#mechanicsfilesongetformatteddate">&#128279</a> <strong>MechanicsFiles\onGetFormattedDate</strong>
  
  
</h5>
    

<p>You can modify the effects of this execution point by changing the following code
in <code class="language-plaintext highlighter-rouge">MechanicsFiles\onGetFormattedDate</code>:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onGetFormattedDate</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span><span class="n">defaultDateString</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_global</span><span class="p">.</span><span class="n">eventTesting</span> <span class="k">then</span>
        <span class="c1">--print(turn,civ.getTurn())</span>
        <span class="k">return</span> <span class="s2">"Testing Turn "</span><span class="o">..</span><span class="n">turn</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="n">defaultDateString</span>
<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">turn</code> parameter is the turn for the date which is to be displayed.  This is usually the current turn, but not always.  For example, the game
displays the date for a future turn when you are looking at the spaceship
window for a spaceship which has already departed.</p>

<p>The <code class="language-plaintext highlighter-rouge">defaultDateString</code> is the date string which the game would normally
display.  Return this if you do not want to make any changes to the date.</p>

<p>Here is some example code for showing information from the leaderBonus module for the active unit in the status window, instead of the date.  If the unit
is a leader, its rank is displayed.  Otherwise, if the unit has a commander,
the commander’s rank is displayed.  If the unit is neither a leader, nor under
the command of a leader, “No Leader” is displayed.</p>

<p>Note that if there is no active unit, or a city window is opened, the default
date is displayed.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">leaderBonus</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"leaderBonus"</span><span class="p">)</span>
<span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onGetFormattedDate</span><span class="p">(</span><span class="n">turn</span><span class="p">,</span><span class="n">defaultDateString</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">civ</span><span class="p">.</span><span class="n">getCurrentTribe</span><span class="p">().</span><span class="n">isHuman</span> <span class="ow">and</span> <span class="n">civ</span><span class="p">.</span><span class="n">getActiveUnit</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">civ</span><span class="p">.</span><span class="n">getOpenCity</span><span class="p">()</span> <span class="k">then</span>
        <span class="kd">local</span> <span class="n">activeUnit</span> <span class="o">=</span> <span class="n">civ</span><span class="p">.</span><span class="n">getActiveUnit</span><span class="p">()</span>
        <span class="kd">local</span> <span class="n">rank</span> <span class="o">=</span> <span class="n">leaderBonus</span><span class="p">.</span><span class="n">getRank</span><span class="p">(</span><span class="n">activeUnit</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rank</span> <span class="k">then</span>
            <span class="k">return</span> <span class="s2">"Rank: "</span><span class="o">..</span><span class="n">rank</span>
        <span class="k">elseif</span> <span class="n">leaderBonus</span><span class="p">.</span><span class="n">getCommanderRank</span><span class="p">(</span><span class="n">activeUnit</span><span class="p">)</span> <span class="k">then</span>
            <span class="k">return</span> <span class="s2">"Ldr: "</span><span class="o">..</span><span class="n">leaderBonus</span><span class="p">.</span><span class="n">getCommanderRank</span><span class="p">(</span><span class="n">activeUnit</span><span class="p">)</span>
        <span class="k">else</span>
            <span class="k">return</span> <span class="s2">"No Leader"</span>
        <span class="k">end</span>
    <span class="k">else</span>
        <span class="k">return</span> <span class="n">defaultDateString</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="n">defaultDateString</span>
<span class="k">end</span>
</code></pre></div></div>
<h4 id="implementation-33">
  
  
    <a href="#implementation-33">&#128279</a> Implementation
  
  
</h4>
    

<p>This execution point is implemented using the TOTPP function <code class="language-plaintext highlighter-rouge">civ.scen.onGetFormattedDate</code>.</p>
<h3 id="select-music">
  
  
    <a href="#select-music">&#128279</a> <strong>Select Music</strong>
  
  
</h3>
    

<p>The Select Music execution point is called whenever the game selects a new
music track to play.  This allows for the scenario designer to ship
customised music with his or her scenario.</p>

<p>This execution point is also used by my <a href="https://github.com/ProfGarfield/ExtendedMusicForTOTPP">Extended Music For TOTPP</a> program.  If your scenario ships customised
music, that overrides the Extended Music Patch.</p>
<h4 id="usage-33">
  
  
    <a href="#usage-33">&#128279</a> Usage
  
  
</h4>
    
<h5 id="luaparameterfilescustommusicintegrationlua">
  
  
    <a href="#luaparameterfilescustommusicintegrationlua">&#128279</a> <strong>LuaParameterFiles\customMusicIntegration.lua</strong>
  
  
</h5>
    

<p>Adding custom music to your scenario is done by modifying the file <code class="language-plaintext highlighter-rouge">LuaParameterFiles\customMusicIntegration.lua</code>.  Begin by adding a 
directory called <code class="language-plaintext highlighter-rouge">Music</code> to the scenario’s folder, and put your music files
in that directory.  Then, rename the <code class="language-plaintext highlighter-rouge">@PICMUSICTOT</code> section of <code class="language-plaintext highlighter-rouge">Game.txt</code>
to give appropriate names to the tracks.</p>

<p>Next, change the <code class="language-plaintext highlighter-rouge">useCustomMusic</code> variable to <code class="language-plaintext highlighter-rouge">true</code>.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- By default, custom music is disabled</span>
<span class="c1">-- If you don't plan to use custom music, you</span>
<span class="c1">-- may wish to delete @PICKMUSICTOT from Game.txt,</span>
<span class="c1">-- so that the list from the Original folder is used instead.</span>
<span class="c1">-- (There is an "Extended Music For TOTPP" addition that I wrote</span>
<span class="c1">-- which benefits from modifying @PICKMUSICTOT, and which this</span>
<span class="c1">-- module will supersede if active</span>
<span class="kd">local</span> <span class="n">useCustomMusic</span> <span class="o">=</span> <span class="kc">false</span>

</code></pre></div></div>
<p>If this is not done, the scenario won’t have custom music.  (It also won’t have
custom music if the Direct Show Music Patch is not enabled.)</p>

<p>Then, go to this section of code, and change the values in the <code class="language-plaintext highlighter-rouge">trackList</code>
table to reflect the names of the tracks in your <code class="language-plaintext highlighter-rouge">Music</code> directory.  If some
of the tracks are neither in your scenario’s music directory, the game will
search for them in the main <code class="language-plaintext highlighter-rouge">Test of Time\Music</code> directory.  If the track
is not found in either place, a message will be displayed to the player, unless
the scenario’s music directory has a file <code class="language-plaintext highlighter-rouge">missingmusic.txt</code>.  (This file can be empty.)</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">trackList</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1">-- These are the files played for each of the options in</span>
<span class="c1">-- @PICKMUSICTOT</span>
<span class="c1">-- You can add extra entries to trackList, but you should</span>
<span class="c1">-- probably also add entries to @PICKMUSICTOT if you do</span>
<span class="c1">-- (stuff won't break if you don't, just some tracks won't</span>
<span class="c1">-- be selectable, or selected when being played)</span>

<span class="n">trackList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="s2">"Funeral March.mp3"</span>
<span class="n">trackList</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="s2">"Ode to Joy.mp3"</span>
<span class="n">trackList</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="s2">"Crusade.mp3"</span>
<span class="n">trackList</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>  <span class="s2">"Alien.mp3"</span>
<span class="n">trackList</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span>  <span class="s2">"Mongol Horde.mp3"</span>
<span class="n">trackList</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span>  <span class="s2">"The Apocalypse.mp3"</span> <span class="c1">-- note that in @PICKMUSICTOT, this is misspelled</span>
<span class="n">trackList</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span>  <span class="s2">"Jurassic Jungle.mp3"</span>
<span class="n">trackList</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span>  <span class="s2">"New World.mp3"</span>
<span class="n">trackList</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span>  <span class="s2">"Tolkien.mp3"</span>
<span class="n">trackList</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span>  <span class="s2">"Mars Expedition.mp3"</span>
<span class="n">trackList</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Jules Verne.mp3"</span>
<span class="n">trackList</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"They're Here.mp3"</span>
<span class="n">trackList</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"The Dome.mp3"</span>


<span class="c1">-- A check will be made to make sure all the files are available</span>
<span class="c1">-- If the scenario directory does not contain a music folder,</span>
<span class="c1">-- failure will be silent, and missing tracks will be replaced</span>
<span class="c1">-- with default tracks known to be available</span>
<span class="c1">-- Failure will also be silent if a file called missingmusic.txt</span>
<span class="c1">-- is in the music directory</span>
<span class="c1">-- Otherwise, an error will be thrown detailing the missing tracks.</span>

</code></pre></div></div>

<p>Note that although the game ships with 13 tracks, you can have more or fewer
tracks if you prefer.  You should update <code class="language-plaintext highlighter-rouge">@PICKMUSICTOT</code> appropriately,
by adding or removing lines as necessary.</p>

<p>Also, note that tracks 0 and 1 will be played when
civilizations are destroyed and cities celebrate We Love The King Day,
respectively.  Choose appropriate tracks, or leave them with their default
names, and let them be found in the player’s main music directory.</p>
<h4 id="implementation-34">
  
  
    <a href="#implementation-34">&#128279</a> Implementation
  
  
</h4>
    

<p>This execution point is implemented using the TOTPP function <code class="language-plaintext highlighter-rouge">civ.scen.onSelectMusic</code>.  Note, however, that unlike other execution points, this
function is not called in <code class="language-plaintext highlighter-rouge">events.lua</code>.  Instead, it is called within <code class="language-plaintext highlighter-rouge">LuaParameterFiles\customMusicIntegration.lua</code>.</p>
<h3 id="combat-resolution">
  
  
    <a href="#combat-resolution">&#128279</a> <strong>Combat Resolution</strong>
  
  
</h3>
    

<p>The Combat Resolution execution point has been superseded by the Combat Declared execution point, and is not in the current version of the Lua Scenario Template.</p>

<p>The registered function is called before every round of combat.  If it returns
true, the combat continues for another round.  If false, the combat ends, and
one of the combatants is destroyed.  (If one has 0 hp, it will be that one.)</p>
<h4 id="usage-34">
  
  
    <a href="#usage-34">&#128279</a> Usage
  
  
</h4>
    
<h5 id="deprecated">
  
  
    <a href="#deprecated">&#128279</a> <strong>Deprecated</strong>
  
  
</h5>
    

<p>This execution point is deprecated, so the Lua Scenario Template has no section dedicated to it.  If you wish to use it, define a function to be
registered, similar to the following:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="k">function</span> <span class="nf">resolutionFunction</span><span class="p">(</span><span class="n">defaultResolutionFunction</span><span class="p">,</span><span class="n">defender</span><span class="p">,</span><span class="n">attacker</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">defaultResolutionFunction</span><span class="p">(</span><span class="n">defender</span><span class="p">,</span><span class="n">attacker</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>
<p>Then, register it as follows:</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">civ</span><span class="p">.</span><span class="n">scen</span><span class="p">.</span><span class="n">onResolveCombat</span><span class="p">(</span><span class="n">resolutionFunction</span><span class="p">)</span>
</code></pre></div></div>
<p>The <code class="language-plaintext highlighter-rouge">defaultResolutionFunction</code> is a function which takes two parameters, the defender and the attacker, and returns true if the combat should continue, and false if it should end.  This function is how the game would normally
determine if combat should continue.  You should change the returned value
when you wish to do something different.</p>

<p>The <code class="language-plaintext highlighter-rouge">defender</code> and <code class="language-plaintext highlighter-rouge">attacker</code> parameters are the units which are engaged
in combat.</p>
<h4 id="implementation-35">
  
  
    <a href="#implementation-35">&#128279</a> Implementation
  
  
</h4>
    

<p>This execution point can be implemented with the TOTPP function <code class="language-plaintext highlighter-rouge">civ.scen.onResolveCombat</code>.</p>
<h3 id="choose-tile-defender">
  
  
    <a href="#choose-tile-defender">&#128279</a> <strong>Choose Tile Defender</strong>
  
  
</h3>
    
<p>The code registered tot he Choose Tile Defender execution point is called when the game checks what unit will defend a tile.  This happens both when a tile is actually attacked, and when the AI is determining its goals.  A unit must be returned by the registered function, and that unit will defend the tile if combat actually takes place.  The defending unit can be chosen from a different tile.</p>
<h4 id="usage-35">
  
  
    <a href="#usage-35">&#128279</a> Usage
  
  
</h4>
    
<h5 id="mechanicsfilescombatsettingslua-1">
  
  
    <a href="#mechanicsfilescombatsettingslua-1">&#128279</a> <strong>MechanicsFiles\combatSettings.lua</strong>
  
  
</h5>
    

<p>You can change the behaviour of the Choose Tile Defender execution point by modifying the function <code class="language-plaintext highlighter-rouge">register.onChooseDefender</code> in the file <code class="language-plaintext highlighter-rouge">MechanicsFiles\combatSettings.lua</code>.  The default implementation is as follows:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="nc">register</span><span class="p">.</span><span class="nf">onChooseDefender</span><span class="p">(</span><span class="n">defaultFunction</span><span class="p">,</span><span class="n">tile</span><span class="p">,</span><span class="n">attacker</span><span class="p">,</span><span class="n">isCombat</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">bestDefenderValue</span> <span class="o">=</span> <span class="o">-</span><span class="nb">math.huge</span>
    <span class="kd">local</span> <span class="n">bestDefender</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="k">for</span> <span class="n">possibleDefender</span> <span class="k">in</span> <span class="n">tile</span><span class="p">.</span><span class="n">units</span> <span class="k">do</span>
        <span class="kd">local</span> <span class="n">attackerStrength</span><span class="p">,</span> <span class="n">attackerFirepower</span><span class="p">,</span> <span class="n">defenderStrength</span><span class="p">,</span> <span class="n">defenderFirepower</span>
            <span class="o">=</span> <span class="n">computeCombatStatistics</span><span class="p">(</span><span class="n">attacker</span><span class="p">,</span><span class="n">possibleDefender</span><span class="p">,</span><span class="kc">false</span><span class="p">)</span>
        <span class="c1">-- below is what appears to be the standard civ II calculation</span>
        <span class="c1">--local defenderValue = defenderStrength*possibleDefender.hitpoints//possibleDefender.type.hitpoints</span>
        <span class="c1">-- instead of defender strength, however, defenderStrength/attackerStrength is used to account</span>
        <span class="c1">-- for attack buffs/debuffs (which are very few in original game)</span>
        <span class="kd">local</span> <span class="n">defenderValue</span> <span class="o">=</span> <span class="kc">nil</span>
        <span class="k">if</span> <span class="n">attackerStrength</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">then</span>
            <span class="n">defenderValue</span> <span class="o">=</span> <span class="mf">1e7</span> <span class="c1">-- 10 million</span>
        <span class="k">else</span>
            <span class="n">defenderValue</span> <span class="o">=</span> <span class="p">(</span><span class="n">defenderStrength</span><span class="o">/</span><span class="n">attackerStrength</span><span class="p">)</span><span class="o">*</span><span class="n">possibleDefender</span><span class="p">.</span><span class="n">hitpoints</span><span class="o">/</span><span class="n">possibleDefender</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">hitpoints</span>
        <span class="k">end</span>
        <span class="n">defenderValue</span> <span class="o">=</span> <span class="n">defenderValue</span> <span class="o">+</span> <span class="n">defenderValueModifier</span><span class="p">(</span><span class="n">possibleDefender</span><span class="p">,</span><span class="n">tile</span><span class="p">,</span><span class="n">attacker</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">defenderValue</span> <span class="o">&gt;</span> <span class="n">bestDefenderValue</span> <span class="ow">or</span> 
            <span class="p">(</span><span class="n">defenderValue</span> <span class="o">==</span> <span class="n">bestDefenderValue</span> <span class="ow">and</span> <span class="n">possibleDefender</span><span class="p">.</span><span class="n">id</span> <span class="o">&lt;</span> <span class="n">bestDefender</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="k">then</span>
            <span class="n">bestDefenderValue</span> <span class="o">=</span> <span class="n">defenderValue</span>
            <span class="n">bestDefender</span> <span class="o">=</span> <span class="n">possibleDefender</span>
        <span class="k">end</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="n">bestDefender</span>
    <span class="c1">--return defaultFunction(tile,attacker)</span>
<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">tile</code> parameter is the tile which is being attacked.</p>

<p>The <code class="language-plaintext highlighter-rouge">attacker</code> parameter is the unit which is attacking the tile.</p>

<p>The <code class="language-plaintext highlighter-rouge">isCombat</code> parameter is <code class="language-plaintext highlighter-rouge">true</code> if combat will actually take place, and <code class="language-plaintext highlighter-rouge">false</code> if the function is called for AI planning purposes.</p>

<p>The <code class="language-plaintext highlighter-rouge">defaultFunction</code> is the game’s standard function for determining what unit will defend the tile.  To use it, return the result of <code class="language-plaintext highlighter-rouge">defaultFunction(tile,attacker)</code>.</p>

<p>The standard Civ II method for choosing the defender is to choose the unit with the highest “defenderValue”, computed in the following way:</p>

<include src="/_LfE451$e7wdpDqciN6zB@A.xml"></include>

<p>With the division rounded down to the nearest integer.  Although unitDefense takes into account bonuses like the veteran status and the pikeman bonus, this computation does not take unit hitpoints or firepower into account.  For example, a damaged Armor unit (with more than 20 HP remaining) could defend after an Alpine Troops unit, even though it would be a better defender.</p>

<p>The default implementation of <code class="language-plaintext highlighter-rouge">register.onChooseDefender</code> keeps this basic choice system, but does not use the <code class="language-plaintext highlighter-rouge">defaultFunction</code> so that it can take into account combat customisations made in <code class="language-plaintext highlighter-rouge">computeCombatStatistics</code>.  The most notable change is that instead of relying on only the defense value of the candidate unit, the ratio of 
<include src="/_9XYP0yDg8@OBvJCqsFWou7.xml"></include> 
is used instead (without integer division).  This is because the base Civilization II game rarely modifies the attack value of a unit (I think the only case of this is a Partisan attacking a 0 attack unit), while this is an obvious thing to do with Lua.</p>

<p>If the attacker has 0 attack value when facing a certain unit, that unit’s defense value is set to ten million, so that it will be chosen as the defender by default.  (This can be changed in the next step.)</p>

<p>After assigning a value to the candidate defensive unit, that value is altered by adding the result of the following function:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- use this function to add to (or subtract from) the calculated</span>
<span class="c1">-- defender value in order to change onChooseDefender</span>
<span class="c1">-- e.g. if you add 1e8 (100 million) to all air in air protected stacks</span>
<span class="c1">-- when attacked by a fighter, air units will always defend first if they</span>
<span class="c1">-- are available.</span>
<span class="c1">-- If the combat calculator gives an attacker an attack value of 0,</span>
<span class="c1">-- this is converted to a defenderValue of 1e7 (10 million)</span>
<span class="c1">-- If you want this to defend (and cancel the attack) instead of the air unit</span>
<span class="c1">-- (presuming it isn't an air unit itself), you could add 1e6 (1 million) instead</span>
<span class="c1">-- calculated defenderValues are defenderStrength/attackerStrength*healthPercentage.</span>
<span class="c1">-- This should be less than 10,000 (127*8 = 1016), unless you have defense multipliers </span>
<span class="c1">-- of 10 or more, and an attacker with 1 attack and facing a 1/8 penalty.</span>
<span class="kd">local</span> <span class="k">function</span> <span class="nf">defenderValueModifier</span><span class="p">(</span><span class="n">defender</span><span class="p">,</span><span class="n">tile</span><span class="p">,</span><span class="n">attacker</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">simpleSettings</span><span class="p">.</span><span class="n">fightersAttackAirFirst</span> <span class="ow">and</span>
        <span class="n">gen</span><span class="p">.</span><span class="n">isAttackAir</span><span class="p">(</span><span class="n">attacker</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="ow">and</span> <span class="n">defender</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">domain</span> <span class="o">==</span> <span class="n">domain</span><span class="p">.</span><span class="n">air</span> 
        <span class="ow">and</span> <span class="n">defender</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">range</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span>
        <span class="ow">not</span> <span class="n">gen</span><span class="p">.</span><span class="n">hasAirbase</span><span class="p">(</span><span class="n">tile</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tile</span><span class="p">.</span><span class="n">city</span> <span class="ow">and</span>
        <span class="ow">not</span> <span class="n">tileHasCarrierUnit</span><span class="p">(</span><span class="n">tile</span><span class="p">)</span> <span class="k">then</span>
        <span class="k">return</span> <span class="mf">1e8</span>
    <span class="k">end</span>
    <span class="k">if</span> <span class="n">defender</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">domain</span> <span class="o">==</span> <span class="n">domain</span><span class="p">.</span><span class="n">ground</span> <span class="ow">and</span> <span class="n">tile</span><span class="p">.</span><span class="n">baseTerrain</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="mi">10</span> <span class="k">then</span>
        <span class="k">return</span> <span class="o">-</span><span class="mf">1e8</span>
    <span class="k">end</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">landAirCargo</span><span class="p">.</span><span class="n">canDefend</span><span class="p">(</span><span class="n">defender</span><span class="p">)</span> <span class="k">then</span>
        <span class="k">return</span> <span class="o">-</span><span class="mf">1e8</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="mi">0</span>
<span class="k">end</span>

</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">defenderValueModifier</code> function is meant to force certain units to defend with either higher or lower priority, even if some other unit would be a better defender.  For example, if <code class="language-plaintext highlighter-rouge">MechanicsFiles\simpleSettings.lua</code> has been changed to make fighters attack air first, then <code class="language-plaintext highlighter-rouge">defenderValueModifier</code> adds 100 million (<code class="language-plaintext highlighter-rouge">1e8</code>) to the value of all air
units when a fighter unit attacks.  This ensures that air units will always be chosen as defenders when a fighter attacks, even if they are not the best defenders.  Similarly, ground units on ocean tiles subtract 100 million, so they’ll never defend if a ship can defend them.</p>

<p>With a finalized defender value, <code class="language-plaintext highlighter-rouge">register.onChooseDefender</code> determines if the candidate defender is the best found so far, and, if so, updates the <code class="language-plaintext highlighter-rouge">bestDefender</code> variable.  After checking all units, <code class="language-plaintext highlighter-rouge">bestDefender</code> is returned.</p>
<h4 id="implementation-36">
  
  
    <a href="#implementation-36">&#128279</a> Implementation
  
  
</h4>
    

<p>The Choose Tile Defender execution point is implemented using the TOTPP function <code class="language-plaintext highlighter-rouge">civ.scen.onChooseDefender</code>.</p>
<h3 id="check-if-city-can-build-item">
  
  
    <a href="#check-if-city-can-build-item">&#128279</a> <strong>Check If City Can Build Item</strong>
  
  
</h3>
    

<p>The code for this execution point is executed whenever a city needs to determine if it can build an item.  If the called function returns <code class="language-plaintext highlighter-rouge">true</code>, then the item can be built by the city; if <code class="language-plaintext highlighter-rouge">false</code> it can’t.  This usually (possibly always, but I don’t know for sure) means that this execution point is run in batches of 256, for all the possible units, improvements, and wonders, that a city could build.</p>
<h4 id="usage-36">
  
  
    <a href="#usage-36">&#128279</a> Usage
  
  
</h4>
    
<h5 id="mechanicsfilescanbuildsettingslua">
  
  
    <a href="#mechanicsfilescanbuildsettingslua">&#128279</a> <strong>MechanicsFiles\canBuildSettings.lua</strong>
  
  
</h5>
    

<p>The Lua Scenario Template allows you to register tables in the file <code class="language-plaintext highlighter-rouge">MechanicsFiles\canBuildSettings.lua</code> which will be translated by the <code class="language-plaintext highlighter-rouge">canBuild</code> module into a suitable function to be registered with the <code class="language-plaintext highlighter-rouge">civ.scen.onCanBuild</code> function.  The Template does not provide a way to directly provide a function for this execution point.  However, the <code class="language-plaintext highlighter-rouge">conditionFunction</code> key allows you to register arbitrary code for whether a city can build a certain item, so you can make arbitrary conditions.</p>

<p>If you are not using the Template, this is the outline for registering the function:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="k">function</span> <span class="nf">canCityBuild</span><span class="p">(</span><span class="n">defaultBuildFunction</span><span class="p">,</span><span class="n">city</span><span class="p">,</span><span class="n">item</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">defaultBuildFunction</span><span class="p">(</span><span class="n">city</span><span class="p">,</span><span class="n">item</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">city</code> parameter is the city that is checking if the <code class="language-plaintext highlighter-rouge">item</code> can be built.</p>

<p>The <code class="language-plaintext highlighter-rouge">item</code> parameter is the unitTypeObject, improvementObject, or wonderObject that the city is checking if it can build.</p>

<p>The <code class="language-plaintext highlighter-rouge">defaultBuildFunction</code> is the game’s standard function for determining if a city can build an item.  The call <code class="language-plaintext highlighter-rouge">defaultBuildFunction(city,item)</code> returns true if the <code class="language-plaintext highlighter-rouge">city</code> can build the <code class="language-plaintext highlighter-rouge">item</code> under regular Civ II rules (prerequisite technology required, unitType not expired, improvement not already built, etc.).</p>

<p>You don’t have to use the result of the <code class="language-plaintext highlighter-rouge">defaultBuildFunction</code> if you don’t want to.  You can allow a city to build the <code class="language-plaintext highlighter-rouge">item</code> by returning <code class="language-plaintext highlighter-rouge">true</code> even if the <code class="language-plaintext highlighter-rouge">defaultBuildFunction</code> would return <code class="language-plaintext highlighter-rouge">false</code>.</p>

<p>Once you’ve written your <code class="language-plaintext highlighter-rouge">canCityBuild</code> function, you would register it using the function call</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">civ</span><span class="p">.</span><span class="n">scen</span><span class="p">.</span><span class="n">onCanBuild</span><span class="p">(</span><span class="n">canCityBuild</span><span class="p">)</span>
</code></pre></div></div>
<h4 id="implementation-37">
  
  
    <a href="#implementation-37">&#128279</a> Implementation
  
  
</h4>
    

<p>This execution point is implemented with the TOTPP function <code class="language-plaintext highlighter-rouge">civ.scen.onCanBuild</code>.</p>
 -->
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
<!--        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
-->
<!--
-->
      </div>
      <div class="footer-col">
        <p>Reference materials and lessons for using Lua to program events for Civilization II: Test of Time</p>
      </div>
    </div>

    <div class="social-links">
<ul class="social-media-list">
  <li><a rel="me" href="https://github.com/ProfGarfield" target="_blank" title="ProfGarfield"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg>ProfGarfield</a></li>
  <li><a rel="me" href="https://www.youtube.com/user/ProfCiv2" target="_blank" title="YouTube"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#youtube"></use></svg>ProfCiv2</a></li>
  <li><a rel="me" href="https://forums.civfanatics.com/members/prof-garfield.43783/" target="_blank" title="Civfanatics Profile"><img src="/assets/civfanatics_icon.png" class="svg-icon grey"></img>Prof. Garfield</a></li>
</ul>
</div>

  </div>

</footer>
</body>

</html>
